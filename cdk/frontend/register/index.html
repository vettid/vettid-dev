<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register â€¢ VettID</title>
  <link rel="icon" type="image/jpeg" href="/assets/favicon.ico" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    .wrap{min-height:100svh;display:grid;place-items:center;padding:28px;background:linear-gradient(135deg,#000 0%,#0a0a0a 100%)}
    .card{border:2px solid var(--border);padding:32px;max-width:560px;width:100%;box-shadow:0 8px 24px rgba(0,0,0,0.5)}
    h1{margin-top:0;letter-spacing:1.5px;border-bottom:2px solid var(--accent);padding-bottom:12px}
    p{color:var(--gray)}
    label{display:block;margin:1rem 0 .4rem;color:var(--accent);text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;font-weight:600}
    input{width:100%;padding:.85rem;border-radius:2px;border:1px solid var(--border);background:#050505;color:var(--text);font-size:1rem;box-sizing:border-box;transition:border 0.2s}
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,193,37,0.1)}
    button{margin-top:1.5rem;width:100%;padding:1rem;background:linear-gradient(135deg,#ffd940 0%,#ffc125 100%);color:#000;border:none;border-radius:4px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 4px 14px rgba(255,217,64,0.5);transition:all 0.2s;font-size:0.95rem}
    button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,217,64,0.6)}
    .msg{margin-top:1.5rem;padding:12px;border-radius:2px;border-left:3px solid var(--accent);background:#050505}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Request Access</h1>
      <p>Have an invite code? Enter your details.</p>
      <form id="regForm">
        <label for="first">First name</label>
        <input id="first" autocomplete="given-name" required />
        <label for="last">Last name</label>
        <input id="last" autocomplete="family-name" required />
        <label for="email">Email</label>
        <input id="email" type="email" autocomplete="email" required />
        <label for="code">Invite code</label>
        <input id="code" autocomplete="off" required />
        <div style="margin-top:1.5rem;">
          <label style="display:flex;align-items:center;cursor:pointer;margin:0;">
            <input type="checkbox" id="emailConsent" style="width:auto;margin-right:8px;" required />
            <span style="color:var(--text);text-transform:none;font-weight:400;font-size:0.9rem;">I agree to receive emails from VettID</span>
          </label>
        </div>
        <button type="submit">Submit</button>
      </form>
      <div class="msg" id="msg"></div>
      <div style="text-align:center;margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
        <p style="color:var(--gray);margin-bottom:12px;font-size:0.9rem;">Don't have an invite code?</p>
        <button type="button" class="btn" onclick="openWaitlistModal()" style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);width:100%;">Join the Wait List</button>
      </div>
    </div>
  </div>

<!-- Waitlist Modal -->
<div id="waitlistModal" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;">
  <div class="modal-content" style="background:#0a0a0a;border:2px solid var(--accent);border-radius:4px;padding:32px;max-width:500px;width:90%;box-shadow:0 8px 24px rgba(0,0,0,0.5);">
    <span class="close-btn" onclick="closeWaitlistModal()" style="color:var(--gray);float:right;font-size:28px;font-weight:bold;cursor:pointer;line-height:20px;">&times;</span>
    <h2 style="margin-top:0;color:var(--accent);border-bottom:2px solid var(--accent);padding-bottom:12px;">Join the Wait List</h2>
    <p style="color:var(--gray);margin-bottom:1.5rem;">Be the first to know when new invites are available.</p>
    <form id="waitlistForm">
      <label style="display:block;margin:1rem 0 .4rem;color:var(--accent);text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;font-weight:600;">First Name</label>
      <input id="waitlistFirst" type="text" required style="width:100%;padding:.85rem;border-radius:2px;border:1px solid var(--border);background:#050505;color:var(--text);font-size:1rem;box-sizing:border-box;" />

      <label style="display:block;margin:1rem 0 .4rem;color:var(--accent);text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;font-weight:600;">Last Name</label>
      <input id="waitlistLast" type="text" required style="width:100%;padding:.85rem;border-radius:2px;border:1px solid var(--border);background:#050505;color:var(--text);font-size:1rem;box-sizing:border-box;" />

      <label style="display:block;margin:1rem 0 .4rem;color:var(--accent);text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;font-weight:600;">Email</label>
      <input id="waitlistEmail" type="email" required style="width:100%;padding:.85rem;border-radius:2px;border:1px solid var(--border);background:#050505;color:var(--text);font-size:1rem;box-sizing:border-box;" />

      <label style="display:flex;align-items:center;cursor:pointer;margin:1.5rem 0;">
        <input type="checkbox" id="waitlistEmailConsent" required style="width:auto;margin-right:8px;" />
        <span style="color:var(--text);text-transform:none;font-weight:400;">I agree to be emailed by VettID</span>
      </label>

      <div style="display:flex;gap:12px;margin-top:1.5rem;">
        <button type="button" class="btn" onclick="closeWaitlistModal()" style="flex:1;background:linear-gradient(135deg,#374151 0%,#1f2937 100%);">Cancel</button>
        <button type="submit" class="btn" style="flex:1;">Join Wait List</button>
      </div>
    </form>
    <div id="waitlistMessage" style="margin-top:1rem;padding:12px;border-radius:4px;display:none;"></div>
  </div>
</div>
<script src="https://vettid.dev/shared/config.js"></script>
<script>
// Load configuration from centralized config file
const API = window.VettIDConfig.apiUrl;

const form = document.getElementById('regForm');
const msgEl = document.getElementById('msg');
const firstEl = document.getElementById('first');
const lastEl = document.getElementById('last');
const emailEl = document.getElementById('email');
const codeEl = document.getElementById('code');
const emailConsentEl = document.getElementById('emailConsent');

// Set custom validation message for email consent checkbox
emailConsentEl.addEventListener('invalid', function() {
  this.setCustomValidity('You must agree to accept emails from VettID in order to proceed');
});
emailConsentEl.addEventListener('change', function() {
  this.setCustomValidity('');
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  // Disable submit button to prevent duplicate submissions
  const submitBtn = form.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  submitBtn.style.opacity = '0.7';

  msgEl.textContent = "Submitting...";
  msgEl.classList.remove('error');
  const payload = {
    first_name: firstEl.value.trim(),
    last_name: lastEl.value.trim(),
    email: emailEl.value.trim(),
    invite_code: codeEl.value.trim(),
    email_consent: emailConsentEl.checked
  };
  try {
    const res = await fetch(API + "/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    let bodyText = await res.text();
    let data;
    try {
      data = bodyText ? JSON.parse(bodyText) : {};
    } catch {
      data = { raw: bodyText };
    }

    if (!res.ok) {
      const message = data.message || data.error || bodyText || "Registration failed";
      msgEl.textContent = "Error: " + message + " (HTTP " + res.status + ")";
      msgEl.classList.add('error');
      // Re-enable submit button on error
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit';
      submitBtn.style.opacity = '1';
    } else {
      const message = data.message || "Registration submitted. Please check your email after admin approval.";
      // Clear previous content
      msgEl.textContent = '';
      msgEl.style.background = '#050505';

      // Container for main message
      const mainMessage = document.createElement('div');

      // Safely parse and create links without using innerHTML (XSS prevention)
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const parts = message.split(urlRegex);

      parts.forEach((part, index) => {
        if (index % 2 === 0) {
          // Text part - use textContent for safety
          if (part) mainMessage.appendChild(document.createTextNode(part));
        } else {
          // URL part - create anchor element programmatically
          const link = document.createElement('a');
          link.href = part;
          link.textContent = part;
          link.style.color = 'var(--accent)';
          link.style.textDecoration = 'underline';
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          mainMessage.appendChild(link);
        }
      });

      msgEl.appendChild(mainMessage);

      // Show prominent verification notice if email verification was sent
      if (data.email_verification_sent) {
        const verifyNotice = document.createElement('div');
        verifyNotice.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
        verifyNotice.style.color = '#fff';
        verifyNotice.style.padding = '20px';
        verifyNotice.style.borderRadius = '8px';
        verifyNotice.style.marginTop = '16px';
        verifyNotice.style.fontSize = '1rem';
        verifyNotice.style.border = '2px solid #ffc125';
        verifyNotice.style.boxShadow = '0 4px 12px rgba(255, 193, 37, 0.3)';
        verifyNotice.style.lineHeight = '1.6';
        verifyNotice.innerHTML = `
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span style="font-size:1.5rem;">ðŸ“§</span>
            <strong style="color:#ffc125;font-size:1.1rem;">Email Verification Required</strong>
          </div>
          <p style="margin:0 0 12px 0;">Check your inbox for a verification email from <strong style="color:#ffc125;">Amazon Web Services</strong> and click the link to confirm your email address.</p>
          <p style="margin:0;color:#ccc;font-size:0.9rem;">This step is required to receive future communications from VettID. The email may take a few minutes to arrive.</p>
        `;
        msgEl.appendChild(verifyNotice);
      }

      form.reset();
    }
  } catch (err) {
    msgEl.textContent = "Network or server error: " + (err.message || err);
    msgEl.classList.add('error');
    // Re-enable submit button on error
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit';
    submitBtn.style.opacity = '1';
  }
});

// Waitlist modal functions
function openWaitlistModal() {
  document.getElementById('waitlistModal').style.display = 'flex';
}

function closeWaitlistModal() {
  document.getElementById('waitlistModal').style.display = 'none';
  document.getElementById('waitlistForm').reset();
  document.getElementById('waitlistMessage').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('waitlistModal');
  if (event.target === modal) {
    closeWaitlistModal();
  }
}

// Set custom validation message for waitlist email consent checkbox
const waitlistEmailConsent = document.getElementById('waitlistEmailConsent');
waitlistEmailConsent.addEventListener('invalid', function() {
  this.setCustomValidity('You must agree to accept emails from VettID in order to proceed');
});
waitlistEmailConsent.addEventListener('change', function() {
  this.setCustomValidity('');
});

// Waitlist form submission
document.getElementById('waitlistForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  // Disable submit button to prevent duplicate submissions
  const waitlistForm = document.getElementById('waitlistForm');
  const waitlistSubmitBtn = waitlistForm.querySelector('button[type="submit"]');
  waitlistSubmitBtn.disabled = true;
  waitlistSubmitBtn.textContent = 'Submitting...';
  waitlistSubmitBtn.style.opacity = '0.7';

  const messageEl = document.getElementById('waitlistMessage');
  messageEl.textContent = 'Submitting...';
  messageEl.style.display = 'block';
  messageEl.style.background = '#333';
  messageEl.style.color = 'var(--text)';

  const payload = {
    first_name: document.getElementById('waitlistFirst').value.trim(),
    last_name: document.getElementById('waitlistLast').value.trim(),
    email: document.getElementById('waitlistEmail').value.trim(),
    email_consent: document.getElementById('waitlistEmailConsent').checked
  };

  try {
    const res = await fetch(API + '/waitlist', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      messageEl.textContent = 'Error: ' + (data.message || 'Failed to join waitlist');
      messageEl.style.background = '#d32f2f';
      messageEl.style.color = '#fff';
      // Re-enable submit button on error
      waitlistSubmitBtn.disabled = false;
      waitlistSubmitBtn.textContent = 'Join Wait List';
      waitlistSubmitBtn.style.opacity = '1';
    } else {
      messageEl.innerHTML = '';
      messageEl.style.background = '#4caf50';
      messageEl.style.color = '#fff';

      // Show success message
      const successText = document.createElement('div');
      successText.textContent = 'Successfully joined the wait list!';
      successText.style.fontWeight = '600';
      successText.style.marginBottom = '8px';
      messageEl.appendChild(successText);

      // Show verification notice if email verification was sent
      if (data.email_verification_sent) {
        const verifyNotice = document.createElement('div');
        verifyNotice.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
        verifyNotice.style.color = '#fff';
        verifyNotice.style.padding = '16px';
        verifyNotice.style.borderRadius = '8px';
        verifyNotice.style.marginTop = '12px';
        verifyNotice.style.fontSize = '0.95rem';
        verifyNotice.style.border = '2px solid #ffc125';
        verifyNotice.style.boxShadow = '0 4px 12px rgba(255, 193, 37, 0.3)';
        verifyNotice.style.lineHeight = '1.5';
        verifyNotice.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <span style="font-size:1.3rem;">ðŸ“§</span>
            <strong style="color:#ffc125;">Email Verification Required</strong>
          </div>
          <p style="margin:0;">Check your inbox for a verification email from <strong style="color:#ffc125;">Amazon Web Services</strong> and click the link to confirm your email address.</p>
        `;
        messageEl.appendChild(verifyNotice);
      }

      document.getElementById('waitlistForm').reset();

      // Close modal after longer delay if verification sent (15 seconds to read the message)
      setTimeout(() => {
        closeWaitlistModal();
      }, data.email_verification_sent ? 15000 : 3000);
    }
  } catch (err) {
    messageEl.textContent = 'Network error: ' + err.message;
    messageEl.style.background = '#d32f2f';
    messageEl.style.color = '#fff';
    // Re-enable submit button on error
    waitlistSubmitBtn.disabled = false;
    waitlistSubmitBtn.textContent = 'Join Wait List';
    waitlistSubmitBtn.style.opacity = '1';
  }
});
</script>
</body>
</html>
