<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register â€¢ VettID</title>
  <link rel="icon" type="image/jpeg" href="/assets/favicon.ico" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    .wrap{min-height:100svh;display:grid;place-items:center;padding:28px;background:linear-gradient(135deg,#000 0%,#0a0a0a 100%)}
    .card{border:2px solid var(--border);padding:32px;max-width:560px;width:100%;box-shadow:0 8px 24px rgba(0,0,0,0.5)}
    h1{margin-top:0;letter-spacing:1.5px;border-bottom:2px solid var(--accent);padding-bottom:12px}
    p{color:var(--gray)}
    label{display:block;margin:1rem 0 .4rem;color:var(--accent);text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;font-weight:600}
    input{width:100%;padding:.85rem;border-radius:2px;border:1px solid var(--border);background:#050505;color:var(--text);font-size:1rem;box-sizing:border-box;transition:border 0.2s}
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,193,37,0.1)}
    button{margin-top:1.5rem;width:100%;padding:1rem;background:linear-gradient(135deg,#ffd940 0%,#ffc125 100%);color:#000;border:none;border-radius:4px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 4px 14px rgba(255,217,64,0.5);transition:all 0.2s;font-size:0.95rem}
    button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,217,64,0.6)}
    .msg{margin-top:1.5rem;padding:12px;border-radius:2px;border-left:3px solid var(--accent);background:#050505}

    /* Tab styles */
    .tabs{display:flex;gap:8px;margin-bottom:24px;border-bottom:2px solid var(--border)}
    .tab{flex:1;padding:12px 20px;background:transparent;border:none;color:var(--gray);cursor:pointer;font-size:0.95rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;transition:all 0.2s;border-bottom:3px solid transparent;margin-bottom:-2px}
    .tab:hover{color:var(--text);background:rgba(255,193,37,0.05)}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    @media (max-width: 600px) {
      .tabs{flex-direction:column;gap:0;border-bottom:none}
      .tab{border-bottom:1px solid var(--border);margin-bottom:0;text-align:left}
      .tab.active{border-left:3px solid var(--accent);border-bottom:1px solid var(--border);background:rgba(255,193,37,0.05)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Request Access</h1>

      <!-- Tab Navigation -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('invite')">Have an Invite</button>
        <button class="tab" onclick="switchTab('waitlist')">Join Waitlist</button>
      </div>

      <!-- Invite Tab Content -->
      <div id="inviteTab" class="tab-content active">
        <p>Have an invite code? Enter your details below.</p>
        <form id="regForm">
          <label for="first">First name</label>
          <input id="first" autocomplete="given-name" required />
          <label for="last">Last name</label>
          <input id="last" autocomplete="family-name" required />
          <label for="email">Email</label>
          <input id="email" type="email" autocomplete="email" required />
          <label for="code">Invite code</label>
          <input id="code" autocomplete="off" required />
          <div style="margin-top:1.5rem;">
            <label style="display:flex;align-items:center;cursor:pointer;margin:0;">
              <input type="checkbox" id="emailConsent" style="width:auto;margin-right:8px;" required />
              <span style="color:var(--text);text-transform:none;font-weight:400;font-size:0.9rem;">I agree to receive emails from VettID</span>
            </label>
          </div>
          <button type="submit">Submit</button>
        </form>
        <div class="msg" id="msg"></div>
      </div>

      <!-- Waitlist Tab Content -->
      <div id="waitlistTab" class="tab-content">
        <p>Be the first to know when new invites are available.</p>
        <form id="waitlistForm">
          <label for="waitlistFirst">First Name</label>
          <input id="waitlistFirst" type="text" autocomplete="given-name" required />
          <label for="waitlistLast">Last Name</label>
          <input id="waitlistLast" type="text" autocomplete="family-name" required />
          <label for="waitlistEmail">Email</label>
          <input id="waitlistEmail" type="email" autocomplete="email" required />
          <div style="margin-top:1.5rem;">
            <label style="display:flex;align-items:center;cursor:pointer;margin:0;">
              <input type="checkbox" id="waitlistEmailConsent" style="width:auto;margin-right:8px;" required />
              <span style="color:var(--text);text-transform:none;font-weight:400;font-size:0.9rem;">I agree to receive emails from VettID</span>
            </label>
          </div>
          <button type="submit">Join Wait List</button>
        </form>
        <div class="msg" id="waitlistMessage"></div>
      </div>
    </div>
  </div>
<script src="/shared/config.js"></script>
<script>
// Load configuration from centralized config file
const API = window.VettIDConfig.apiUrl;

// Tab switching function
function switchTab(tabName) {
  // Update tab buttons
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');

  // Update tab content
  document.getElementById('inviteTab').classList.remove('active');
  document.getElementById('waitlistTab').classList.remove('active');

  if (tabName === 'invite') {
    document.getElementById('inviteTab').classList.add('active');
  } else {
    document.getElementById('waitlistTab').classList.add('active');
  }
}

const form = document.getElementById('regForm');
const msgEl = document.getElementById('msg');
const firstEl = document.getElementById('first');
const lastEl = document.getElementById('last');
const emailEl = document.getElementById('email');
const codeEl = document.getElementById('code');
const emailConsentEl = document.getElementById('emailConsent');

// Set custom validation message for email consent checkbox
emailConsentEl.addEventListener('invalid', function() {
  this.setCustomValidity('You must agree to accept emails from VettID in order to proceed');
});
emailConsentEl.addEventListener('change', function() {
  this.setCustomValidity('');
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  // Disable submit button to prevent duplicate submissions
  const submitBtn = form.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  submitBtn.style.opacity = '0.7';

  msgEl.textContent = "Submitting...";
  msgEl.classList.remove('error');
  const payload = {
    first_name: firstEl.value.trim(),
    last_name: lastEl.value.trim(),
    email: emailEl.value.trim(),
    invite_code: codeEl.value.trim(),
    email_consent: emailConsentEl.checked
  };
  try {
    const res = await fetch(API + "/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    let bodyText = await res.text();
    let data;
    try {
      data = bodyText ? JSON.parse(bodyText) : {};
    } catch {
      data = { raw: bodyText };
    }

    if (!res.ok) {
      const message = data.message || data.error || bodyText || "Registration failed";
      msgEl.textContent = "Error: " + message + " (HTTP " + res.status + ")";
      msgEl.classList.add('error');
      // Re-enable submit button on error
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit';
      submitBtn.style.opacity = '1';
    } else {
      const message = data.message || "Registration submitted. Please check your email after admin approval.";
      // Clear previous content
      msgEl.textContent = '';
      msgEl.style.background = '#050505';

      // Container for main message
      const mainMessage = document.createElement('div');

      // Safely parse and create links without using innerHTML (XSS prevention)
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const parts = message.split(urlRegex);

      parts.forEach((part, index) => {
        if (index % 2 === 0) {
          // Text part - use textContent for safety
          if (part) mainMessage.appendChild(document.createTextNode(part));
        } else {
          // URL part - create anchor element programmatically
          const link = document.createElement('a');
          link.href = part;
          link.textContent = part;
          link.style.color = 'var(--accent)';
          link.style.textDecoration = 'underline';
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          mainMessage.appendChild(link);
        }
      });

      msgEl.appendChild(mainMessage);

      // Show prominent verification notice if email verification was sent
      if (data.email_verification_sent) {
        const verifyNotice = document.createElement('div');
        verifyNotice.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
        verifyNotice.style.color = '#fff';
        verifyNotice.style.padding = '20px';
        verifyNotice.style.borderRadius = '8px';
        verifyNotice.style.marginTop = '16px';
        verifyNotice.style.fontSize = '1rem';
        verifyNotice.style.border = '2px solid #ffc125';
        verifyNotice.style.boxShadow = '0 4px 12px rgba(255, 193, 37, 0.3)';
        verifyNotice.style.lineHeight = '1.6';
        verifyNotice.innerHTML = `
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span style="font-size:1.5rem;">ðŸ“§</span>
            <strong style="color:#ffc125;font-size:1.1rem;">Email Verification Required</strong>
          </div>
          <p style="margin:0 0 12px 0;">Check your inbox for a verification email from <strong style="color:#ffc125;">Amazon Web Services</strong> and click the link to confirm your email address.</p>
          <p style="margin:0;color:#ccc;font-size:0.9rem;">This step is required to receive future communications from VettID. The email may take a few minutes to arrive.</p>
        `;
        msgEl.appendChild(verifyNotice);
      }

      form.reset();
      // Re-enable submit button after successful submission
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit';
      submitBtn.style.opacity = '1';
    }
  } catch (err) {
    msgEl.textContent = "Network or server error: " + (err.message || err);
    msgEl.classList.add('error');
    // Re-enable submit button on error
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit';
    submitBtn.style.opacity = '1';
  }
});

// Set custom validation message for waitlist email consent checkbox
const waitlistEmailConsent = document.getElementById('waitlistEmailConsent');
waitlistEmailConsent.addEventListener('invalid', function() {
  this.setCustomValidity('You must agree to accept emails from VettID in order to proceed');
});
waitlistEmailConsent.addEventListener('change', function() {
  this.setCustomValidity('');
});

// Waitlist form submission
document.getElementById('waitlistForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  // Disable submit button to prevent duplicate submissions
  const waitlistForm = document.getElementById('waitlistForm');
  const waitlistSubmitBtn = waitlistForm.querySelector('button[type="submit"]');
  waitlistSubmitBtn.disabled = true;
  waitlistSubmitBtn.textContent = 'Submitting...';
  waitlistSubmitBtn.style.opacity = '0.7';

  const messageEl = document.getElementById('waitlistMessage');
  messageEl.textContent = 'Submitting...';
  messageEl.classList.remove('error');

  const payload = {
    first_name: document.getElementById('waitlistFirst').value.trim(),
    last_name: document.getElementById('waitlistLast').value.trim(),
    email: document.getElementById('waitlistEmail').value.trim(),
    email_consent: document.getElementById('waitlistEmailConsent').checked
  };

  try {
    const res = await fetch(API + '/waitlist', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      messageEl.textContent = 'Error: ' + (data.message || 'Failed to join waitlist');
      messageEl.classList.add('error');
      // Re-enable submit button on error
      waitlistSubmitBtn.disabled = false;
      waitlistSubmitBtn.textContent = 'Join Wait List';
      waitlistSubmitBtn.style.opacity = '1';
    } else {
      // Clear previous content
      messageEl.textContent = '';
      messageEl.style.background = '#050505';

      // Container for main message
      const mainMessage = document.createElement('div');
      mainMessage.textContent = 'Successfully joined the wait list!';
      mainMessage.style.fontWeight = '600';
      mainMessage.style.marginBottom = '8px';
      messageEl.appendChild(mainMessage);

      // Show verification notice if email verification was sent
      if (data.email_verification_sent) {
        const verifyNotice = document.createElement('div');
        verifyNotice.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
        verifyNotice.style.color = '#fff';
        verifyNotice.style.padding = '16px';
        verifyNotice.style.borderRadius = '8px';
        verifyNotice.style.marginTop = '12px';
        verifyNotice.style.fontSize = '0.95rem';
        verifyNotice.style.border = '2px solid #ffc125';
        verifyNotice.style.boxShadow = '0 4px 12px rgba(255, 193, 37, 0.3)';
        verifyNotice.style.lineHeight = '1.5';
        verifyNotice.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <span style="font-size:1.3rem;">ðŸ“§</span>
            <strong style="color:#ffc125;">Email Verification Required</strong>
          </div>
          <p style="margin:0;">Check your inbox for a verification email from <strong style="color:#ffc125;">Amazon Web Services</strong> and click the link to confirm your email address.</p>
        `;
        messageEl.appendChild(verifyNotice);
      }

      document.getElementById('waitlistForm').reset();
    }
  } catch (err) {
    messageEl.textContent = 'Network error: ' + err.message;
    messageEl.classList.add('error');
    // Re-enable submit button on error
    waitlistSubmitBtn.disabled = false;
    waitlistSubmitBtn.textContent = 'Join Wait List';
    waitlistSubmitBtn.style.opacity = '1';
  }
});
</script>
</body>
</html>
