<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://vettid.dev data:; connect-src 'self' https://api.vettid.dev https://__ADMIN_COGNITO_DOMAIN__; font-src 'self' https://vettid.dev;">
  <title>Sign In - VettID Admin</title>
  <link rel="icon" type="image/jpeg" href="https://vettid.dev/assets/favicon.ico" />
  <link rel="stylesheet" href="https://vettid.dev/assets/fonts.css" />
  <style>
    :root {
      --accent: #ffc125;
      --text: #e8e6e3;
      --gray: #a8a29e;
      --bg-card: #12110f;
      --border: #2a2622;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #0a0908 0%, #12110f 50%, #0a0908 100%);
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text);
    }
    .login-container {
      text-align: center;
      padding: 48px;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(255, 193, 37, 0.15);
      max-width: 400px;
      width: 90%;
    }
    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 32px;
    }
    .logo img {
      width: 64px;
      height: 64px;
      border-radius: 8px;
    }
    .logo-text {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 2px;
    }
    h1 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      font-weight: 600;
    }
    .subtitle {
      color: var(--gray);
      margin: 0 0 32px 0;
      font-size: 0.95rem;
    }
    .btn {
      display: inline-block;
      padding: 14px 48px;
      font-size: 1rem;
      font-weight: 600;
      color: #000;
      background: linear-gradient(135deg, #ffc125 0%, #d4a012 100%);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(255, 193, 37, 0.4);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .error {
      margin-top: 16px;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      border-radius: 6px;
      color: #fca5a5;
      font-size: 0.9rem;
      display: none;
    }
    .loading {
      display: none;
      margin-top: 16px;
      color: var(--gray);
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    footer {
      position: fixed;
      bottom: 24px;
      color: var(--gray);
      font-size: 0.85rem;
    }
    footer a {
      color: var(--accent);
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo">
      <img src="https://vettid.dev/assets/logo.jpg" alt="VettID Logo" />
      <span class="logo-text">VETTID</span>
    </div>
    <h1>Admin Portal</h1>
    <p class="subtitle">Sign in to access the admin dashboard</p>
    <button id="signinBtn" class="btn">Sign In</button>
    <div id="loading" class="loading">
      <span class="spinner"></span>
      Signing in...
    </div>
    <div id="error" class="error"></div>
  </div>
  <footer>
    <a href="https://vettid.dev">VettID</a> &middot; Admin Portal
  </footer>

  <script src="/shared/config.js"></script>
  <script>
    (function() {
      'use strict';

      // Config from shared config
      const COGNITO_DOMAIN = window.VettIDConfig?.admin?.cognitoDomain || '';
      const CLIENT_ID = window.VettIDConfig?.admin?.clientId || '';
      const REDIRECT_URI = window.VettIDConfig?.admin?.redirectUri || window.location.origin + '/';

      // DOM elements
      const signinBtn = document.getElementById('signinBtn');
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');

      // Crypto utilities
      function b64url(buf) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(buf)))
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=+$/, '');
      }

      async function sha256(str) {
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest('SHA-256', enc);
        return b64url(buf);
      }

      function rand(n = 64) {
        const a = new Uint8Array(n);
        crypto.getRandomValues(a);
        return b64url(a.buffer).substring(0, n);
      }

      // OAuth URL builder
      function authUrl(codeChallenge, state) {
        const u = new URL(COGNITO_DOMAIN + '/oauth2/authorize');
        u.searchParams.set('client_id', CLIENT_ID);
        u.searchParams.set('response_type', 'code');
        u.searchParams.set('scope', 'openid email');
        u.searchParams.set('redirect_uri', REDIRECT_URI);
        u.searchParams.set('code_challenge_method', 'S256');
        u.searchParams.set('code_challenge', codeChallenge);
        u.searchParams.set('state', state);
        return u.toString();
      }

      // Begin login flow
      function beginLogin() {
        signinBtn.disabled = true;
        signinBtn.style.display = 'none';
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';

        const v = rand(64);
        sessionStorage.setItem('pkce_verifier', v);

        sha256(v).then(ch => {
          const st = rand(24);
          sessionStorage.setItem('oauth_state', st);
          window.location.href = authUrl(ch, st);
        }).catch(err => {
          console.error('Login error:', err);
          errorEl.textContent = 'Failed to initiate login. Please try again.';
          errorEl.style.display = 'block';
          signinBtn.disabled = false;
          signinBtn.style.display = 'inline-block';
          loadingEl.style.display = 'none';
        });
      }

      // Check if already signed in (has tokens)
      function checkExistingSession() {
        try {
          const tokens = JSON.parse(localStorage.getItem('tokens') || 'null');
          if (tokens && tokens.id_token) {
            // Already signed in, redirect to admin portal
            window.location.href = '/';
          }
        } catch (e) {
          // No valid tokens, stay on login page
        }
      }

      // Initialize
      signinBtn.addEventListener('click', beginLogin);
      checkExistingSession();
    })();
  </script>
</body>
</html>
