<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://vettid.dev; style-src 'self' 'unsafe-inline' https://vettid.dev; img-src 'self' https://vettid.dev data:; font-src 'self' https://vettid.dev; connect-src 'self' https://cgccjd4djg.execute-api.us-east-1.amazonaws.com https://vettid-admin-vettidstac.auth.us-east-1.amazoncognito.com; base-uri 'self'; form-action 'self';" />
  <title>VettID â€¢ Admin</title>
  <link rel="icon" type="image/jpeg" href="https://vettid.dev/assets/favicon.ico" />
  <link rel="stylesheet" href="https://vettid.dev/assets/styles.css" />
  <style>
    *{box-sizing:border-box;}
    body{display:flex;flex-direction:column;height:100vh;margin:0;overflow:hidden;}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-bottom:2px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,0.3);flex-shrink:0;}
    .main-container{display:flex;flex:1;overflow:hidden;}
    .sidebar{width:220px;background:linear-gradient(180deg,#0f0f0f 0%,#050505 100%);border-right:2px solid #222;display:flex;flex-direction:column;overflow-y:auto;transition:transform 0.3s ease;}
    .sidebar.collapsed{transform:translateX(-100%);}
    .sidebar-toggle{display:none;position:fixed;top:70px;left:10px;z-index:1000;background:var(--accent);border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.3);color:#000;font-size:1.2rem;font-weight:bold;}
    .wrap{padding:20px 32px;flex:1;overflow-y:auto;max-width:none;width:100%;}
    input,select,textarea{padding:.6rem;border-radius:2px;border:1px solid var(--border);background:#050505;color:var(--text);transition:border 0.2s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
    table{width:100%;border-collapse:collapse;table-layout:auto;}
    th{padding:12px 10px;border-bottom:2px solid var(--accent);text-align:left;color:var(--accent);text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;background:linear-gradient(135deg,#0a0a0a 0%,#050505 100%)}
    td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    tbody tr:hover{background:#0f0f0f}
    .admin-only{display:flex;overflow:hidden;}
    .error{background:#1a0505;border:2px solid #dc2626;color:#fecaca;padding:18px;border-radius:4px;margin-bottom:20px;box-shadow:0 4px 12px rgba(220,38,38,0.2)}
    .tabs{display:flex;flex-direction:column;gap:0;padding:12px 0;}
    .tab{background:none;color:var(--gray);border:none;padding:14px 20px;cursor:pointer;transition:all .2s;border-left:3px solid transparent;text-align:left;font-weight:600;font-size:0.9rem;width:100%;}
    .tab:hover{color:var(--text);background:rgba(255,193,37,0.08)}
    .tab.active{color:var(--accent);border-left-color:var(--accent);background:rgba(255,193,37,0.12)}
    .tab-content{display:none;height:100%;width:100%;}
    .tab-content.active{display:block;width:100%;}
    .user-dropdown{position:relative;display:inline-block;}
    .user-dropdown-btn{cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:6px;transition:background 0.2s;}
    .user-dropdown-btn:hover{background:rgba(255,193,37,0.1);}
    .user-dropdown-menu{display:none;position:absolute;top:100%;right:0;margin-top:8px;background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.4);min-width:200px;z-index:1000;}
    .user-dropdown-menu.active{display:block;}
    .user-dropdown-item{padding:12px 16px;cursor:pointer;transition:background 0.2s;border-bottom:1px solid #222;color:var(--text);font-size:0.9rem;}
    .user-dropdown-item:last-child{border-bottom:none;}
    .user-dropdown-item:hover{background:rgba(255,193,37,0.1);}
    .pagination{display:flex;align-items:center;gap:12px;margin-top:20px;padding:12px;background:#050505;border-radius:2px;border:1px solid var(--border)}
    .pagination select{width:auto;padding:.5rem}
    .pagination button{padding:.5rem 1rem;font-size:.85rem}
    .pagination .info{color:var(--gray)}
    .toast-container{position:fixed;top:80px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:12px;max-width:400px;}
    .toast{padding:16px 20px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.4);display:flex;align-items:center;gap:12px;animation:slideIn 0.3s ease-out;font-weight:500;border-left:4px solid;}
    .toast.success{background:linear-gradient(135deg,#0e5f3d 0%,#064e2f 100%);border-left-color:#10b981;color:#d1fae5;}
    .toast.error{background:linear-gradient(135deg,#7f1d1d 0%,#5f1515 100%);border-left-color:#ef4444;color:#fecaca;}
    .toast.info{background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 100%);border-left-color:#3b82f6;color:#dbeafe;}
    .toast.warning{background:linear-gradient(135deg,#78350f 0%,#92400e 100%);border-left-color:#f59e0b;color:#fef3c7;}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}
    @keyframes slideOut{from{transform:translateX(0);opacity:1;}to{transform:translateX(400px);opacity:0;}}
    .toast.removing{animation:slideOut 0.3s ease-in;}
    .empty-state{text-align:center;padding:60px 20px;color:var(--gray);}
    .empty-state-icon{font-size:4rem;margin-bottom:16px;opacity:0.5;}
    .empty-state-text{font-size:1.1rem;margin-bottom:8px;}
    .empty-state-subtext{font-size:0.9rem;opacity:0.7;}
    .progress-bar{background:#222;border-radius:4px;height:8px;overflow:hidden;position:relative;}
    .progress-bar-fill{height:100%;border-radius:4px;transition:width 0.3s ease;}
    .skeleton{background:linear-gradient(90deg,#0a0a0a 25%,#1a1a1a 50%,#0a0a0a 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;}
    @keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
    .proposal-filter{opacity:0.7;transition:all 0.2s;}
    .proposal-filter.active{opacity:1 !important;box-shadow:0 4px 12px rgba(255,193,37,0.4) !important;transform:scale(1.02);border:2px solid var(--accent) !important;}
    .subscription-type-filter.active{opacity:1 !important;box-shadow:0 4px 12px rgba(255,193,37,0.4) !important;transform:scale(1.02);border:2px solid var(--accent) !important;}
    .filter-active{opacity:1 !important;box-shadow:0 4px 12px rgba(255,193,37,0.4) !important;transform:scale(1.02);border:2px solid var(--accent) !important;}
    .waitlist-filter.active{opacity:1 !important;box-shadow:0 4px 12px rgba(255,193,37,0.4) !important;transform:scale(1.02);border:2px solid var(--accent) !important;}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:none;align-items:center;justify-content:center;}
    .modal-overlay.active{display:flex;}
    .modal{background:#0a0a0a;border:2px solid var(--accent);border-radius:8px;padding:24px;max-width:500px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.6);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:12px;}
    .modal-title{font-size:1.2rem;font-weight:700;color:var(--accent);}
    .modal-close{background:none;border:none;color:var(--gray);font-size:1.5rem;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:color 0.2s;}
    .modal-close:hover{color:var(--text);}
    .modal-body{margin-bottom:20px;}
    .modal-option{padding:12px;margin-bottom:8px;background:#050505;border:1px solid var(--border);border-radius:4px;cursor:pointer;transition:all 0.2s;}
    .modal-option:hover{border-color:var(--accent);background:#0f0f0f;}
    .modal-option-title{font-weight:600;margin-bottom:4px;}
    .modal-option-desc{font-size:0.85rem;color:var(--gray);}
    .bulk-action-bar{display:none;position:sticky;top:0;z-index:100;background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border:2px solid var(--accent);border-radius:4px;padding:12px 16px;margin-bottom:16px;align-items:center;gap:12px;box-shadow:0 4px 12px rgba(255,193,37,0.3);}
    .bulk-action-bar.active{display:flex;}
    .bulk-action-bar .count{color:var(--accent);font-weight:600;margin-right:auto;}
    .bulk-action-bar button{font-size:0.8rem;padding:6px 14px;}
    th.sortable{cursor:pointer;user-select:none;position:relative;}
    th.sortable:hover{background:rgba(255,193,37,0.1);}
    th.sortable:after{content:'â†•';margin-left:6px;opacity:0.3;font-size:0.8rem;}
    th.sortable.asc:after{content:'â†‘';opacity:1;}
    th.sortable.desc:after{content:'â†“';opacity:1;}
    mark{background:#f59e0b;color:#000;padding:2px 4px;border-radius:2px;font-weight:600;}
    .toast button{background:rgba(255,255,255,0.2);border:none;color:inherit;padding:6px 12px;border-radius:4px;cursor:pointer;font-weight:600;margin-left:8px;transition:background 0.2s;}
    .toast button:hover{background:rgba(255,255,255,0.3);}
    .btn:disabled{opacity:0.5;cursor:not-allowed;background:#444 !important;}
    .password-strength{margin-top:8px;height:4px;background:#222;border-radius:2px;overflow:hidden;}
    .password-strength-fill{height:100%;transition:width 0.3s,background 0.3s;}
    .password-strength-text{font-size:0.75rem;margin-top:4px;font-weight:600;}
    .password-match-indicator{font-size:0.8rem;margin-top:6px;font-weight:600;}
    .password-match{color:#10b981;}
    .password-no-match{color:#ef4444;}
    .strength-weak{background:#ef4444;}.strength-fair{background:#f59e0b;}.strength-good{background:#10b981;}.strength-strong{background:#059669;}
    @media(max-width:768px){
      .sidebar{position:fixed;left:0;top:60px;bottom:0;z-index:999;box-shadow:2px 0 8px rgba(0,0,0,0.3);}
      .sidebar-toggle{display:block;}
      .main-container{flex-direction:column;}
      .wrap{padding:16px;}
      .user-dropdown-menu{right:auto;left:0;}
    }
  </style>
</head>
<body>
  <div id="toastContainer" class="toast-container"></div>

  <!-- Password Change Modal -->
  <div id="passwordModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Change Password</div>
        <button class="modal-close" id="closePasswordModal">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-size:0.9rem;color:var(--gray);">Current Password</label>
          <input type="password" id="currentPassword" placeholder="Enter current password" style="width:100%;" autocomplete="current-password" />
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-size:0.9rem;color:var(--gray);">New Password</label>
          <input type="password" id="newPassword" placeholder="Enter new password" style="width:100%;" autocomplete="new-password" />
          <div class="password-strength">
            <div class="password-strength-fill" id="passwordStrengthFill"></div>
          </div>
          <div class="password-strength-text" id="passwordStrengthText"></div>
        </div>
        <div style="margin-bottom:20px;">
          <label style="display:block;margin-bottom:6px;font-size:0.9rem;color:var(--gray);">Confirm New Password</label>
          <input type="password" id="confirmPassword" placeholder="Confirm new password" style="width:100%;" autocomplete="new-password" />
          <div class="password-match-indicator" id="passwordMatchIndicator"></div>
        </div>
        <div style="display:flex;gap:12px;">
          <button class="btn" id="submitPasswordChange" style="flex:1;">Change Password</button>
          <button class="btn" id="cancelPasswordChange" style="flex:1;background:#374151;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <header>
    <h1 style="display:flex;align-items:center;gap:12px;">
      <img src="https://vettid.dev/assets/logo.jpg" alt="VettID Logo" style="height:36px;width:36px;border-radius:6px;" />
      VettID â€¢ Admin
    </h1>
    <div style="display:flex;align-items:center;gap:16px;">
      <div id="userDropdownContainer" class="user-dropdown" style="display:none;">
        <div class="user-dropdown-btn">
          <span id="userEmail" style="color:var(--accent);font-weight:600;"></span>
          <span id="userAdminType"></span>
          <span style="font-size:0.7rem;">â–¼</span>
        </div>
        <div id="userDropdownMenu" class="user-dropdown-menu">
          <div class="user-dropdown-item" id="changePasswordBtn">
            Change Password
          </div>
        </div>
      </div>
      <button id="signin" class="btn">Sign in</button>
      <button id="signout" class="btn" style="display:none">Sign out</button>
    </div>
  </header>

  <button class="sidebar-toggle" id="sidebarToggle">â˜°</button>

  <div class="main-container">
    <div class="admin-only">
      <div class="sidebar" id="sidebar">
        <div class="tabs">
          <button class="tab active" data-tab="waitlist">Waitlist</button>
          <button class="tab" data-tab="users">Users</button>
          <button class="tab" data-tab="subscriptions">Subscribers</button>
          <button class="tab" data-tab="invites">Invites</button>
          <button class="tab" data-tab="vote-management">Vote Management</button>
          <button class="tab" data-tab="site-management">Site Management</button>
          <button class="tab" data-tab="admins">Admin Users</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div id="notAdminError" class="error" style="display:none">
        <strong>Access Denied</strong><br>
        You are not authorized to access this page. Admin privileges are required.
      </div>

      <div class="admin-only">

      <div id="waitlist" class="tab-content card active">
        <h3 style="margin-top:0;">Waitlist Management</h3>

        <!-- Quick Filter Badges -->
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
          <button id="quickFilterPending" class="btn waitlist-filter active" style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);padding:10px 20px;font-weight:600;">
            Pending <span id="pendingWaitlistCount" style="background:#1e40af;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterInvited" class="btn waitlist-filter" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:10px 20px;font-weight:600;">
            Invited <span id="invitedWaitlistCount" style="background:#065f46;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterRejected" class="btn waitlist-filter" style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);padding:10px 20px;font-weight:600;">
            Rejected <span id="rejectedWaitlistCount" style="background:#991b1b;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterAllWaitlist" class="btn waitlist-filter" style="background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);padding:10px 20px;font-weight:600;">
            All <span id="allWaitlistCount" style="background:#374151;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
        </div>

        <!-- Filters and Search -->
        <div style="padding:16px;background:#0a0a0a;border-radius:8px;border:1px solid var(--border);margin-bottom:20px;">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;">
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.85rem;color:var(--gray);">Search</label>
              <input id="waitlistSearch" type="text" placeholder="Name, email..." style="width:100%;" />
            </div>
            <button id="resetWaitlistFilters" class="btn" style="margin-top:20px;background:#374151;">Reset Filters</button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="margin-bottom:16px;display:flex;gap:12px;align-items:center;">
          <button id="refreshWaitlist" class="btn">Refresh</button>
          <button id="sendInvitesBtn" class="btn" style="background:linear-gradient(135deg,#0e9e4d 0%,#0a7a3a 100%);" disabled>Invite</button>
          <button id="rejectWaitlistBtn" class="btn" style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);" disabled>Reject</button>
          <span id="selectedWaitlistCount" style="color:var(--gray);margin-left:auto;"></span>
        </div>

        <!-- Waitlist Table -->
        <table id="waitlistTable">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllWaitlist" /></th>
              <th>Name</th>
              <th>Email</th>
              <th>Status</th>
              <th>Created</th>
              <th>Invited</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination">
          <label>Show: <select id="waitlistPerPage"><option value="10" selected>10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option></select></label>
          <button id="waitlistPrev" class="btn">Previous</button>
          <span class="info" id="waitlistInfo"></span>
          <button id="waitlistNext" class="btn">Next</button>
        </div>
      </div>

      <div id="users" class="tab-content card">
        <h3 style="margin-top:0;">User Management</h3>

        <!-- Quick Filter Badges -->
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
          <button id="quickFilterAction" class="btn filter-active" style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);padding:10px 20px;font-weight:600;position:relative;">
            Pending <span id="actionCount" style="background:#dc2626;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterActive" class="btn" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:10px 20px;font-weight:600;">
            Active <span id="activeCount" style="background:#065f46;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterAll" class="btn" style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);padding:10px 20px;font-weight:600;">
            All Users <span id="allCount" style="background:#1e40af;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
        </div>

        <!-- Advanced Filters -->
        <div style="padding:16px;background:#0a0a0a;border-radius:8px;border:1px solid var(--border);margin-bottom:20px;">
          <h4 style="margin:0 0 12px 0;color:var(--accent);">Filters</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px;">
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.85rem;color:var(--gray);">Registration Status</label>
              <select id="filterRegistration" style="width:100%;">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="disabled">Disabled</option>
                <option value="deleted">Deleted</option>
              </select>
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.85rem;color:var(--gray);">Membership Status</label>
              <select id="filterMembership" style="width:100%;">
                <option value="">All</option>
                <option value="none">No Request</option>
                <option value="pending">Pending</option>
                <option value="approved">Member</option>
                <option value="denied">Denied</option>
              </select>
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.85rem;color:var(--gray);">Subscription Status</label>
              <select id="filterSubscription" style="width:100%;">
                <option value="">All</option>
                <option value="active">Active</option>
                <option value="cancelled">Cancelled</option>
                <option value="expired">Expired</option>
                <option value="none">No Subscription</option>
              </select>
            </div>
          </div>
          <div style="display:flex;gap:12px;align-items:center;">
            <div style="flex:1;">
              <label style="display:block;margin-bottom:4px;font-size:0.85rem;color:var(--gray);">Search</label>
              <input id="usersSearch" type="text" placeholder="Name, email, invite code, user GUID..." style="width:100%;" />
            </div>
            <button id="resetFilters" class="btn" style="margin-top:20px;background:#374151;">Reset Filters</button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="margin-bottom:16px;display:flex;gap:12px;align-items:center;">
          <button id="refreshUsers" class="btn">Refresh</button>
          <button id="bulkApproveReg" class="btn" style="background:linear-gradient(135deg,#0e9e4d 0%,#0a7a3a 100%);" disabled>Approve Registration</button>
          <button id="bulkDisableUsers" class="btn" style="background:linear-gradient(135deg,#ec3024 0%,#c4271e 100%);" disabled>Disable</button>
          <span id="usersBulkCount" style="color:var(--gray);margin-left:auto;"></span>
        </div>

        <!-- Users Table -->
        <table id="usersTable">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllUsers" /></th>
              <th class="sortable" data-column="first_name" data-list="users">Name</th>
              <th class="sortable" data-column="email" data-list="users">Email</th>
              <th class="sortable" data-column="status" data-list="users">Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination">
          <label>Show: <select id="usersPerPage"><option value="10" selected>10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option></select></label>
          <button id="usersPrev" class="btn">Previous</button>
          <span class="info" id="usersInfo"></span>
          <button id="usersNext" class="btn">Next</button>
        </div>
      </div>

      <div id="invites" class="tab-content card">
        <button id="toggleInviteForm" class="btn" style="margin-bottom:16px;">Create Invite</button>
        <h3>All invites</h3>

        <!-- Quick Stats Badges -->
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
          <button id="quickFilterActiveInvites" class="btn filter-active" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:10px 20px;font-weight:600;">
            Active <span id="activeInvitesCount" style="background:#065f46;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterExpiringSoonInvites" class="btn" style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);padding:10px 20px;font-weight:600;">
            Expiring Soon <span id="expiringSoonInvitesCount" style="background:#92400e;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterUsedInvites" class="btn" style="background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);padding:10px 20px;font-weight:600;">
            Used <span id="usedInvitesCount" style="background:#374151;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterAllInvites" class="btn" style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);padding:10px 20px;font-weight:600;">
            All <span id="allInvitesCount" style="background:#1e40af;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
        </div>

        <button id="refreshInvites" class="btn">Refresh</button>
        <label style="margin-left:16px;">Search: <input id="invitesSearch" type="text" placeholder="Invite code..." style="width:200px" /></label>
        <div style="margin-top:16px;">
          <button id="bulkExpireInvites" class="btn" style="background:linear-gradient(135deg,#ec3024 0%,#c4271e 100%);box-shadow:0 4px 14px rgba(236,48,36,0.5);">Expire Selected</button>
          <button id="bulkDeleteInvites" class="btn" style="background:linear-gradient(135deg,#6b3a7d 0%,#552e64 100%);margin-left:8px;box-shadow:0 4px 14px rgba(107,58,125,0.5);">Delete Selected</button>
          <span id="invitesSelectedCount" style="margin-left:16px;opacity:.7;"></span>
        </div>
        <table id="invitesTable">
          <thead><tr><th><input type="checkbox" id="selectAllInvites" /></th><th>Code</th><th>Progress</th><th>Status</th><th>Auto-Approve</th><th>Created At</th><th>Created By</th><th>Expires At</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="pagination">
          <label>Show: <select id="invitesPerPage"><option value="10" selected>10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option></select></label>
          <button id="invitesPrev" class="btn">Previous</button>
          <span class="info" id="invitesInfo"></span>
          <button id="invitesNext" class="btn">Next</button>
        </div>
      </div>

      <div id="admins" class="tab-content card">
        <h3>Admin Users</h3>
        <p class="muted">Manage administrator accounts and permissions.</p>

        <!-- Add Admin User Button -->
        <button id="toggleAdminForm" class="btn" style="margin-bottom:16px;background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);">Add Admin User</button>

        <!-- Add Admin User Form (Hidden by default) -->

        <!-- Quick Filter Badges -->
        <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
          <button id="quickFilterActiveAdmins" class="btn filter-active" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:10px 20px;font-weight:600;">
            Active <span id="activeAdminsCount" style="background:#065f46;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterDisabledAdmins" class="btn" style="background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);padding:10px 20px;font-weight:600;">
            Disabled <span id="disabledAdminsCount" style="background:#374151;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="quickFilterAllAdmins" class="btn" style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);padding:10px 20px;font-weight:600;">
            All
          </button>
        </div>

        <button id="refreshAdmins" class="btn">Refresh</button>
        <label style="margin-left:16px;">Search: <input id="adminsSearch" type="text" placeholder="Name or email..." style="width:250px" /></label>
        <table id="adminsTable">
          <thead><tr><th>Name</th><th>Email</th><th>Admin Type</th><th>Status</th><th>Created At</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="pagination">
          <label>Show: <select id="adminsPerPage"><option value="10" selected>10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option></select></label>
          <button id="adminsPrev" class="btn">Previous</button>
          <span class="info" id="adminsInfo"></span>
          <button id="adminsNext" class="btn">Next</button>
        </div>
      </div>

      <div id="site-management" class="tab-content card">
        <h3>Site Management</h3>
        <p class="muted">Manage site-wide settings and content.</p>

        <!-- Subscription Types Card -->
        <div class="card" style="margin-top:24px;">
          <h3>Subscription Types</h3>
          <p style="color:var(--gray);margin-bottom:16px;">Create and manage subscription types that are displayed to users on the account page.</p>

          <button id="toggleSubscriptionTypeForm" class="btn" style="margin-bottom:16px;background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);">Create New Subscription Type</button>


          <div id="subscriptionTypesListSection" style="padding:16px;background:#0a0a0a;border-radius:4px;border:1px solid var(--border);">
            <h4 style="margin-top:0;">Existing Subscription Types</h4>

            <!-- Filter Buttons -->
            <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
              <button id="filterEnabledTypes" class="btn subscription-type-filter active" data-filter="enabled" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:10px 20px;font-weight:600;">
                Enabled <span id="enabledTypesCount" style="background:#065f46;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
              </button>
              <button id="filterAllTypes" class="btn subscription-type-filter" data-filter="all" style="background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);padding:10px 20px;font-weight:600;">
                All <span id="allTypesCount" style="background:#374151;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
              </button>
            </div>

            <button id="refreshSubscriptionTypes" class="btn" style="margin-bottom:12px;">Refresh</button>
            <div id="subscriptionTypesList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;width:100%;">
              <!-- Loading skeletons will be shown via JavaScript -->
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:24px;">
          <h3>Membership Terms</h3>
          <p style="color:var(--gray);margin-bottom:16px;">Create and manage membership terms of service. The current version is displayed to members and saved as a PDF with the VettID logo.</p>

          <button id="toggleTermsForm" class="btn" style="margin-bottom:16px;background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);">Create New Terms</button>

          <div id="currentTermsSection" style="margin-bottom:24px;padding:16px;background:#0a0a0a;border-radius:4px;border:1px solid var(--border);">
            <h4 style="margin-top:0;">Existing Terms</h4>
            <div id="currentTermsDisplay" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;width:100%;">
              <p class="muted" style="grid-column:1/-1;">Loading terms...</p>
            </div>
          </div>

        </div>
      </div>

      <div id="vote-management" class="tab-content card">
        <h3>Vote Management</h3>
        <p class="muted">Create and manage voting proposals for members.</p>

        <!-- Create New Proposal Button and Form (moved to top) -->
        <button id="toggleProposalForm" class="btn" style="margin-top:16px;background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);">Create New Proposal</button>


        <!-- Quick Filter Badges (now clickable) -->
        <div style="display:flex;gap:12px;margin-top:24px;margin-bottom:20px;flex-wrap:wrap;">
          <button id="filterActiveVotes" class="btn proposal-filter active" data-filter="active" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:10px 20px;font-weight:600;">
            Active <span id="activeVotesCount" style="background:#065f46;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="filterPendingVotes" class="btn proposal-filter" data-filter="upcoming" style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);padding:10px 20px;font-weight:600;">
            Scheduled <span id="pendingVotesCount" style="background:#92400e;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="filterCompletedVotes" class="btn proposal-filter" data-filter="closed" style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);padding:10px 20px;font-weight:600;">
            Closed <span id="completedVotesCount" style="background:#1e40af;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
          <button id="filterAllVotes" class="btn proposal-filter" data-filter="all" style="background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);padding:10px 20px;font-weight:600;">
            All <span id="allVotesCount" style="background:#374151;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
          </button>
        </div>

        <!-- Single Container for All Proposals -->
        <div id="proposalsContainer" style="margin-top:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;">
          <!-- Loading skeletons will be shown via JavaScript -->
        </div>
      </div>

      <div id="subscriptions" class="tab-content card">
        <h3 style="margin-top:0;">Subscriber Management</h3>

        <!-- Quick Filter Badges and Revenue -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
          <!-- Estimated Monthly Revenue -->
          <div style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:#0a0a0a;border-radius:8px;border:1px solid var(--border);">
            <span style="font-size:0.85rem;color:var(--gray);">Est. Monthly Revenue:</span>
            <span id="estimatedMonthlyRevenue" style="font-size:1.1rem;font-weight:700;color:#10b981;">$0.00</span>
          </div>
          <!-- Filter Buttons -->
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <button id="quickFilterAllSubs" class="btn filter-active" style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);padding:10px 20px;font-weight:600;">
              All <span id="allSubsCount" style="background:#1e40af;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
            </button>
            <button id="quickFilterPaidSubs" class="btn" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:10px 20px;font-weight:600;">
              Paid <span id="paidSubsCount" style="background:#065f46;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
            </button>
            <button id="quickFilterFreeSubs" class="btn" style="background:linear-gradient(135deg,#8b5cf6 0%,#6d28d9 100%);padding:10px 20px;font-weight:600;">
              Free <span id="freeSubsCount" style="background:#4c1d95;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
            </button>
          </div>
        </div>

        <!-- Filters and Search -->
        <div style="padding:16px;background:#0a0a0a;border-radius:8px;border:1px solid var(--border);margin-bottom:20px;">
          <h4 style="margin:0 0 12px 0;color:var(--accent);">Filters</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;">
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.85rem;color:var(--gray);">Search</label>
              <input id="subscriptionsSearch" type="text" placeholder="Name, email, plan, GUID..." style="width:100%;" />
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.85rem;color:var(--gray);">Status</label>
              <select id="filterSubStatus" style="width:100%;">
                <option value="">All</option>
                <option value="active">Active</option>
                <option value="expiring">Expiring Soon (&lt; 7 days)</option>
                <option value="cancelled">Cancelled</option>
                <option value="expired">Expired</option>
              </select>
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-size:0.85rem;color:var(--gray);">Plan Type</label>
              <select id="filterSubPlan" style="width:100%;">
                <option value="">All Plans</option>
              </select>
            </div>
            <button id="resetSubFilters" class="btn" style="margin-top:20px;background:#374151;">Reset Filters</button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="margin-bottom:16px;">
          <button id="refreshSubscriptions" class="btn">Refresh</button>
          <button id="bulkExtendSubscriptions" class="btn" style="background:linear-gradient(135deg,#0e9e4d 0%,#0a7a3a 100%);margin-left:8px;">Extend Selected by 7 Days</button>
          <span id="selectedSubscriptionsCount" style="margin-left:16px;color:var(--gray);"></span>
        </div>

        <!-- Subscriptions Table -->
        <table id="subscriptionsTable">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllSubscriptions" /></th>
              <th>Name</th>
              <th>Email</th>
              <th>Plan</th>
              <th>Status</th>
              <th>PIN Enabled</th>
              <th>System Emails</th>
              <th>Expires At</th>
              <th>Days Left</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination">
          <label>Show: <select id="subscriptionsPerPage"><option value="10" selected>10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option></select></label>
          <button id="subscriptionsPrev" class="btn">Previous</button>
          <span class="info" id="subscriptionsInfo"></span>
          <button id="subscriptionsNext" class="btn">Next</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://vettid.dev/shared/config.js"></script>
<script>
// Load configuration from centralized config file
const COGNITO_DOMAIN = window.VettIDConfig.admin.cognitoDomain;
const CLIENT_ID = window.VettIDConfig.admin.clientId;
const REDIRECT_URI = window.VettIDConfig.admin.redirectUri;
const API_URL = window.VettIDConfig.apiUrl;

// Security: HTML escape function to prevent XSS attacks
function escapeHtml(unsafe) {
  if (unsafe === null || unsafe === undefined) return '';
  return String(unsafe)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Security: Session idle timeout (30 minutes)
const IDLE_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds
const IDLE_WARNING_TIME = 28 * 60 * 1000; // 28 minutes - show warning
let idleTimer = null;
let warningTimer = null;

function resetIdleTimer() {
  if (idleTimer) clearTimeout(idleTimer);
  if (warningTimer) clearTimeout(warningTimer);

  // Show warning at 28 minutes
  warningTimer = setTimeout(() => {
    if (signedIn()) {
      showToast('Your session will expire in 2 minutes due to inactivity. Click anywhere to stay signed in.', 'warning', 120000);
    }
  }, IDLE_WARNING_TIME);

  // Sign out at 30 minutes
  idleTimer = setTimeout(() => {
    if (signedIn()) {
      showToast('Session expired due to inactivity', 'warning');
      setTimeout(() => signOut(), 2000);
    }
  }, IDLE_TIMEOUT);
}

// Track user activity
['mousedown', 'keydown', 'scroll', 'touchstart', 'click'].forEach(event => {
  document.addEventListener(event, resetIdleTimer, true);
});

// Toast notification system with optional action button
function showToast(message,type='info',duration=4000,options={}){
  const container=document.getElementById('toastContainer');
  const toast=document.createElement('div');
  toast.className=`toast ${type}`;
  let html=`<span>${escapeHtml(message)}</span>`;
  if(options.action&&options.onAction){
    html+=`<button class="toast-action">${escapeHtml(options.action)}</button>`;
  }
  toast.innerHTML=html;
  container.appendChild(toast);

  if(options.action&&options.onAction){
    toast.querySelector('.toast-action').onclick=async()=>{
      toast.remove();
      try{
        await options.onAction();
        showToast('Action completed','success');
      }catch(e){
        showToast('Action failed: '+(e.message||e),'error');
      }
    };
  }

  if(duration>0){
    setTimeout(()=>{
      toast.classList.add('removing');
      setTimeout(()=>toast.remove(),300);
    },duration);
  }

  return toast;
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Ctrl+F or Cmd+F: Focus search
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    e.preventDefault();
    const activeTab = document.querySelector('.tab.active')?.getAttribute('data-tab');
    const searchInput = document.getElementById(activeTab+'Search');
    if (searchInput) {
      searchInput.focus();
      searchInput.select();
    }
  }
  // Ctrl+R or Cmd+R: Refresh current tab (override browser refresh)
  if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
    e.preventDefault();
    const activeTab = document.querySelector('.tab.active')?.getAttribute('data-tab');
    if (activeTab === 'waitlist') loadWaitlist(true);
    else if (activeTab === 'users') loadUsers(true);
    else if (activeTab === 'invites') loadInvites(true);
    else if (activeTab === 'admins') loadAdmins(true);
    else if (activeTab === 'subscriptions') loadAllSubscriptions(true);
    showToast('Refreshed', 'info', 2000);
  }
  // Esc: Clear filters and search
  if (e.key === 'Escape') {
    const activeTab = document.querySelector('.tab.active')?.getAttribute('data-tab');
    if (activeTab === 'users') {
      userFilters.registration='';userFilters.membership='';userFilters.subscription='';userFilters.quickFilter='action';
      paginationState.users.search='';
      document.getElementById('filterRegistration').value='';
      document.getElementById('filterMembership').value='';
      document.getElementById('filterSubscription').value='';
      document.getElementById('usersSearch').value='';
      document.querySelectorAll('#users .btn').forEach(btn=>{if(btn.id&&btn.id.startsWith('quickFilter'))btn.classList.remove('filter-active');});
      document.getElementById('quickFilterAction').classList.add('filter-active');
      loadUsers(true);
      showToast('Filters cleared', 'info', 2000);
    }
  }
});

// Search highlighting utility
function highlightText(text, searchTerm) {
  if (!searchTerm || searchTerm.length < 2) return escapeHtml(text);
  const escaped = escapeHtml(text);
  const escapedTerm = escapeHtml(searchTerm);
  const regex = new RegExp(`(${escapedTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
  return escaped.replace(regex, '<mark>$1</mark>');
}

// Sorting state
const sortState = {
  users: { column: null, direction: 'asc' },
  invites: { column: null, direction: 'asc' },
  admins: { column: null, direction: 'asc' },
  subscriptions: { column: null, direction: 'asc' }
};

// Sort array by column
function sortData(data, column, direction = 'asc') {
  return [...data].sort((a, b) => {
    let aVal = a[column] ?? '';
    let bVal = b[column] ?? '';

    // Handle different data types
    if (typeof aVal === 'string') aVal = aVal.toLowerCase();
    if (typeof bVal === 'string') bVal = bVal.toLowerCase();

    if (aVal < bVal) return direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return direction === 'asc' ? 1 : -1;
    return 0;
  });
}

// Helper functions for empty states and loading skeletons
function showEmptyState(tableId,text,subtext='',actionHtml=''){
  const tbody=document.querySelector(`#${tableId} tbody`);
  const colSpan=tbody.closest('table').querySelectorAll('thead th').length;
  tbody.innerHTML=`<tr><td colspan="${colSpan}" class="empty-state"><div class="empty-state-icon">ðŸ“­</div><div class="empty-state-text">${text}</div>${subtext?`<div class="empty-state-subtext">${subtext}</div>`:''}${actionHtml}</td></tr>`;
}

function showLoadingSkeleton(tableId){
  const tbody=document.querySelector(`#${tableId} tbody`);
  const colSpan=tbody.closest('table').querySelectorAll('thead th').length;
  tbody.innerHTML=`<tr><td colspan="${colSpan}"><div class="skeleton" style="height:40px;margin:8px 0;border-radius:4px;"></div><div class="skeleton" style="height:40px;margin:8px 0;border-radius:4px;"></div><div class="skeleton" style="height:40px;margin:8px 0;border-radius:4px;"></div></td></tr>`;
}

function showGridLoadingSkeleton(containerId, count = 3) {
  const container = document.getElementById(containerId);
  let skeletonHTML = '';
  for (let i = 0; i < count; i++) {
    skeletonHTML += `
      <div style="padding:20px;background:#0a0a0a;border-radius:8px;border:1px solid var(--border);">
        <div class="skeleton" style="height:24px;margin-bottom:12px;border-radius:4px;width:60%;"></div>
        <div class="skeleton" style="height:16px;margin-bottom:8px;border-radius:4px;width:80%;"></div>
        <div class="skeleton" style="height:16px;margin-bottom:8px;border-radius:4px;width:70%;"></div>
        <div class="skeleton" style="height:36px;margin-top:16px;border-radius:4px;width:100%;"></div>
      </div>
    `;
  }
  container.innerHTML = skeletonHTML;
}

function createProgressBar(percentage,color='#10b981'){
  return `<div class="progress-bar"><div class="progress-bar-fill" style="width:${percentage}%;background:${color};"></div></div>`;
}

// PKCE helpers
function b64url(buf){return btoa(String.fromCharCode.apply(null,new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
async function sha256(str){const enc=new TextEncoder().encode(str);const buf=await crypto.subtle.digest('SHA-256',enc);return b64url(buf);}
function rand(n=64){const a=new Uint8Array(n);crypto.getRandomValues(a);const c='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~';return Array.from(a,b=>c[b%c.length]).join('');}
function authUrl(codeChallenge,state){const u=new URL(COGNITO_DOMAIN+'/oauth2/authorize');u.searchParams.set('client_id',CLIENT_ID);u.searchParams.set('response_type','code');u.searchParams.set('scope','openid email');u.searchParams.set('redirect_uri',REDIRECT_URI);u.searchParams.set('code_challenge_method','S256');u.searchParams.set('code_challenge',codeChallenge);u.searchParams.set('state',state);return u.toString();}
function tokenUrl(){return COGNITO_DOMAIN+'/oauth2/token';}
function logoutUrl(){const u=new URL(COGNITO_DOMAIN+'/logout');u.searchParams.set('client_id',CLIENT_ID);u.searchParams.set('logout_uri',REDIRECT_URI);return u.toString();}
function saveTokens(t){localStorage.setItem('tokens',JSON.stringify(t));}
function loadTokens(){try{return JSON.parse(localStorage.getItem('tokens')||'null')}catch{return null}}
function clearTokens(){localStorage.removeItem('tokens');}
function idToken(){return (loadTokens()||{}).id_token;}
function refreshToken(){return (loadTokens()||{}).refresh_token;}
function signedIn(){return !!idToken();}
function b64urlDecode(str){str=str.replace(/-/g,'+').replace(/_/g,'/');const pad=str.length%4?4-(str.length%4):0;return atob(str+'='.repeat(pad));}
/* SECURITY NOTE: Frontend JWT parsing is for display/UX purposes only.
 * JWT signature validation is performed server-side by API Gateway's Cognito authorizer.
 * Never trust client-side JWT claims for authorization - they can be tampered with.
 * All protected API endpoints validate the JWT signature and claims on the backend. */
function parseJwt(idt){try{const [h,p,s]=idt.split('.');return{header:JSON.parse(b64urlDecode(h)),payload:JSON.parse(b64urlDecode(p)),signature:s};}catch{return{header:{},payload:{},signature:''};}}
function tokenIsExpired(){const idt=idToken();if(!idt)return true;try{const{payload}=parseJwt(idt);const expiryTime=payload.exp*1000;const now=Date.now();return expiryTime<(now+60000);}catch{return true;}}
/* NOTE: isAdmin() check is for UI/UX only. API Gateway enforces authorization server-side. */
function isAdmin(){if(!signedIn())return false;const{payload}=parseJwt(idToken());const groups=payload['cognito:groups']||[];return Array.isArray(groups)&&groups.includes('admin');}
function getAdminType(){if(!signedIn())return null;const{payload}=parseJwt(idToken());return payload['custom:admin_type']||'admin';}
async function exchange(code){const v=sessionStorage.getItem('pkce_verifier');if(!v) throw new Error('Missing verifier');const body=new URLSearchParams();body.set('grant_type','authorization_code');body.set('client_id',CLIENT_ID);body.set('code',code);body.set('redirect_uri',REDIRECT_URI);body.set('code_verifier',v);const res=await fetch(tokenUrl(),{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body.toString()});if(!res.ok) throw new Error(await res.text());const t=await res.json();saveTokens(t);sessionStorage.removeItem('pkce_verifier');return t;}
let refreshPromise=null;
async function refresh(){const r=refreshToken();if(!r) return;const body=new URLSearchParams();body.set('grant_type','refresh_token');body.set('client_id',CLIENT_ID);body.set('refresh_token',r);const res=await fetch(tokenUrl(),{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body.toString()});if(res.ok){const t=await res.json();if(!t.refresh_token) t.refresh_token=r;saveTokens(t);}else{clearTokens();}}
function beginLogin(){const v=rand(64);sessionStorage.setItem('pkce_verifier',v);sha256(v).then(ch=>{const st=rand(24);sessionStorage.setItem('oauth_state',st);location.href=authUrl(ch,st);});}
function handleRedirect(){const p=new URLSearchParams(location.search);const code=p.get('code');const st=p.get('state');if(code&&st&&st===sessionStorage.getItem('oauth_state')){history.replaceState(null,'',location.pathname);exchange(code).then(()=>{renderAuth();if(isAdmin()){const adminType=getAdminType();if(adminType==='user_admin'){loadUsers();}else if(adminType==='subscriber_admin'){loadInvites();}else if(adminType==='vote_admin'){loadAllProposalsAdmin();}else{loadUsers();}}}).catch(err=>{document.querySelector('.wrap').insertAdjacentHTML('afterbegin',"<div class='card'>Login error: "+(err.message||err)+"</div>");});}}
function signOut(){clearTokens();location.href=logoutUrl();}
async function api(path,opts={}){if(tokenIsExpired()){if(!refreshPromise){refreshPromise=refresh().finally(()=>refreshPromise=null);}await refreshPromise;}const res=await fetch(API_URL+path,{...opts,headers:{'Authorization':'Bearer '+idToken(),'Content-Type':'application/json',...(opts.headers||{})}});if(!res.ok) throw new Error(await res.text());return res.json();}
function renderAuth(){
  const signed=signedIn();
  const admin=isAdmin();
  const adminType=getAdminType();

  document.getElementById('signin').style.display=signed?'none':'inline-block';
  document.getElementById('signout').style.display=signed?'inline-block':'none';
  document.querySelectorAll('.admin-only').forEach(el=>el.style.display=admin?'flex':'none');
  document.getElementById('notAdminError').style.display=(signed&&!admin)?'block':'none';

  const emailEl=document.getElementById('userEmail');
  const adminTypeEl=document.getElementById('userAdminType');
  const dropdownContainer=document.getElementById('userDropdownContainer');

  if(signed){
    const{payload}=parseJwt(idToken());
    emailEl.textContent=payload.email||'';
    dropdownContainer.style.display='block';

    // Show admin type badge
    if(admin&&adminType){
      const adminTypeLabels={
        'admin':'Admin - Full Access',
        'user_admin':'User Admin - Waitlist and Users',
        'subscriber_admin':'Subscriber Admin - Waitlist, Users, Subscribers and Invites',
        'vote_admin':'Vote Admin - Vote Management'
      };
      const adminTypeColors={
        'admin':'linear-gradient(135deg,#a855f7 0%,#7c3aed 100%)',
        'user_admin':'linear-gradient(135deg,#3b82f6 0%,#2563eb 100%)',
        'subscriber_admin':'linear-gradient(135deg,#f59e0b 0%,#d97706 100%)',
        'vote_admin':'linear-gradient(135deg,#10b981 0%,#059669 100%)'
      };
      adminTypeEl.innerHTML=`<span style="display:inline-block;background:${adminTypeColors[adminType]};color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">${adminTypeLabels[adminType]}</span>`;
    }else{
      adminTypeEl.innerHTML='';
    }
  }else{
    dropdownContainer.style.display='none';
  }

  // Show/hide tabs based on admin type
  if(admin){
    const tabPermissions={
      'admin':['waitlist','users','subscriptions','invites','vote-management','site-management','admins'],
      'user_admin':['waitlist','users'],
      'subscriber_admin':['subscriptions','invites'],
      'vote_admin':['vote-management']
    };
    // Default to 'admin' if adminType is missing
    const effectiveAdminType=adminType||'admin';
    const allowedTabs=tabPermissions[effectiveAdminType]||tabPermissions['admin'];

    // Hide/show tab buttons
    document.querySelectorAll('.tab').forEach(tab=>{
      const tabName=tab.getAttribute('data-tab');
      if(allowedTabs.includes(tabName)){
        tab.style.display='inline-block';
      }else{
        tab.style.display='none';
      }
    });

    // Activate first allowed tab
    const firstAllowedTab=allowedTabs[0];
    if(firstAllowedTab){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      const targetTab=document.querySelector(`.tab[data-tab="${firstAllowedTab}"]`);
      const targetContent=document.getElementById(firstAllowedTab);
      if(targetTab)targetTab.classList.add('active');
      if(targetContent)targetContent.classList.add('active');
    }
  }
}
document.getElementById('signin').onclick=beginLogin;document.getElementById('signout').onclick=signOut;

// Pagination state
const paginationState={users:{page:0,perPage:10,total:0,search:''},invites:{page:0,perPage:10,total:0,search:''},admins:{page:0,perPage:10,total:0,search:''},subscriptions:{page:0,perPage:10,total:0,search:''}};
// Track which tabs have been loaded
const tabsLoaded={waitlist:false,users:false,invites:false,admins:false,subscriptions:false,'site-management':false,'vote-management':false};
// Debounce utility function
function debounce(func,delay=300){let timeout;return function(...args){clearTimeout(timeout);timeout=setTimeout(()=>func.apply(this,args),delay);}}
// Filter state for Users tab
const userFilters={registration:'',membership:'',subscription:'',quickFilter:'action'};
// Filter state for Subscriptions tab
const subFilters={status:'',plan:'',quickFilter:'all'};

// Unified user data storage
let allUsersData=[];
// Unified subscriptions data storage
let allSubscriptionsData=[];

// Status badge rendering
function renderStatusBadges(user){
  const badges=[];

  // Registration status badge
  if(user.status==='pending'){
    badges.push('<span style="display:inline-block;background:#f59e0b;color:#000;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Pending Reg</span>');
  }else if(user.status==='approved'){
    badges.push('<span style="display:inline-block;background:#10b981;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Approved</span>');
  }else if(user.status==='rejected'){
    badges.push('<span style="display:inline-block;background:#ef4444;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Rejected</span>');
  }else if(user.status==='disabled'){
    badges.push('<span style="display:inline-block;background:#6b7280;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Disabled</span>');
  }else if(user.status==='deleted'){
    badges.push('<span style="display:inline-block;background:#991b1b;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Deleted</span>');
  }

  // Membership status badge
  const membershipStatus=user.membership_status||'none';
  if(membershipStatus==='pending'){
    badges.push('<span style="display:inline-block;background:#8b5cf6;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Member Req</span>');
  }else if(membershipStatus==='approved'){
    badges.push('<span style="display:inline-block;background:#3b82f6;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Member</span>');
  }else if(membershipStatus==='denied'){
    badges.push('<span style="display:inline-block;background:#dc2626;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Member Denied</span>');
  }

  // Subscription status badge
  const subStatus=user.subscription_status||'none';
  if(subStatus==='active'){
    badges.push('<span style="display:inline-block;background:#a855f7;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Active Sub</span>');
  }else if(subStatus==='cancelled'){
    badges.push('<span style="display:inline-block;background:#f97316;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Cancelled Sub</span>');
  }else if(subStatus==='expired'){
    badges.push('<span style="display:inline-block;background:#78716c;color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-right:4px;">Expired Sub</span>');
  }

  return badges.join('');
}

// Comprehensive user data loading
async function loadUsers(resetPage=true){
  if(!isAdmin())return;
  if(resetPage)paginationState.users.page=0;
  const tbody=document.querySelector('#usersTable tbody');
  tbody.innerHTML='<tr><td colspan="4" class="muted">Loading...</td></tr>';

  try{
    // Fetch all user data if needed
    if(resetPage||allUsersData.length===0){
      const [regData,memberData,subData]=await Promise.all([
        api('/admin/registrations'),
        api('/admin/memberships'),
        api('/admin/subscriptions?status=active')
      ]);

      // Create a map of memberships by registration_id
      const memberMap=new Map();
      (memberData.registrations||[]).forEach(m=>{
        memberMap.set(m.registration_id,m);
      });

      // Create a map of subscriptions by user_guid
      const subMap=new Map();
      (subData.subscriptions||[]).forEach(s=>{
        subMap.set(s.user_guid,s);
      });

      // Combine all data
      allUsersData=regData.map(r=>{
        const member=memberMap.get(r.registration_id)||{};
        const sub=subMap.get(r.user_guid)||{};
        return{
          ...r,
          membership_status:member.membership_status||'none',
          membership_requested_at:member.membership_requested_at,
          subscription_status:sub.status||'none',
          subscription_plan:sub.plan||sub.subscription_type_name,
          subscription_expires:sub.expires_at
        };
      });
    }

    // Apply filters
    let filtered=allUsersData.filter(u=>{
      // Search filter
      if(paginationState.users.search){
        const query=paginationState.users.search.toLowerCase();
        const searchMatch=[u.first_name,u.last_name,u.email,u.invite_code,u.user_guid].some(f=>(f||'').toLowerCase().includes(query));
        if(!searchMatch)return false;
      }

      // Registration status filter
      if(userFilters.registration&&u.status!==userFilters.registration)return false;

      // Membership status filter
      if(userFilters.membership){
        const memberStatus=u.membership_status||'none';
        if(memberStatus!==userFilters.membership)return false;
      }

      // Subscription status filter
      if(userFilters.subscription){
        const subStatus=u.subscription_status||'none';
        if(subStatus!==userFilters.subscription)return false;
      }

      // Quick filter
      if(userFilters.quickFilter==='action'){
        const needsAction=u.status==='pending'||u.membership_status==='pending';
        if(!needsAction)return false;
      }else if(userFilters.quickFilter==='active'){
        const isActive=u.status==='approved'&&u.subscription_status==='active';
        if(!isActive)return false;
      }

      return true;
    });

    // Apply sorting
    if(sortState.users.column){
      filtered=sortData(filtered,sortState.users.column,sortState.users.direction);
    }

    // Update counts
    const actionCount=allUsersData.filter(u=>u.status==='pending'||u.membership_status==='pending').length;
    const activeCount=allUsersData.filter(u=>u.status==='approved'&&u.subscription_status==='active').length;
    document.getElementById('actionCount').textContent=actionCount;
    document.getElementById('activeCount').textContent=activeCount;
    document.getElementById('allCount').textContent=allUsersData.length;

    // Pagination
    const page=updatePagination('users',filtered);
    tbody.innerHTML='';

    // Clear checkboxes
    document.getElementById('selectAllUsers').checked=false;

    const searchTerm=paginationState.users.search;

    page.forEach(u=>{
      const tr=document.createElement('tr');
      const name=`${u.first_name||''} ${u.last_name||''}`.trim();
      const badges=renderStatusBadges(u);

      // Apply search highlighting
      const highlightedName=highlightText(name,searchTerm);
      const highlightedEmail=highlightText(u.email,searchTerm);

      tr.innerHTML=`
        <td><input type='checkbox' class='user-checkbox' data-id='${escapeHtml(u.registration_id)}' data-status='${escapeHtml(u.status)}' data-member='${escapeHtml(u.membership_status||'none')}' /></td>
        <td>${highlightedName||'â€”'}</td>
        <td>${highlightedEmail}</td>
        <td>${badges}</td>
      `;
      tbody.appendChild(tr);
    });

    updateUsersSelectedCount();
  }catch(e){
    tbody.innerHTML=`<tr><td colspan="4" class="muted">Error: ${e.message||e}</td></tr>`;
  }
}

// Users tab event handlers
function updateUsersSelectedCount(){
  const checkboxes=document.querySelectorAll('.user-checkbox:checked');
  const count=checkboxes.length;
  const countText=count>0?`${count} selected`:'';
  document.getElementById('usersBulkCount').textContent=countText;

  // Check if any selected users have pending registration status
  const hasPendingReg=Array.from(checkboxes).some(cb=>cb.dataset.status==='pending');

  // Check if any selected users are approved (for disable button)
  const hasApproved=Array.from(checkboxes).some(cb=>cb.dataset.status==='approved');

  // Enable/disable buttons based on selection
  document.getElementById('bulkApproveReg').disabled=count===0||!hasPendingReg;
  document.getElementById('bulkDisableUsers').disabled=count===0||!hasApproved;
}

// Quick filter buttons
document.getElementById('quickFilterAction').onclick=()=>{
  userFilters.quickFilter='action';
  document.querySelectorAll('#users .btn').forEach(btn => {
    if(btn.id && btn.id.startsWith('quickFilter')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterAction').classList.add('filter-active');
  loadUsers(false);
};
document.getElementById('quickFilterActive').onclick=()=>{
  userFilters.quickFilter='active';
  document.querySelectorAll('#users .btn').forEach(btn => {
    if(btn.id && btn.id.startsWith('quickFilter')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterActive').classList.add('filter-active');
  loadUsers(false);
};
document.getElementById('quickFilterAll').onclick=()=>{
  userFilters.quickFilter='all';
  document.querySelectorAll('#users .btn').forEach(btn => {
    if(btn.id && btn.id.startsWith('quickFilter')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterAll').classList.add('filter-active');
  loadUsers(false);
};

// Advanced filters
document.getElementById('filterRegistration').onchange=e=>{userFilters.registration=e.target.value;paginationState.users.page=0;loadUsers(false);};
document.getElementById('filterMembership').onchange=e=>{userFilters.membership=e.target.value;paginationState.users.page=0;loadUsers(false);};
document.getElementById('filterSubscription').onchange=e=>{userFilters.subscription=e.target.value;paginationState.users.page=0;loadUsers(false);};

// Reset filters
document.getElementById('resetFilters').onclick=()=>{
  userFilters.registration='';userFilters.membership='';userFilters.subscription='';userFilters.quickFilter='action';paginationState.users.search='';
  document.getElementById('filterRegistration').value='';document.getElementById('filterMembership').value='';document.getElementById('filterSubscription').value='';document.getElementById('usersSearch').value='';
  document.querySelectorAll('#users .btn').forEach(btn=>{if(btn.id&&btn.id.startsWith('quickFilter'))btn.classList.remove('filter-active');});
  document.getElementById('quickFilterAction').classList.add('filter-active');
  loadUsers(true);
};

// Search with debouncing
const debouncedLoadUsers=debounce(()=>loadUsers(false),300);
document.getElementById('usersSearch').oninput=e=>{paginationState.users.search=e.target.value;paginationState.users.page=0;document.getElementById('selectAllUsers').checked=false;debouncedLoadUsers();};

// Refresh button
document.getElementById('refreshUsers').onclick=()=>loadUsers(true);

// Bulk actions with Promise.allSettled for parallel processing
document.getElementById('bulkApproveReg').onclick=async()=>{
  const checkboxes=document.querySelectorAll('.user-checkbox:checked');
  const items=Array.from(checkboxes).filter(cb=>cb.dataset.status==='pending');
  if(items.length===0){showToast('No pending registrations selected','warning');return;}
  if(!confirm(`Approve ${items.length} registration(s)?`))return;
  const progressToast=showToast(`Processing 0 of ${items.length}...`,'info',0);
  const results=await Promise.allSettled(items.map((cb,i)=>
    api(`/admin/registrations/${cb.dataset.id}/approve`,{method:'POST'}).then(()=>{
      progressToast.querySelector('span').textContent=`Processing ${i+1} of ${items.length}...`;
    })
  ));
  progressToast.remove();
  const succeeded=results.filter(r=>r.status==='fulfilled').length;
  const failed=results.filter(r=>r.status==='rejected').length;
  if(failed>0){
    showToast(`${succeeded} succeeded, ${failed} failed`,'warning');
  }else{
    showToast(`Approved ${succeeded} registration(s) successfully`,'success');
  }
  await loadUsers();
};

document.getElementById('bulkDisableUsers').onclick=async()=>{
  const checkboxes=document.querySelectorAll('.user-checkbox:checked');
  const items=Array.from(checkboxes).filter(cb=>cb.dataset.status==='approved');
  if(items.length===0){showToast('No approved users selected','warning');return;}
  if(!confirm(`Disable ${items.length} user(s)?`))return;
  const progressToast=showToast(`Processing 0 of ${items.length}...`,'info',0);
  const results=await Promise.allSettled(items.map((cb,i)=>
    api(`/admin/users/${cb.dataset.id}/disable`,{method:'POST'}).then(()=>{
      progressToast.querySelector('span').textContent=`Processing ${i+1} of ${items.length}...`;
    })
  ));
  progressToast.remove();
  const succeeded=results.filter(r=>r.status==='fulfilled').length;
  const failed=results.filter(r=>r.status==='rejected').length;
  if(failed>0){
    showToast(`${succeeded} succeeded, ${failed} failed`,'warning');
  }else{
    showToast(`Disabled ${succeeded} user(s) successfully`,'success');
  }
  await loadUsers();
};

// Pagination controls - clear selection on page change
document.getElementById('usersPerPage').onchange=e=>{
  paginationState.users.perPage=Number(e.target.value);
  paginationState.users.page=0;
  document.getElementById('selectAllUsers').checked=false;
  loadUsers(false);
};
document.getElementById('usersPrev').onclick=()=>{
  if(paginationState.users.page>0){
    paginationState.users.page--;
    document.getElementById('selectAllUsers').checked=false;
    loadUsers(false);
  }
};
document.getElementById('usersNext').onclick=()=>{
  if((paginationState.users.page+1)*paginationState.users.perPage<paginationState.users.total){
    paginationState.users.page++;
    document.getElementById('selectAllUsers').checked=false;
    loadUsers(false);
  }
};

document.getElementById('selectAllUsers').onchange=function(){document.querySelectorAll('.user-checkbox').forEach(cb=>cb.checked=this.checked);updateUsersSelectedCount();};
document.addEventListener('change',e=>{
  if(e.target.classList.contains('user-checkbox')){
    updateUsersSelectedCount();
    const total=document.querySelectorAll('.user-checkbox').length;
    const checked=document.querySelectorAll('.user-checkbox:checked').length;
    document.getElementById('selectAllUsers').checked=total>0&&checked===total;
  }
});

function updatePagination(list,items){const state=paginationState[list];const start=state.page*state.perPage;const end=start+state.perPage;const page=items.slice(start,end);state.total=items.length;const infoEl=document.getElementById(list+'Info');const prevBtn=document.getElementById(list+'Prev');const nextBtn=document.getElementById(list+'Next');if(items.length===0){infoEl.textContent='No items';prevBtn.disabled=true;nextBtn.disabled=true;}else{infoEl.textContent=`${start+1}-${Math.min(end,items.length)} of ${items.length}`;prevBtn.disabled=state.page===0;nextBtn.disabled=end>=items.length;}return page;}
function searchFilter(item,query,fields){if(!query)return true;const q=query.toLowerCase();return fields.some(f=>(item[f]||'').toLowerCase().includes(q));}

handleRedirect();renderAuth();
// Mark users tab as loaded and load it on page load (default active tab)
if(signedIn()&&isAdmin()){tabsLoaded.users=true;loadUsers();}
let invitesData=[];
let inviteQuickFilter='active';
async function loadInvites(resetPage=true){
  if(!isAdmin())return;
  if(resetPage)paginationState.invites.page=0;
  const tbody=document.querySelector('#invitesTable tbody');

  // Show loading skeleton
  showLoadingSkeleton('invitesTable');

  try{
    // Fetch all invites (no status filter in API call)
    if(resetPage||invitesData.length===0){
      invitesData=await api('/admin/invites');
    }

    // Update quick filter counts
    updateInviteFilterCounts();

    // Render invites
    renderInvites();
  }catch(e){
    showToast('Failed to load invites: '+(e.message||e),'error');
    tbody.innerHTML=`<tr><td colspan="8" class="muted">${e.message||e}</td></tr>`;
  }
}

function updateInviteFilterCounts(){
  const now=Date.now();
  let activeCt=0,expiringSoonCt=0,usedCt=0;

  invitesData.forEach(i=>{
    const expiresAt=i.expires_at?i.expires_at*1000:null;
    const daysLeft=expiresAt?Math.ceil((expiresAt-now)/(1000*60*60*24)):null;
    const isExpired=expiresAt&&expiresAt<now;
    const isExpiringSoon=daysLeft&&daysLeft<7&&daysLeft>0;

    if(i.status==='exhausted' || i.status==='expired' || isExpired){
      usedCt++;
    }else if(i.status==='active'||i.status==='new'){
      activeCt++;
      if(isExpiringSoon)expiringSoonCt++;
    }
  });

  document.getElementById('activeInvitesCount').textContent=activeCt;
  document.getElementById('expiringSoonInvitesCount').textContent=expiringSoonCt;
  document.getElementById('usedInvitesCount').textContent=usedCt;
  document.getElementById('allInvitesCount').textContent=invitesData.length;
}

// Invites multi-select functionality
function updateInvitesSelectedCount(){
  const checkboxes=document.querySelectorAll('.invites-checkbox:checked');
  const count=checkboxes.length;
  const countEl=document.getElementById('invitesSelectedCount');
  countEl.textContent=count>0?`${count} selected`:'';

  const statuses=Array.from(checkboxes).map(cb=>cb.getAttribute('data-status'));
  const hasActive=statuses.includes('active');

  document.getElementById('bulkExpireInvites').disabled=!hasActive;
  document.getElementById('bulkDeleteInvites').disabled=count===0;
}

function renderInvites(){
  const tbody=document.querySelector('#invitesTable tbody');
  tbody.innerHTML='';
  const now=Date.now();

  // Apply filters
  let filtered=invitesData.filter(i=>{
    // Quick filter
    const expiresAt=i.expires_at?i.expires_at*1000:null;
    const daysLeft=expiresAt?Math.ceil((expiresAt-now)/(1000*60*60*24)):null;
    const isExpired=expiresAt&&expiresAt<now;
    const isExpiringSoon=daysLeft&&daysLeft<7&&daysLeft>0;

    if(inviteQuickFilter==='active'&&i.status!=='active'&&i.status!=='new')return false;
    if(inviteQuickFilter==='expiring'&&!isExpiringSoon)return false;
    if(inviteQuickFilter==='used'&&!(i.status==='exhausted'||i.status==='expired'||isExpired))return false;

    // Search filter
    const search=paginationState.invites.search.toLowerCase();
    if(search&&!i.code.toLowerCase().includes(search))return false;

    return true;
  });

  // Check for empty state
  if(filtered.length===0){
    showEmptyState('invitesTable','No invites found','Try adjusting your filters');
    return;
  }

  // Paginate
  const page=updatePagination('invites',filtered);

  page.forEach(i=>{
    const tr=document.createElement('tr');
    const createdDate=i.created_at?new Date(i.created_at).toLocaleString():'â€”';
    const expiresDate=i.expires_at?new Date(i.expires_at*1000).toLocaleString():'â€”';
    const autoApprove=i.auto_approve?'Yes':'No';

    // Calculate status with expiration check
    const expiresAt=i.expires_at?i.expires_at*1000:null;
    const daysLeft=expiresAt?Math.ceil((expiresAt-now)/(1000*60*60*24)):null;
    const isExpired=expiresAt&&expiresAt<now;
    const isExpiringSoon=daysLeft&&daysLeft<7&&daysLeft>0;

    let statusBadge='';
    let actualStatus=i.status;
    // Check database status first, then fall back to date-based expiration
    if(i.status==='expired'||isExpired){
      statusBadge='<span style="display:inline-block;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Expired</span>';
      actualStatus='expired';
    }else if(i.status==='exhausted'){
      statusBadge='<span style="display:inline-block;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Exhausted</span>';
    }else if(isExpiringSoon){
      statusBadge='<span style="display:inline-block;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:#000;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Expiring Soon</span>';
    }else{
      statusBadge='<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Active</span>';
    }

    // Progress bar for usage
    const used=i.used||0;
    const maxUses=i.max_uses||1;
    const percentage=Math.min(100,(used/maxUses)*100);
    let barColor='#10b981';
    if(percentage>80)barColor='#ef4444';
    else if(percentage>50)barColor='#f59e0b';
    const progressBar=`<div style="display:flex;align-items:center;gap:8px;"><div class="progress-bar" style="width:100px;"><div class="progress-bar-fill" style="width:${percentage}%;background:${barColor};"></div></div><span style="font-size:0.75rem;color:var(--gray);">${used}/${maxUses}</span></div>`;

    tr.innerHTML=`<td><input type='checkbox' class='invites-checkbox' data-code='${escapeHtml(i.code)}' data-status='${escapeHtml(actualStatus)}' /></td><td>${escapeHtml(i.code)}</td><td>${progressBar}</td><td>${statusBadge}</td><td>${autoApprove}</td><td>${escapeHtml(createdDate)}</td><td>${escapeHtml(i.created_by||'â€”')}</td><td>${escapeHtml(expiresDate)}</td>`;
    tbody.appendChild(tr);
  });

  updateInvitesSelectedCount();
}
let adminsData=[];
let adminQuickFilter='active';
async function loadAdmins(resetPage=true){
  if(!isAdmin())return;
  if(resetPage)paginationState.admins.page=0;
  const tbody=document.querySelector('#adminsTable tbody');

  // Show loading skeleton
  showLoadingSkeleton('adminsTable');

  try{
    if(resetPage||adminsData.length===0){
      adminsData=await api('/admin/admins');
    }

    // Update counts
    const activeCt=adminsData.filter(a=>a.enabled).length;
    const disabledCt=adminsData.filter(a=>!a.enabled).length;
    document.getElementById('activeAdminsCount').textContent=activeCt;
    document.getElementById('disabledAdminsCount').textContent=disabledCt;

    // Apply quick filter
    let filtered=adminsData.filter(a=>{
      if(adminQuickFilter==='active'&&!a.enabled)return false;
      if(adminQuickFilter==='disabled'&&a.enabled)return false;
      return searchFilter(a,paginationState.admins.search,['name','email','given_name','family_name']);
    });

    // Check for empty state
    if(filtered.length===0){
      showEmptyState('adminsTable','No admin users yet','Add admin users using the form above');
      return;
    }

    tbody.innerHTML='';
    const page=updatePagination('admins',filtered);

    page.forEach(a=>{
      const tr=document.createElement('tr');
      const name=(a.given_name||'')+(a.family_name?' '+a.family_name:'');
      const createdDate=a.created_at?new Date(a.created_at).toLocaleString():'â€”';

      // Admin type badge
      const adminTypeLabels={
        'admin':'Admin - Full Access',
        'user_admin':'User Admin - Waitlist and Users',
        'subscriber_admin':'Subscriber Admin - Waitlist, Users, Subscribers and Invites',
        'vote_admin':'Vote Admin - Vote Management'
      };
      const adminTypeColors={
        'admin':'linear-gradient(135deg,#a855f7 0%,#7c3aed 100%)',
        'user_admin':'linear-gradient(135deg,#3b82f6 0%,#2563eb 100%)',
        'subscriber_admin':'linear-gradient(135deg,#f59e0b 0%,#d97706 100%)',
        'vote_admin':'linear-gradient(135deg,#10b981 0%,#059669 100%)'
      };
      const adminType=a.admin_type||'admin';
      const adminTypeBadge=`<span style="display:inline-block;background:${adminTypeColors[adminType]};color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">${adminTypeLabels[adminType]}</span>`;

      // Status badge
      const statusBadge=a.enabled
        ?'<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Active</span>'
        :'<span style="display:inline-block;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Disabled</span>';

      // Manage Access button
      const manageBtn = `<button class='btn' style='background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);' data-manage-email='${escapeHtml(a.email)}' data-manage-name='${escapeHtml(name||a.email)}' data-manage-type='${escapeHtml(adminType)}' data-manage-enabled='${escapeHtml(a.enabled)}'>Manage Access</button>`;

      tr.innerHTML=`<td>${escapeHtml(name)||'â€”'}</td><td>${escapeHtml(a.email)}</td><td>${adminTypeBadge}</td><td>${statusBadge}</td><td>${escapeHtml(createdDate)}</td><td>${manageBtn}</td>`;
      tbody.appendChild(tr);
    });

    // Manage Access button handler
    tbody.querySelectorAll("button[data-manage-email]").forEach(btn=>btn.onclick=()=>{
      const email=btn.getAttribute('data-manage-email');
      const name=btn.getAttribute('data-manage-name');
      const type=btn.getAttribute('data-manage-type');
      const enabled=btn.getAttribute('data-manage-enabled')==='true';
      openManageAccessModal(email,name,type,enabled);
    });
  }catch(e){
    showToast('Failed to load admins: '+(e.message||e),'error');
    tbody.innerHTML=`<tr><td colspan="5" class="muted">${e.message||e}</td></tr>`;
  }
}
// Quick filter handlers for invites
document.getElementById('quickFilterActiveInvites').onclick=()=>{
  inviteQuickFilter='active';
  document.querySelectorAll('#invites .btn').forEach(btn => {
    if(btn.id && btn.id.includes('Invites')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterActiveInvites').classList.add('filter-active');
  paginationState.invites.page=0;
  renderInvites();
};
document.getElementById('quickFilterExpiringSoonInvites').onclick=()=>{
  inviteQuickFilter='expiring';
  document.querySelectorAll('#invites .btn').forEach(btn => {
    if(btn.id && btn.id.includes('Invites')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterExpiringSoonInvites').classList.add('filter-active');
  paginationState.invites.page=0;
  renderInvites();
};
document.getElementById('quickFilterUsedInvites').onclick=()=>{
  inviteQuickFilter='used';
  document.querySelectorAll('#invites .btn').forEach(btn => {
    if(btn.id && btn.id.includes('Invites')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterUsedInvites').classList.add('filter-active');
  paginationState.invites.page=0;
  renderInvites();
};
document.getElementById('quickFilterAllInvites').onclick=()=>{
  inviteQuickFilter='all';
  document.querySelectorAll('#invites .btn').forEach(btn => {
    if(btn.id && btn.id.includes('Invites')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterAllInvites').classList.add('filter-active');
  paginationState.invites.page=0;
  renderInvites();
};

// Quick filter handlers for admins
document.getElementById('quickFilterActiveAdmins').onclick=()=>{
  adminQuickFilter='active';
  document.querySelectorAll('#admins .btn').forEach(btn => {
    if(btn.id && btn.id.includes('Admins')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterActiveAdmins').classList.add('filter-active');
  paginationState.admins.page=0;
  loadAdmins(false);
};
document.getElementById('quickFilterDisabledAdmins').onclick=()=>{
  adminQuickFilter='disabled';
  document.querySelectorAll('#admins .btn').forEach(btn => {
    if(btn.id && btn.id.includes('Admins')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterDisabledAdmins').classList.add('filter-active');
  paginationState.admins.page=0;
  loadAdmins(false);
};
document.getElementById('quickFilterAllAdmins').onclick=()=>{
  adminQuickFilter='all';
  document.querySelectorAll('#admins .btn').forEach(btn => {
    if(btn.id && btn.id.includes('Admins')) btn.classList.remove('filter-active');
  });
  document.getElementById('quickFilterAllAdmins').classList.add('filter-active');
  paginationState.admins.page=0;
  loadAdmins(false);
};

document.getElementById('refreshInvites').onclick=loadInvites;
document.getElementById('refreshAdmins').onclick=loadAdmins;
document.getElementById('toggleInviteForm').onclick=()=>document.getElementById('createInviteModal').classList.add('active');
document.getElementById('toggleAdminForm').onclick=()=>document.getElementById('addAdminModal').classList.add('active');

// Modal button handlers - wrapped in DOMContentLoaded since modals are at end of HTML
document.addEventListener('DOMContentLoaded', function() {
document.getElementById('createInviteBtn').onclick=async()=>{
  try{
    const customCode=document.getElementById('customCode').value.trim();
    const n=Number(document.getElementById('maxUses').value||'1');
    const autoApprove=document.getElementById('autoApprove').checked;
    const expiresAtInput=document.getElementById('expiresAt').value;
    const payload={max_uses:n,auto_approve:autoApprove};
    if(customCode)payload.code=customCode;
    if(expiresAtInput){
      const expiresDate=new Date(expiresAtInput);
      payload.expires_at=Math.floor(expiresDate.getTime()/1000);
    }
    const data=await api('/admin/invites',{method:'POST',body:JSON.stringify(payload)});
    let msg='Invite code: '+data.code+' (max uses '+data.max_uses;
    if(data.auto_approve)msg+=' â€¢ Auto-approve enabled';
    if(data.expires_at)msg+=' â€¢ Expires '+new Date(data.expires_at*1000).toLocaleString();
    msg+=')';
    showToast(msg,'success');
    document.getElementById('customCode').value='';
    document.getElementById('maxUses').value='1';
    document.getElementById('expiresAt').value='';
    document.getElementById('autoApprove').checked=false;
    closeCreateInviteModal();
    await loadInvites();
  }catch(e){
    const msgEl=document.getElementById('inviteMsg');
    msgEl.textContent='Error: '+(e.message||e);
    msgEl.style.color='#ef4444';
  }
};
document.getElementById('addAdminBtn').onclick=async()=>{
  const firstName=document.getElementById('adminFirstName').value.trim();
  const lastName=document.getElementById('adminLastName').value.trim();
  const email=document.getElementById('adminEmail').value.trim().toLowerCase();
  const adminType=document.getElementById('adminType').value;
  if(!firstName){showToast('Please enter a first name','warning');return;}
  if(!lastName){showToast('Please enter a last name','warning');return;}
  if(!email){showToast('Please enter an email address','warning');return;}
  try{
    await api('/admin/admins',{method:'POST',body:JSON.stringify({first_name:firstName,last_name:lastName,email,admin_type:adminType})});
    showToast(`Admin user ${email} added successfully!`,'success');
    document.getElementById('adminFirstName').value='';
    document.getElementById('adminLastName').value='';
    document.getElementById('adminEmail').value='';
    document.getElementById('adminType').value='admin';
    closeAddAdminModal();
    await loadAdmins();
  }catch(e){
    const msgEl=document.getElementById('adminMsg');
    msgEl.textContent='Error: '+(e.message||e);
    msgEl.style.color='#ef4444';
  }
};

// Pagination event handlers
document.getElementById('invitesPerPage').onchange=(e)=>{paginationState.invites.perPage=Number(e.target.value);paginationState.invites.page=0;renderInvites();};
document.getElementById('invitesPrev').onclick=()=>{if(paginationState.invites.page>0){paginationState.invites.page--;renderInvites();}};
document.getElementById('invitesNext').onclick=()=>{if((paginationState.invites.page+1)*paginationState.invites.perPage<paginationState.invites.total){paginationState.invites.page++;renderInvites();}};
document.getElementById('adminsPerPage').onchange=(e)=>{paginationState.admins.perPage=Number(e.target.value);paginationState.admins.page=0;loadAdmins(false);};
document.getElementById('adminsPrev').onclick=()=>{if(paginationState.admins.page>0){paginationState.admins.page--;loadAdmins(false);}};
document.getElementById('adminsNext').onclick=()=>{if((paginationState.admins.page+1)*paginationState.admins.perPage<paginationState.admins.total){paginationState.admins.page++;loadAdmins(false);}};

// Search event handlers with debouncing
const debouncedRenderInvites=debounce(()=>renderInvites(),300);
const debouncedLoadAdmins=debounce(()=>loadAdmins(false),300);
document.getElementById('invitesSearch').oninput=(e)=>{paginationState.invites.search=e.target.value;paginationState.invites.page=0;document.getElementById('selectAllInvites').checked=false;debouncedRenderInvites();};
document.getElementById('adminsSearch').oninput=(e)=>{paginationState.admins.search=e.target.value;paginationState.admins.page=0;debouncedLoadAdmins();};

// Sortable table headers
document.querySelectorAll('th.sortable').forEach(th=>{
  th.onclick=()=>{
    const column=th.getAttribute('data-column');
    const list=th.getAttribute('data-list');
    const state=sortState[list];

    // Toggle sort direction
    if(state.column===column){
      state.direction=state.direction==='asc'?'desc':'asc';
    }else{
      state.column=column;
      state.direction='asc';
    }

    // Update header classes
    document.querySelectorAll(`th.sortable[data-list="${list}"]`).forEach(h=>{
      h.classList.remove('asc','desc');
    });
    th.classList.add(state.direction);

    // Reload data
    if(list==='users')loadUsers(false);
    else if(list==='invites')renderInvites();
    else if(list==='admins')loadAdmins(false);
    else if(list==='subscriptions')loadAllSubscriptions(false);
  };
});

// Tab switching
document.querySelectorAll('.tab').forEach(tab=>{tab.onclick=()=>{const target=tab.getAttribute('data-tab');document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));tab.classList.add('active');document.getElementById(target).classList.add('active');if(!tabsLoaded[target]){tabsLoaded[target]=true;if(target==='waitlist')loadWaitlist();if(target==='users')loadUsers();if(target==='invites')loadInvites();if(target==='admins')loadAdmins();if(target==='subscriptions')loadAllSubscriptions();if(target==='site-management'){loadCurrentTerms();loadSubscriptionTypes();}if(target==='vote-management')loadAllProposalsAdmin();}
// Close sidebar on mobile after selecting tab
if(window.innerWidth<=768){document.getElementById('sidebar').classList.add('collapsed');}
}});

// Sidebar toggle for mobile
document.getElementById('sidebarToggle').onclick=()=>{
  const sidebar=document.getElementById('sidebar');
  sidebar.classList.toggle('collapsed');
};

// User dropdown toggle
const userDropdownBtn=document.querySelector('.user-dropdown-btn');
const userDropdownMenu=document.getElementById('userDropdownMenu');
if(userDropdownBtn){
  userDropdownBtn.onclick=(e)=>{
    e.stopPropagation();
    userDropdownMenu.classList.toggle('active');
  };
}

// Close dropdown when clicking outside
document.addEventListener('click',()=>{
  if(userDropdownMenu)userDropdownMenu.classList.remove('active');
});

// Password change modal handlers
const passwordModal=document.getElementById('passwordModal');
const changePasswordBtn=document.getElementById('changePasswordBtn');
const closePasswordModal=document.getElementById('closePasswordModal');
const cancelPasswordChange=document.getElementById('cancelPasswordChange');
const submitPasswordChange=document.getElementById('submitPasswordChange');
const newPasswordInput=document.getElementById('newPassword');

if(changePasswordBtn){
  changePasswordBtn.onclick=()=>{
    passwordModal.classList.add('active');
    userDropdownMenu.classList.remove('active');
  };
}

if(closePasswordModal){
  closePasswordModal.onclick=()=>{
    passwordModal.classList.remove('active');
    clearPasswordFields();
  };
}

if(cancelPasswordChange){
  cancelPasswordChange.onclick=()=>{
    passwordModal.classList.remove('active');
    clearPasswordFields();
  };
}

// Close modal when clicking outside
passwordModal.onclick=(e)=>{
  if(e.target===passwordModal){
    passwordModal.classList.remove('active');
    clearPasswordFields();
  }
};

function clearPasswordFields(){
  document.getElementById('currentPassword').value='';
  document.getElementById('newPassword').value='';
  document.getElementById('confirmPassword').value='';
  document.getElementById('passwordStrengthFill').style.width='0%';
  document.getElementById('passwordStrengthText').textContent='';
  document.getElementById('passwordMatchIndicator').textContent='';
}

// Password strength indicator
if(newPasswordInput){
  newPasswordInput.oninput=()=>{
    const password=newPasswordInput.value;
    const strength=calculatePasswordStrength(password);
    const fill=document.getElementById('passwordStrengthFill');
    const text=document.getElementById('passwordStrengthText');

    fill.style.width=`${strength.percentage}%`;
    fill.className=`password-strength-fill strength-${strength.level}`;
    text.textContent=strength.text;
    text.className=`password-strength-text strength-${strength.level}`;

    checkPasswordMatch();
  };
}

// Password match indicator
const confirmPasswordInput=document.getElementById('confirmPassword');
if(confirmPasswordInput){
  confirmPasswordInput.oninput=checkPasswordMatch;
}

function checkPasswordMatch(){
  const newPassword=document.getElementById('newPassword').value;
  const confirmPassword=document.getElementById('confirmPassword').value;
  const indicator=document.getElementById('passwordMatchIndicator');

  if(!confirmPassword){
    indicator.textContent='';
    return;
  }

  if(newPassword===confirmPassword){
    indicator.textContent='âœ“ Passwords match';
    indicator.className='password-match-indicator password-match';
  }else{
    indicator.textContent='âœ— Passwords do not match';
    indicator.className='password-match-indicator password-no-match';
  }
}

function calculatePasswordStrength(password){
  if(!password)return{percentage:0,level:'weak',text:''};

  let score=0;
  if(password.length>=8)score+=25;
  if(password.length>=12)score+=25;
  if(/[a-z]/.test(password)&&/[A-Z]/.test(password))score+=25;
  if(/\d/.test(password))score+=12;
  if(/[^a-zA-Z0-9]/.test(password))score+=13;

  let level='weak';
  let text='Weak';
  if(score>=75){level='strong';text='Strong';}
  else if(score>=50){level='good';text='Good';}
  else if(score>=25){level='fair';text='Fair';}

  return{percentage:score,level,text};
}

// Submit password change
if(submitPasswordChange){
  submitPasswordChange.onclick=async()=>{
    const currentPassword=document.getElementById('currentPassword').value;
    const newPassword=document.getElementById('newPassword').value;
    const confirmPassword=document.getElementById('confirmPassword').value;

    if(!currentPassword||!newPassword||!confirmPassword){
      showToast('Please fill in all fields','error');
      return;
    }

    if(newPassword!==confirmPassword){
      showToast('New passwords do not match','error');
      return;
    }

    const strength=calculatePasswordStrength(newPassword);
    if(strength.percentage<50){
      showToast('Password is too weak. Use at least 8 characters with uppercase, lowercase, and numbers','warning');
      return;
    }

    submitPasswordChange.disabled=true;
    submitPasswordChange.textContent='Changing...';

    try{
      await changePassword(currentPassword,newPassword);
      showToast('Password changed successfully! Please sign in again.','success');
      passwordModal.classList.remove('active');
      clearPasswordFields();
      setTimeout(()=>signOut(),2000);
    }catch(e){
      showToast('Failed to change password: '+(e.message||e),'error');
      submitPasswordChange.disabled=false;
      submitPasswordChange.textContent='Change Password';
    }
  };
}

// Change Password via Backend API
// More secure approach: Backend re-authenticates with current password
// to get fresh access token before changing password
async function changePassword(oldPassword,newPassword){
  const result=await api('/admin/change-password',{
    method:'POST',
    body:JSON.stringify({
      currentPassword:oldPassword,
      newPassword:newPassword
    })
  });
  return result;
}

document.getElementById('selectAllInvites').onchange=(e)=>{
  const checked=e.target.checked;
  document.querySelectorAll('.invites-checkbox').forEach(cb=>cb.checked=checked);
  updateInvitesSelectedCount();
};

document.addEventListener('change',(e)=>{
  if(e.target.classList.contains('invites-checkbox')){
    updateInvitesSelectedCount();
    const total=document.querySelectorAll('.invites-checkbox').length;
    const checked=document.querySelectorAll('.invites-checkbox:checked').length;
    document.getElementById('selectAllInvites').checked=total>0&&checked===total;
  }
});

document.getElementById('bulkExpireInvites').onclick=async()=>{
  const checkboxes=document.querySelectorAll('.invites-checkbox:checked');
  const items=Array.from(checkboxes).filter(cb=>cb.getAttribute('data-status')==='active');
  const codes=items.map(cb=>cb.getAttribute('data-code'));
  if(codes.length===0){showToast('No active invites selected','warning');return;}
  if(!confirm(`Expire ${codes.length} invite(s)?`))return;
  try{
    for(const code of codes){
      await api(`/admin/invites/${code}/expire`,{method:'POST'});
    }
    showToast(`Expired ${codes.length} invite(s) successfully`,'success');
    await loadInvites();
    document.getElementById('selectAllInvites').checked=false;
  }catch(e){
    showToast('Error: '+(e.message||e),'error');
  }
};

document.getElementById('bulkDeleteInvites').onclick=async()=>{
  const checkboxes=document.querySelectorAll('.invites-checkbox:checked');
  const codes=Array.from(checkboxes).map(cb=>cb.getAttribute('data-code'));
  if(codes.length===0){showToast('No invites selected','warning');return;}
  if(!confirm(`Delete ${codes.length} invite(s)? This action cannot be undone.`))return;
  try{
    for(const code of codes){
      await api(`/admin/invites/${code}`,{method:'DELETE'});
    }
    showToast(`Deleted ${codes.length} invite(s) successfully`,'success');
    await loadInvites();
    document.getElementById('selectAllInvites').checked=false;
  }catch(e){
    showToast('Error: '+(e.message||e),'error');
  }
};

// Membership Terms Management
async function loadCurrentTerms(){
  if(!isAdmin())return;
  const display=document.getElementById('currentTermsDisplay');
  try{
    await refresh();
    const res=await fetch(API_URL+'/admin/membership-terms/current',{
      headers:{'Authorization':'Bearer '+idToken()}
    });
    if(res.status===404){
      display.innerHTML="<p class='muted' style='grid-column:1/-1;text-align:center;padding:40px;'>No current terms found. Create the first version above.</p>";
      return;
    }
    if(!res.ok){
      throw new Error('Failed to load current terms');
    }
    const data=await res.json();
    const createdDate=new Date(data.created_at).toLocaleString();
    display.innerHTML=`
      <div style="background:#0a0a0a;border:1px solid #10b981;border-radius:8px;padding:12px;box-sizing:border-box;min-width:0;display:flex;flex-direction:column;">
        <div style="margin-bottom:8px;">
          <span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Current Version</span>
        </div>
        <h4 style="margin:0 0 8px 0;font-weight:700;font-size:0.95rem;">Version ${data.version_id}</h4>
        <div style="margin-bottom:12px;padding:10px;background:#050505;border-radius:6px;border:1px solid var(--border);">
          <div style="margin-bottom:6px;font-size:0.8rem;">
            <span style="color:var(--gray);">Created:</span> <span style="font-weight:600;">${createdDate}</span>
          </div>
          <div style="margin-bottom:6px;font-size:0.8rem;">
            <span style="color:var(--gray);">Created by:</span> <span style="font-weight:600;">${data.created_by}</span>
          </div>
        </div>
        <div style="margin-top:auto;">
          <a href='${data.download_url}' target='_blank' class='btn' style='display:block;width:100%;box-sizing:border-box;text-align:center;text-decoration:none;background:linear-gradient(135deg,#ffd93d 0%,#ffc125 100%);color:#000;padding:8px 12px;font-size:0.8rem;font-weight:600;border-radius:12px;'>View Terms</a>
        </div>
      </div>
    `;
  }catch(e){
    console.error('Error loading current terms:',e);
    display.innerHTML="<p class='muted' style='grid-column:1/-1;text-align:center;padding:20px;'>Error loading current terms. Please try refreshing the page.</p>";
  }
}

document.getElementById('toggleTermsForm').onclick=()=>document.getElementById('createTermsModal').classList.add('active');

document.getElementById('createTermsBtn').onclick=async()=>{
  const termsText=document.getElementById('newTermsText').value.trim();
  const msgEl=document.getElementById('termsMsg');

  if(!termsText){
    msgEl.textContent='Please enter terms text';
    msgEl.style.color='#ef4444';
    return;
  }

  if(!confirm('Create new version of membership terms? This will replace the current version.'))return;

  try{
    const data=await api('/admin/membership-terms',{
      method:'POST',
      body:JSON.stringify({terms_text:termsText})
    });
    showToast(`New version created successfully! Version: ${data.version_id}`,'success');
    document.getElementById('newTermsText').value='';
    closeCreateTermsModal();
    await loadCurrentTerms();
  }catch(e){
    msgEl.textContent='Error: '+(e.message||e);
    msgEl.style.color='#ef4444';
  }
};

// Removed initial loading - now handled by lazy tab loading

// Subscription Type Management Functions
document.getElementById('toggleSubscriptionTypeForm').onclick=()=>document.getElementById('createSubscriptionTypeModal').classList.add('active');

// Handle free subscription checkbox
document.getElementById('subTypeFree').onchange=function(){
  const pricingFields=document.getElementById('pricingFields');
  const currencyField=document.getElementById('subTypeCurrency');
  const priceField=document.getElementById('subTypePrice');
  if(this.checked){
    pricingFields.style.opacity='0.5';
    currencyField.disabled=true;
    priceField.disabled=true;
    priceField.value='0';
  }else{
    pricingFields.style.opacity='1';
    currencyField.disabled=false;
    priceField.disabled=false;
    priceField.value='';
  }
};

document.getElementById('createSubscriptionTypeBtn').onclick=async()=>{
  const name=document.getElementById('subTypeName').value.trim();
  const description=document.getElementById('subTypeDescription').value.trim();
  const termValue=parseInt(document.getElementById('subTermValue').value);
  const termUnit=document.getElementById('subTermUnit').value;
  const isFree=document.getElementById('subTypeFree').checked;
  const currency=document.getElementById('subTypeCurrency').value;
  const price=isFree?0:parseFloat(document.getElementById('subTypePrice').value);
  const isOneTime=document.getElementById('subTypeOneTime').checked;
  const enabled=document.getElementById('subTypeEnabled').checked;
  const msgEl=document.getElementById('subscriptionTypeMsg');

  if(!name){
    msgEl.textContent='Please enter a name';
    msgEl.style.color='#ef4444';
    return;
  }
  if(!description){
    msgEl.textContent='Please enter a description';
    msgEl.style.color='#ef4444';
    return;
  }
  if(!termValue||termValue<1){
    msgEl.textContent='Please enter a valid term duration';
    msgEl.style.color='#ef4444';
    return;
  }
  if(!isFree&&(isNaN(price)||price<0)){
    msgEl.textContent='Please enter a valid price';
    msgEl.style.color='#ef4444';
    return;
  }

  try{
    const data=await api('/admin/subscription-types',{
      method:'POST',
      body:JSON.stringify({
        name:name,
        description:description,
        term_value:termValue,
        term_unit:termUnit,
        currency:currency,
        price:price,
        is_one_time_offer:isOneTime,
        enabled:enabled
      })
    });
    showToast('Subscription type created successfully!','success');
    document.getElementById('subTypeName').value='';
    document.getElementById('subTypeDescription').value='';
    document.getElementById('subTermValue').value='';
    document.getElementById('subTypeFree').checked=false;
    document.getElementById('subTypePrice').value='';
    document.getElementById('subTypeOneTime').checked=false;
    document.getElementById('subTypeEnabled').checked=true;
    document.getElementById('pricingFields').style.opacity='1';
    document.getElementById('subTypeCurrency').disabled=false;
    document.getElementById('subTypePrice').disabled=false;
    closeCreateSubscriptionTypeModal();
    await loadSubscriptionTypes();
  }catch(e){
    msgEl.textContent='Error: '+(e.message||e);
    msgEl.style.color='#ef4444';
  }
};

document.getElementById('refreshSubscriptionTypes').onclick=loadSubscriptionTypes;
document.getElementById('filterEnabledTypes').onclick=()=>filterSubscriptionTypes('enabled');
document.getElementById('filterAllTypes').onclick=()=>filterSubscriptionTypes('all');

// Removed initial loading - now handled by lazy tab loading

document.getElementById('toggleProposalForm').onclick=()=>document.getElementById('createProposalModal').classList.add('active');
document.getElementById('createProposalBtn').onclick=createProposal;
}); // End DOMContentLoaded

// Proposal Management Functions (must be global for onclick handlers)
let currentProposalFilter='active';
let totalActiveSubscribers=0;
let allProposalsData={active:[],upcoming:[],closed:[]};

async function createProposal(){
  const title=document.getElementById('proposalTitle').value.trim();
  const text=document.getElementById('proposalText').value.trim();
  const openDate=document.getElementById('proposalOpenDate').value;
  const closeDate=document.getElementById('proposalCloseDate').value;
  const msgEl=document.getElementById('proposalMsg');

  if(!title){
    msgEl.textContent='Please enter a proposal title';
    msgEl.style.color='#ef4444';
    return;
  }
  if(!text){
    msgEl.textContent='Please enter proposal text';
    msgEl.style.color='#ef4444';
    return;
  }
  if(!openDate||!closeDate){
    msgEl.textContent='Please select opening and closing date/time';
    msgEl.style.color='#ef4444';
    return;
  }

  const openDateTime=new Date(openDate);
  const closeDateTime=new Date(closeDate);

  if(closeDateTime<=openDateTime){
    msgEl.textContent='Closing date/time must be after opening date/time';
    msgEl.style.color='#ef4444';
    return;
  }

  try{
    const data=await api('/admin/proposals',{
      method:'POST',
      body:JSON.stringify({
        proposal_title:title,
        proposal_text:text,
        opens_at:openDateTime.toISOString(),
        closes_at:closeDateTime.toISOString()
      })
    });
    showToast('Proposal created successfully!','success');
    document.getElementById('proposalTitle').value='';
    document.getElementById('proposalText').value='';
    document.getElementById('proposalOpenDate').value='';
    document.getElementById('proposalCloseDate').value='';
    closeCreateProposalModal();
    await loadAllProposalsAdmin();
  }catch(e){
    msgEl.textContent='Error: '+(e.message||e);
    msgEl.style.color='#ef4444';
  }
}

function formatDateTime(isoString){
  const date=new Date(isoString);
  const options={month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',hour12:true};
  return date.toLocaleString('en-US',options);
}

function calculateTimeRemaining(targetDate){
  const now=new Date();
  const target=new Date(targetDate);
  const diff=target-now;

  if(diff<=0)return'Closed';

  const days=Math.floor(diff/(1000*60*60*24));
  const hours=Math.floor((diff%(1000*60*60*24))/(1000*60*60));
  const minutes=Math.floor((diff%(1000*60*60))/(1000*60));

  if(days>0){
    return`${days} day${days>1?'s':''} ${hours} hour${hours>1?'s':''}`;
  }else if(hours>0){
    return`${hours} hour${hours>1?'s':''} ${minutes} minute${minutes>1?'s':''}`;
  }else{
    return`${minutes} minute${minutes>1?'s':''}`;
  }
}

function toggleProposalText(proposalId){
  const element=document.getElementById(`text-${proposalId}`);
  const button=event.target;
  if(element.style.display==='none'){
    element.style.display='block';
    button.textContent='Hide Proposal';
  }else{
    element.style.display='none';
    button.textContent='View Proposal';
  }
}

async function toggleProposalResults(proposalId){
  const element=document.getElementById(`results-${proposalId}`);
  const button=event.target;

  if(element.style.display==='block'){
    element.style.display='none';
    button.textContent='View Results';
    return;
  }

  if(element.innerHTML){
    element.style.display='block';
    button.textContent='Hide Results';
    return;
  }

  try{
    button.textContent='Loading...';
    button.disabled=true;
    const data=await api(`/admin/proposals/${proposalId}/votes`);
    const total=data.totalVotes||0;
    const yes=data.results.yes||0;
    const no=data.results.no||0;
    const abstain=data.results.abstain||0;
    const yesPercent=total>0?Math.round((yes/total)*100):0;
    const noPercent=total>0?Math.round((no/total)*100):0;
    const abstainPercent=total>0?Math.round((abstain/total)*100):0;
    const turnout=totalActiveSubscribers>0?Math.round((total/totalActiveSubscribers)*100):0;

    // Determine pass/fail
    const passed=yes>no;
    const passfailBadge=document.getElementById(`passfail-${proposalId}`);
    if(passfailBadge){
      passfailBadge.innerHTML=passed?
        '<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 8px;border-radius:8px;font-size:0.7rem;font-weight:700;margin-left:8px;">PASSED</span>':
        '<span style="display:inline-block;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:4px 8px;border-radius:8px;font-size:0.7rem;font-weight:700;margin-left:8px;">FAILED</span>';
    }

    element.innerHTML=`
      <div style="padding:16px;background:#050505;border-radius:6px;border:1px solid var(--border);margin-top:12px;">
        <div style="margin-bottom:12px;font-size:0.9rem;color:var(--gray);">
          <strong style="color:var(--text);">Total votes cast:</strong> ${total}
        </div>
        <div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="font-size:0.85rem;color:#10b981;font-weight:600;">Yes</span>
            <span style="font-size:0.85rem;font-weight:600;">${yes} votes (${yesPercent}%)</span>
          </div>
          ${createProgressBar(yesPercent,'#10b981')}
        </div>
        <div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="font-size:0.85rem;color:#ef4444;font-weight:600;">No</span>
            <span style="font-size:0.85rem;font-weight:600;">${no} votes (${noPercent}%)</span>
          </div>
          ${createProgressBar(noPercent,'#ef4444')}
        </div>
        <div style="margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span style="font-size:0.85rem;color:#6b7280;font-weight:600;">Abstain</span>
            <span style="font-size:0.85rem;font-weight:600;">${abstain} votes (${abstainPercent}%)</span>
          </div>
          ${createProgressBar(abstainPercent,'#6b7280')}
        </div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);text-align:center;">
          <span style="font-size:0.85rem;color:var(--accent);font-weight:600;">Voter turnout: ${turnout}% of subscribers voted</span>
        </div>
      </div>
    `;
    element.style.display='block';
    button.textContent='Hide Results';
  }catch(e){
    showToast('Failed to load results: '+(e.message||e),'error');
    button.textContent='View Results';
  }finally{
    button.disabled=false;
  }
}

async function loadAllProposalsAdmin(){
  // Show loading skeleton while fetching data
  showGridLoadingSkeleton('proposalsContainer', 3);

  try{
    // Fetch all proposal types and total active subscribers
    const [active,upcoming,closed,subsData]=await Promise.all([
      api('/admin/proposals?status=active'),
      api('/admin/proposals?status=upcoming'),
      api('/admin/proposals?status=closed'),
      api('/admin/subscriptions?status=active')
    ]);

    allProposalsData={active,upcoming,closed};
    totalActiveSubscribers=(subsData.subscriptions||[]).length;

    // Update counts
    document.getElementById('activeVotesCount').textContent=active.length;
    document.getElementById('pendingVotesCount').textContent=upcoming.length;
    document.getElementById('completedVotesCount').textContent=closed.length;
    document.getElementById('allVotesCount').textContent=active.length+upcoming.length+closed.length;

    // Render proposals
    renderProposals();
  }catch(e){
    showToast('Failed to load proposals: '+(e.message||e),'error');
  }
}

async function renderProposals(){
  const container=document.getElementById('proposalsContainer');

  let proposalsToRender=[];
  if(currentProposalFilter==='active'){
    proposalsToRender=allProposalsData.active;
  }else if(currentProposalFilter==='upcoming'){
    proposalsToRender=allProposalsData.upcoming;
  }else if(currentProposalFilter==='closed'){
    proposalsToRender=allProposalsData.closed;
  }else{
    proposalsToRender=[...allProposalsData.active,...allProposalsData.upcoming,...allProposalsData.closed];
  }

  if(proposalsToRender.length===0){
    const emptyText=currentProposalFilter==='all'?'No proposals found':`No ${currentProposalFilter} proposals`;
    container.innerHTML=`<div class="empty-state"><div class="empty-state-text">${emptyText}</div></div>`;
    return;
  }

  let html='';
  for(const p of proposalsToRender){
    const status=p.status||'unknown';
    const now=new Date();
    const opensAt=new Date(p.opens_at);
    const closesAt=new Date(p.closes_at);

    let proposalType='unknown';
    if(now<opensAt)proposalType='upcoming';
    else if(now>=opensAt&&now<closesAt)proposalType='active';
    else proposalType='closed';

    if(proposalType==='active'){
      html+=await renderActiveTile(p);
    }else if(proposalType==='upcoming'){
      html+=renderUpcomingTile(p);
    }else if(proposalType==='closed'){
      html+=await renderClosedTile(p);
    }
  }
  container.innerHTML=html;
}

async function renderActiveTile(p){
  const opensDate=formatDateTime(p.opens_at);
  const closesDate=formatDateTime(p.closes_at);
  const timeRemaining=calculateTimeRemaining(p.closes_at);
  const createdBy=p.created_by||'Admin';

  let voteStatsHtml='';
  try{
    const voteData=await api(`/admin/proposals/${p.proposal_id}/votes`);
    const total=voteData.totalVotes||0;
    const yes=voteData.results.yes||0;
    const no=voteData.results.no||0;
    const abstain=voteData.results.abstain||0;
    const yesPercent=total>0?Math.round((yes/total)*100):0;
    const noPercent=total>0?Math.round((no/total)*100):0;
    const abstainPercent=total>0?Math.round((abstain/total)*100):0;

    voteStatsHtml=`
      <div style="margin-top:8px;padding:10px;background:#050505;border-radius:6px;border:1px solid var(--border);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-weight:600;color:var(--accent);font-size:0.8rem;">Current Voting Stats</span>
          <span style="font-size:0.7rem;color:var(--gray);">Total: ${total} votes</span>
        </div>
        <div style="margin-bottom:6px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
            <span style="font-size:0.75rem;color:#10b981;font-weight:600;">Yes</span>
            <span style="font-size:0.75rem;font-weight:600;">${yes} (${yesPercent}%)</span>
          </div>
          ${createProgressBar(yesPercent,'#10b981')}
        </div>
        <div style="margin-bottom:6px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
            <span style="font-size:0.75rem;color:#ef4444;font-weight:600;">No</span>
            <span style="font-size:0.75rem;font-weight:600;">${no} (${noPercent}%)</span>
          </div>
          ${createProgressBar(noPercent,'#ef4444')}
        </div>
        <div style="margin-bottom:6px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
            <span style="font-size:0.75rem;color:#6b7280;font-weight:600;">Abstain</span>
            <span style="font-size:0.75rem;font-weight:600;">${abstain} (${abstainPercent}%)</span>
          </div>
          ${createProgressBar(abstainPercent,'#6b7280')}
        </div>
      </div>
    `;
  }catch(e){
    voteStatsHtml='<p class="muted" style="font-size:0.85rem;margin-top:8px;">Vote data unavailable</p>';
  }

  return`
    <div style="background:#0a0a0a;border:1px solid #333;border-radius:8px;padding:12px;">
      <h4 style="margin:0 0 6px 0;font-weight:700;font-size:0.95rem;">${escapeHtml(p.proposal_title||'Untitled Proposal')}</h4>
      <div style="margin-bottom:8px;">
        <span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Active</span>
      </div>
      <div style="margin-bottom:8px;font-size:0.8rem;color:var(--gray);">
        <div style="margin-bottom:4px;">Opens: ${escapeHtml(opensDate)}</div>
        <div>Closes: ${escapeHtml(closesDate)}</div>
      </div>
      <div style="margin-bottom:8px;font-size:0.8rem;color:var(--gray);">
        Created by: ${escapeHtml(createdBy)}
      </div>
      <div style="margin-bottom:8px;padding:8px;background:#1a1a1a;border-radius:6px;text-align:center;">
        <span style="font-size:0.85rem;color:var(--accent);font-weight:600;">Closes in ${escapeHtml(timeRemaining)}</span>
      </div>
      <button onclick="toggleProposalText('${escapeHtml(p.proposal_id)}')" class="btn" style="width:100%;padding:8px 12px;font-size:0.8rem;background:linear-gradient(135deg,#ffd93d 0%,#ffc125 100%);color:#000;font-weight:600;margin-bottom:8px;">View Proposal</button>
      <div id="text-${escapeHtml(p.proposal_id)}" style="display:none;padding:10px;background:#050505;border-left:3px solid var(--accent);border-radius:4px;margin-bottom:8px;line-height:1.6;font-size:0.85rem;">${escapeHtml(p.proposal_text)}</div>
      ${voteStatsHtml}
    </div>
  `;
}

function renderUpcomingTile(p){
  const opensDate=formatDateTime(p.opens_at);
  const closesDate=formatDateTime(p.closes_at);
  const timeUntilOpens=calculateTimeRemaining(p.opens_at);
  const createdBy=p.created_by||'Admin';

  return`
    <div style="background:#0a0a0a;border:1px solid #333;border-radius:8px;padding:12px;">
      <h4 style="margin:0 0 6px 0;font-weight:700;font-size:0.95rem;color:#9ca3af;">${escapeHtml(p.proposal_title||'Untitled Proposal')}</h4>
      <div style="margin-bottom:8px;">
        <span style="display:inline-block;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:#000;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Upcoming</span>
      </div>
      <div style="margin-bottom:8px;font-size:0.8rem;color:var(--gray);">
        <div style="margin-bottom:4px;">Opens: ${escapeHtml(opensDate)}</div>
        <div>Closes: ${escapeHtml(closesDate)}</div>
      </div>
      <div style="margin-bottom:8px;font-size:0.8rem;color:var(--gray);">
        Created by: ${escapeHtml(createdBy)}
      </div>
      <div style="margin-bottom:8px;padding:8px;background:#1a1a1a;border-radius:6px;text-align:center;">
        <span style="font-size:0.85rem;color:var(--accent);font-weight:600;">Opens in ${escapeHtml(timeUntilOpens)}</span>
      </div>
      <button onclick="toggleProposalText('${escapeHtml(p.proposal_id)}')" class="btn" style="width:100%;padding:8px 12px;font-size:0.8rem;background:linear-gradient(135deg,#ffd93d 0%,#ffc125 100%);color:#000;font-weight:600;">View Proposal</button>
      <div id="text-${escapeHtml(p.proposal_id)}" style="display:none;padding:10px;background:#050505;border-left:3px solid var(--accent);border-radius:4px;margin-top:8px;line-height:1.6;font-size:0.85rem;">${escapeHtml(p.proposal_text)}</div>
    </div>
  `;
}

async function renderClosedTile(p){
  const opensDate=formatDateTime(p.opens_at);
  const closesDate=formatDateTime(p.closes_at);
  const createdBy=p.created_by||'Admin';

  let resultsHtml='';
  let passFailBadge='';
  try{
    const voteData=await api(`/admin/proposals/${p.proposal_id}/votes`);
    const total=voteData.totalVotes||0;
    const yes=voteData.results.yes||0;
    const no=voteData.results.no||0;
    const abstain=voteData.results.abstain||0;
    const yesPercent=total>0?Math.round((yes/total)*100):0;
    const noPercent=total>0?Math.round((no/total)*100):0;
    const abstainPercent=total>0?Math.round((abstain/total)*100):0;

    const passed=yes>no;
    const voterTurnout=totalActiveSubscribers>0?Math.round((total/totalActiveSubscribers)*100):0;

    passFailBadge=passed?
      '<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 8px;border-radius:8px;font-size:0.65rem;font-weight:700;margin-left:8px;">PASSED</span>':
      '<span style="display:inline-block;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:4px 8px;border-radius:8px;font-size:0.65rem;font-weight:700;margin-left:8px;">FAILED</span>';

    resultsHtml=`
      <div style="margin-top:8px;padding:10px;background:#050505;border-radius:6px;border:1px solid ${passed?'#10b981':'#ef4444'};">
        <div style="margin-bottom:8px;font-size:0.8rem;font-weight:600;color:var(--accent);">Results</div>
        <div style="margin-bottom:6px;font-size:0.75rem;color:var(--gray);">
          Total votes: ${total} | Turnout: ${voterTurnout}% of subscribers
        </div>
        <div style="margin-bottom:6px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
            <span style="font-size:0.75rem;color:#10b981;font-weight:600;">Yes</span>
            <span style="font-size:0.75rem;font-weight:600;">${yes} (${yesPercent}%)</span>
          </div>
          ${createProgressBar(yesPercent,'#10b981')}
        </div>
        <div style="margin-bottom:6px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
            <span style="font-size:0.75rem;color:#ef4444;font-weight:600;">No</span>
            <span style="font-size:0.75rem;font-weight:600;">${no} (${noPercent}%)</span>
          </div>
          ${createProgressBar(noPercent,'#ef4444')}
        </div>
        <div style="margin-bottom:6px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
            <span style="font-size:0.75rem;color:#6b7280;font-weight:600;">Abstain</span>
            <span style="font-size:0.75rem;font-weight:600;">${abstain} (${abstainPercent}%)</span>
          </div>
          ${createProgressBar(abstainPercent,'#6b7280')}
        </div>
      </div>
    `;
  }catch(e){
    resultsHtml='<p class="muted" style="font-size:0.8rem;margin-top:8px;">Results unavailable</p>';
  }

  return`
    <div style="background:#0a0a0a;border:1px solid #333;border-radius:8px;padding:12px;display:flex;flex-direction:column;min-height:100%;">
      <h4 style="margin:0 0 6px 0;font-weight:700;font-size:0.95rem;">${escapeHtml(p.proposal_title||'Untitled Proposal')}</h4>
      <div style="margin-bottom:8px;">
        <span style="display:inline-block;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Closed</span>
        ${passFailBadge}
      </div>
      <div style="margin-bottom:8px;font-size:0.8rem;color:var(--gray);">
        <div style="margin-bottom:4px;">Opened: ${escapeHtml(opensDate)}</div>
        <div>Closed: ${escapeHtml(closesDate)}</div>
      </div>
      <div style="margin-bottom:8px;font-size:0.8rem;color:var(--gray);">
        Created by: ${escapeHtml(createdBy)}
      </div>
      <div style="margin-top:auto;">
        <button onclick="toggleProposalText('${escapeHtml(p.proposal_id)}')" class="btn" style="width:100%;padding:8px 12px;font-size:0.8rem;background:linear-gradient(135deg,#ffd93d 0%,#ffc125 100%);color:#000;font-weight:600;margin-bottom:8px;">View Proposal</button>
        <div id="text-${escapeHtml(p.proposal_id)}" style="display:none;padding:10px;background:#050505;border-left:3px solid var(--accent);border-radius:4px;margin-bottom:8px;line-height:1.6;font-size:0.85rem;">${escapeHtml(p.proposal_text)}</div>
        ${resultsHtml}
      </div>
    </div>
  `;
}

// Subscription Type Management Functions (must be global for onclick handlers)
let allSubscriptionTypes=[];
let currentSubscriptionTypeFilter='enabled';

async function loadSubscriptionTypes(){
  const container=document.getElementById('subscriptionTypesList');
  // Show loading skeleton while fetching data
  showGridLoadingSkeleton('subscriptionTypesList', 3);

  try{
    const data=await api('/admin/subscription-types');
    if(!data.subscription_types||data.subscription_types.length===0){
      container.innerHTML='<p class="muted" style="grid-column:1/-1;text-align:center;padding:40px;">No subscription types created yet.</p>';
      allSubscriptionTypes=[];
      updateSubscriptionTypeCounts();
      return;
    }
    allSubscriptionTypes=data.subscription_types;
    updateSubscriptionTypeCounts();
    renderSubscriptionTypes();
  }catch(e){
    console.error('Error loading subscription types:',e);
    container.innerHTML="<p style='color:#ef4444;grid-column:1/-1;text-align:center;padding:20px;'>Error loading subscription types. Please try refreshing.</p>";
  }
}

function updateSubscriptionTypeCounts(){
  const enabledCount=allSubscriptionTypes.filter(st=>st.is_enabled).length;
  document.getElementById('enabledTypesCount').textContent=enabledCount;
  document.getElementById('allTypesCount').textContent=allSubscriptionTypes.length;
}

function renderSubscriptionTypes(){
  const container=document.getElementById('subscriptionTypesList');

  // Filter based on current filter
  let filteredTypes=allSubscriptionTypes;
  if(currentSubscriptionTypeFilter==='enabled'){
    filteredTypes=allSubscriptionTypes.filter(st=>st.is_enabled);
  }

  // Sort: enabled types first, then disabled types
  filteredTypes=filteredTypes.sort((a,b)=>{
    if(a.is_enabled===b.is_enabled)return 0;
    return a.is_enabled?-1:1;
  });

  if(filteredTypes.length===0){
    container.innerHTML='<p class="muted" style="grid-column:1/-1;text-align:center;padding:40px;">No subscription types match the current filter.</p>';
    return;
  }

  container.innerHTML=filteredTypes.map(st=>{
    const statusColor=st.is_enabled?'#10b981':'#ef4444';
    const statusBadge=st.is_enabled?
      '<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Enabled</span>':
      '<span style="display:inline-block;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Disabled</span>';
    const btnText=st.is_enabled?'Disable':'Enable';
    const btnStyle=st.is_enabled?'background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);':'background:linear-gradient(135deg,#10b981 0%,#059669 100%);';
    const priceDisplay=st.price===0||st.price==='0'?'<span style="color:#10b981;font-weight:600;">FREE</span>':`${escapeHtml(st.currency)} ${escapeHtml(parseFloat(st.price).toFixed(2))}`;

    return `
      <div style="background:#0a0a0a;border:1px solid ${st.is_enabled?'#10b981':'#333'};border-radius:8px;padding:12px;box-sizing:border-box;min-width:0;display:flex;flex-direction:column;">
        <div style="margin-bottom:8px;">
          ${statusBadge}
        </div>
        <h4 style="margin:0 0 8px 0;font-weight:700;font-size:0.95rem;">${escapeHtml(st.name)}</h4>
        <p style="margin:0 0 12px 0;color:var(--gray);font-size:0.85rem;line-height:1.4;">${escapeHtml(st.description)}</p>
        <div style="margin-bottom:12px;padding:10px;background:#050505;border-radius:6px;border:1px solid var(--border);">
          <div style="margin-bottom:6px;font-size:0.8rem;">
            <span style="color:var(--gray);">Term:</span> <span style="font-weight:600;">${escapeHtml(st.term_value)} ${escapeHtml(st.term_unit)}</span>
          </div>
          <div style="margin-bottom:6px;font-size:0.8rem;">
            <span style="color:var(--gray);">Price:</span> <span style="font-weight:600;">${priceDisplay}</span>
          </div>
          ${st.is_one_time_offer?'<div style="margin-top:6px;padding:6px;background:#422006;border-radius:4px;border:1px solid #fbbf24;"><p style="margin:0;color:#fbbf24;font-size:0.75rem;font-weight:600;text-align:center;">One-Time Offer</p></div>':''}
        </div>
        <div style="margin-top:auto;">
          <button class="btn" onclick="toggleSubscriptionType('${escapeHtml(st.subscription_type_id)}',${st.is_enabled})" style="width:100%;${btnStyle}color:#fff;padding:8px 12px;font-size:0.8rem;font-weight:600;">${escapeHtml(btnText)}</button>
        </div>
      </div>
    `;
  }).join('');
}

function filterSubscriptionTypes(filter){
  currentSubscriptionTypeFilter=filter;

  // Update button active states
  document.querySelectorAll('.subscription-type-filter').forEach(btn=>{
    btn.classList.remove('active');
    if(btn.dataset.filter===filter){
      btn.classList.add('active');
    }
  });

  renderSubscriptionTypes();
}

async function toggleSubscriptionType(subscriptionTypeId,currentStatus){
  const action=currentStatus?'disable':'enable';
  if(!confirm(`Are you sure you want to ${action} this subscription type?`))return;

  try{
    await api(`/admin/subscription-types/${subscriptionTypeId}/${action}`,{
      method:'POST'
    });
    await loadSubscriptionTypes();
  }catch(e){
    alert('Error: '+(e.message||e));
  }
}

// Proposal filter function
function filterProposals(type){
  currentProposalFilter=type;
  document.querySelectorAll('.proposal-filter').forEach(btn=>{
    btn.classList.remove('active');
    btn.style.opacity='0.7';
  });
  event.target.closest('.proposal-filter').classList.add('active');
  event.target.closest('.proposal-filter').style.opacity='1';
  renderProposals();
}

// Add filter button event listeners
document.getElementById('filterActiveVotes').onclick=(e)=>filterProposals('active');
document.getElementById('filterPendingVotes').onclick=(e)=>filterProposals('upcoming');
document.getElementById('filterCompletedVotes').onclick=(e)=>filterProposals('closed');
document.getElementById('filterAllVotes').onclick=(e)=>filterProposals('all');

// Removed initial loading and duplicate event listener - now handled by lazy tab loading

// Subscription Management Functions - Unified View
async function loadAllSubscriptions(resetPage=true){
  if(!isAdmin())return;
  if(resetPage)paginationState.subscriptions.page=0;
  const tbody=document.querySelector('#subscriptionsTable tbody');

  // Show loading skeleton
  showLoadingSkeleton('subscriptionsTable');

  try{
    // Fetch ALL subscriptions (no status filter)
    const data=await api('/admin/subscriptions');
    allSubscriptionsData=data.subscriptions||[];

    // Update quick filter counts
    updateSubscriptionFilterCounts();

    // Populate plan filter dropdown
    populatePlanFilter();

    // Render the filtered data
    renderSubscriptions();
  }catch(e){
    showToast('Failed to load subscriptions: '+(e.message||e),'error');
    tbody.innerHTML=`<tr><td colspan="7" class="muted">${e.message||e}</td></tr>`;
  }
}

function updateSubscriptionFilterCounts(){
  let paidCt=0,freeCt=0,monthlyRevenue=0;

  allSubscriptionsData.forEach(s=>{
    // Count paid vs free and calculate revenue
    const amount=s.amount||0;
    if(amount>0){
      paidCt++;
      // Only count active subscriptions for revenue estimate
      if(s.status==='active'){
        monthlyRevenue+=amount;
      }
    }else{
      freeCt++;
    }
  });

  document.getElementById('allSubsCount').textContent=allSubscriptionsData.length;
  document.getElementById('paidSubsCount').textContent=paidCt;
  document.getElementById('freeSubsCount').textContent=freeCt;
  document.getElementById('estimatedMonthlyRevenue').textContent='$'+monthlyRevenue.toFixed(2);
}

function populatePlanFilter(){
  const plans=new Set();
  allSubscriptionsData.forEach(s=>{
    if(s.plan)plans.add(s.plan);
  });
  const select=document.getElementById('filterSubPlan');
  const currentValue=select.value;
  select.innerHTML='<option value="">All Plans</option>';
  Array.from(plans).sort().forEach(plan=>{
    const opt=document.createElement('option');
    opt.value=plan;
    opt.textContent=plan;
    select.appendChild(opt);
  });
  select.value=currentValue;
}

function renderSubscriptions(){
  const tbody=document.querySelector('#subscriptionsTable tbody');
  tbody.innerHTML='';

  // Apply filters
  let filtered=allSubscriptionsData.filter(s=>{
    // Quick filter
    const now=new Date();
    const expiresDate=new Date(s.expires_at);
    const daysLeft=Math.ceil((expiresDate-now)/(1000*60*60*24));

    // Status dropdown filter
    if(subFilters.status==='active'&&s.status!=='active')return false;
    if(subFilters.status==='expiring'&&(s.status!=='active'||daysLeft>=7))return false;
    if(subFilters.status==='cancelled'&&s.status!=='cancelled')return false;
    if(subFilters.status==='expired'&&(s.status==='expired'||daysLeft<=0))return false;

    // Quick filter buttons (paid/free/all)
    if(subFilters.quickFilter==='paid'&&((s.amount||0)<=0))return false;
    if(subFilters.quickFilter==='free'&&((s.amount||0)>0))return false;

    // Plan filter
    if(subFilters.plan&&s.plan!==subFilters.plan)return false;

    // Search filter
    const search=paginationState.subscriptions.search.toLowerCase();
    if(search){
      const searchable=[s.first_name,s.last_name,s.email,s.plan,s.user_guid].filter(Boolean).join(' ').toLowerCase();
      if(!searchable.includes(search))return false;
    }

    return true;
  });

  // Sort by expires_at (soonest first)
  filtered.sort((a,b)=>new Date(a.expires_at).getTime()-new Date(b.expires_at).getTime());

  // Check for empty state
  if(filtered.length===0){
    showEmptyState('subscriptionsTable','No subscriptions found','Try adjusting your filters');
    return;
  }

  // Paginate
  const page=updatePagination('subscriptions',filtered);
  const now=new Date();

  page.forEach(s=>{
    const tr=document.createElement('tr');
    const expiresDate=new Date(s.expires_at);
    const daysLeft=Math.ceil((expiresDate-now)/(1000*60*60*24));
    const name=`${s.first_name||''} ${s.last_name||''}`.trim()||'â€”';

    // Status badge with gradient
    let statusBadge='';
    if(s.status==='active'){
      statusBadge='<span style="display:inline-block;background:linear-gradient(135deg,#a855f7 0%,#7c3aed 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Active</span>';
    }else if(s.status==='cancelled'){
      statusBadge='<span style="display:inline-block;background:linear-gradient(135deg,#f97316 0%,#ea580c 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Cancelled</span>';
    }else{
      statusBadge='<span style="display:inline-block;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Expired</span>';
    }

    // Days left badge with color coding
    let daysLeftBadge='';
    if(s.status==='active'){
      if(daysLeft<7){
        daysLeftBadge=`<span style="display:inline-block;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">${daysLeft}d</span>`;
      }else if(daysLeft<=30){
        daysLeftBadge=`<span style="display:inline-block;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:#000;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">${daysLeft}d</span>`;
      }else{
        daysLeftBadge=`<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">${daysLeft}d</span>`;
      }
    }else{
      daysLeftBadge='<span style="color:#6b7280;">â€”</span>';
    }

    // PIN and Email preferences badges
    const pinBadge=s.pin_enabled
      ?'<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Yes</span>'
      :'<span style="display:inline-block;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">No</span>';
    const emailBadge=s.system_emails_enabled
      ?'<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">On</span>'
      :'<span style="display:inline-block;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Off</span>';

    tr.innerHTML=`<td><input type='checkbox' class='subscription-checkbox' data-guid='${escapeHtml(s.user_guid)}' /></td><td>${escapeHtml(name)}</td><td>${escapeHtml(s.email)}</td><td>${escapeHtml(s.plan)||'â€”'}</td><td>${statusBadge}</td><td>${pinBadge}</td><td>${emailBadge}</td><td>${escapeHtml(expiresDate.toLocaleString())}</td><td>${daysLeftBadge}</td>`;
    tbody.appendChild(tr);
  });

  updateSubscriptionsSelectedCount();
}

function updateSubscriptionsSelectedCount(){
  const checkboxes=document.querySelectorAll('.subscription-checkbox:checked');
  const count=checkboxes.length;
  document.getElementById('selectedSubscriptionsCount').textContent=count>0?`${count} selected`:'';
}

document.getElementById('selectAllSubscriptions').onchange=function(){
  document.querySelectorAll('.subscription-checkbox').forEach(cb=>cb.checked=this.checked);
  updateSubscriptionsSelectedCount();
};
document.addEventListener('change',e=>{
  if(e.target.classList.contains('subscription-checkbox'))updateSubscriptionsSelectedCount();
});

document.getElementById('bulkExtendSubscriptions').onclick=async()=>{
  const checkboxes=document.querySelectorAll('.subscription-checkbox:checked');
  if(checkboxes.length===0){
    showToast('Please select at least one subscription','warning');
    return;
  }
  if(!confirm(`Extend ${checkboxes.length} subscription(s) by 7 days?`))return;
  try{
    const guids=Array.from(checkboxes).map(cb=>cb.getAttribute('data-guid'));
    for(const guid of guids){
      await api(`/admin/subscriptions/${encodeURIComponent(guid)}/extend`,{method:'POST',body:JSON.stringify({days:7})});
    }
    showToast(`Extended ${checkboxes.length} subscription(s) by 7 days`,'success');
    await loadAllSubscriptions(true);
  }catch(e){
    showToast('Error: '+(e.message||e),'error');
  }
};

// Quick filter buttons with active highlighting
// Status dropdown filter
document.getElementById('filterSubStatus').onchange=e=>{
  subFilters.status=e.target.value;
  paginationState.subscriptions.page=0;
  renderSubscriptions();
};

// Quick filter buttons
document.getElementById('quickFilterAllSubs').onclick=()=>{
  subFilters.quickFilter='all';
  document.querySelectorAll('#subscriptions .btn').forEach(btn => btn.classList.remove('filter-active'));
  document.getElementById('quickFilterAllSubs').classList.add('filter-active');
  paginationState.subscriptions.page=0;
  renderSubscriptions();
};
document.getElementById('quickFilterPaidSubs').onclick=()=>{
  subFilters.quickFilter='paid';
  document.querySelectorAll('#subscriptions .btn').forEach(btn => btn.classList.remove('filter-active'));
  document.getElementById('quickFilterPaidSubs').classList.add('filter-active');
  paginationState.subscriptions.page=0;
  renderSubscriptions();
};
document.getElementById('quickFilterFreeSubs').onclick=()=>{
  subFilters.quickFilter='free';
  document.querySelectorAll('#subscriptions .btn').forEach(btn => btn.classList.remove('filter-active'));
  document.getElementById('quickFilterFreeSubs').classList.add('filter-active');
  paginationState.subscriptions.page=0;
  renderSubscriptions();
};

// Plan filter
document.getElementById('filterSubPlan').onchange=e=>{
  subFilters.plan=e.target.value;
  paginationState.subscriptions.page=0;
  renderSubscriptions();
};

// Reset filters
document.getElementById('resetSubFilters').onclick=()=>{
  subFilters.status='';
  subFilters.plan='';
  subFilters.quickFilter='all';
  paginationState.subscriptions.search='';
  document.getElementById('subscriptionsSearch').value='';
  document.getElementById('filterSubStatus').value='';
  document.getElementById('filterSubPlan').value='';
  document.querySelectorAll('#subscriptions .btn').forEach(btn => btn.classList.remove('filter-active'));
  document.getElementById('quickFilterAllSubs').classList.add('filter-active');
  paginationState.subscriptions.page=0;
  renderSubscriptions();
};

// Refresh button
document.getElementById('refreshSubscriptions').onclick=()=>loadAllSubscriptions(true);

// Search with debouncing
const debouncedLoadSubscriptions=debounce(()=>renderSubscriptions(),300);
document.getElementById('subscriptionsSearch').oninput=e=>{
  paginationState.subscriptions.search=e.target.value;
  paginationState.subscriptions.page=0;
  document.getElementById('selectAllSubscriptions').checked=false;
  debouncedLoadSubscriptions();
};

// Pagination
document.getElementById('subscriptionsPerPage').onchange=e=>{
  paginationState.subscriptions.perPage=parseInt(e.target.value);
  paginationState.subscriptions.page=0;
  renderSubscriptions();
};
document.getElementById('subscriptionsPrev').onclick=()=>{
  if(paginationState.subscriptions.page>0){
    paginationState.subscriptions.page--;
    renderSubscriptions();
  }
};
document.getElementById('subscriptionsNext').onclick=()=>{
  const maxPage=Math.ceil(paginationState.subscriptions.total/paginationState.subscriptions.perPage)-1;
  if(paginationState.subscriptions.page<maxPage){
    paginationState.subscriptions.page++;
    renderSubscriptions();
  }
};

// Admin Access Management Modal
let currentManageAdmin = null;

function openManageAccessModal(adminEmail, adminName, adminType, isEnabled) {
  currentManageAdmin = { email: adminEmail, name: adminName, type: adminType, enabled: isEnabled };
  const modal = document.getElementById('manageAccessModal');
  const modalTitle = document.getElementById('manageAccessTitle');
  modalTitle.textContent = `Manage Access: ${adminName}`;

  // Update status action text
  const statusAction = document.getElementById('statusActionTitle');
  const statusDesc = document.getElementById('statusActionDesc');
  if (isEnabled) {
    statusAction.textContent = 'Disable Admin';
    statusDesc.textContent = 'Prevent this admin from logging in';
  } else {
    statusAction.textContent = 'Enable Admin';
    statusDesc.textContent = 'Allow this admin to log in again';
  }

  modal.classList.add('active');
}

function closeManageAccessModal() {
  document.getElementById('manageAccessModal').classList.remove('active');
  currentManageAdmin = null;
}

async function handleToggleAdminStatus() {
  if (!currentManageAdmin) return;

  const action = currentManageAdmin.enabled ? 'disable' : 'enable';
  const confirmMsg = currentManageAdmin.enabled
    ? `Disable admin account for ${currentManageAdmin.email}? They will not be able to log in until re-enabled.`
    : `Enable admin account for ${currentManageAdmin.email}? They will be able to log in again.`;

  if (!confirm(confirmMsg)) return;

  try {
    await api(`/admin/admins/${encodeURIComponent(currentManageAdmin.email)}/${action}`, { method: 'POST' });
    showToast(`Admin user ${action}d successfully`, 'success');
  } catch (e) {
    showToast('Error: ' + (e.message || e), 'error');
    return;
  } finally {
    // Always close modal
    closeManageAccessModal();
  }

  // Reload admin list after successful update
  await loadAdmins();
}

async function handleDeleteAdmin() {
  if (!currentManageAdmin) return;

  if (!confirm(`Delete admin account for ${currentManageAdmin.email}? This will permanently delete their Cognito account and they will need to be re-invited to regain access.`)) return;

  try {
    await api(`/admin/admins/${encodeURIComponent(currentManageAdmin.email)}`, { method: 'DELETE' });
    showToast('Admin user deleted successfully', 'success');
  } catch (e) {
    showToast('Error: ' + (e.message || e), 'error');
    return;
  } finally {
    // Always close modal
    closeManageAccessModal();
  }

  // Reload admin list after successful update
  await loadAdmins();
}

function openChangeAdminTypeModal() {
  if (!currentManageAdmin) return;

  const changeTypeModal = document.getElementById('changeAdminTypeModal');
  const currentTypeDisplay = document.getElementById('currentAdminType');

  const adminTypeLabels = {
    'admin': 'Admin - Full Access',
    'user_admin': 'User Admin - Waitlist and Users',
    'subscriber_admin': 'Subscriber Admin - Waitlist, Users, Subscribers and Invites',
    'vote_admin': 'Vote Admin - Vote Management'
  };

  currentTypeDisplay.textContent = `Current: ${adminTypeLabels[currentManageAdmin.type] || 'Admin'}`;

  // Set the select to current type
  document.getElementById('newAdminType').value = currentManageAdmin.type || 'admin';

  changeTypeModal.classList.add('active');
}

function closeChangeAdminTypeModal() {
  document.getElementById('changeAdminTypeModal').classList.remove('active');
}

async function handleChangeAdminType() {
  if (!currentManageAdmin) return;

  const newType = document.getElementById('newAdminType').value;

  if (newType === currentManageAdmin.type) {
    showToast('Admin type is already set to this value', 'warning');
    return;
  }

  const adminTypeLabels = {
    'admin': 'Admin - Full Access',
    'user_admin': 'User Admin - Waitlist and Users',
    'subscriber_admin': 'Subscriber Admin - Waitlist, Users, Subscribers and Invites',
    'vote_admin': 'Vote Admin - Vote Management'
  };

  if (!confirm(`Change admin type for ${currentManageAdmin.email} to ${adminTypeLabels[newType]}?`)) return;

  try {
    await api(`/admin/admins/${encodeURIComponent(currentManageAdmin.email)}/type`, {
      method: 'PUT',
      body: JSON.stringify({ admin_type: newType })
    });
    showToast('Admin type updated successfully', 'success');
  } catch (e) {
    showToast('Error: ' + (e.message || e), 'error');
    return;
  } finally {
    // Always close modals and reload, even on error
    closeChangeAdminTypeModal();
    closeManageAccessModal();
  }

  // Reload admin list after successful update
  await loadAdmins();
}

async function handleResetAdminPassword() {
  if (!currentManageAdmin) return;

  const adminName = currentManageAdmin.name || currentManageAdmin.email;

  if (!confirm(`Reset password for ${adminName}?\n\nA temporary password will be generated and emailed to ${currentManageAdmin.email}. They will be required to change it on first login.`)) {
    return;
  }

  try {
    const result = await api(`/admin/admins/${encodeURIComponent(currentManageAdmin.email)}/reset-password`, {
      method: 'POST'
    });
    showToast(`Password reset successfully. Temporary password has been emailed to ${currentManageAdmin.email}`, 'success');
    closeManageAccessModal();
  } catch (e) {
    showToast('Error resetting password: ' + (e.message || e), 'error');
  }
}

// Modal close functions
function closeCreateInviteModal() {
  document.getElementById('createInviteModal').classList.remove('active');
  document.getElementById('inviteMsg').textContent = '';
}

function closeAddAdminModal() {
  document.getElementById('addAdminModal').classList.remove('active');
  document.getElementById('adminMsg').textContent = '';
}

function closeCreateSubscriptionTypeModal() {
  document.getElementById('createSubscriptionTypeModal').classList.remove('active');
  document.getElementById('subscriptionTypeMsg').textContent = '';
}

function closeCreateTermsModal() {
  document.getElementById('createTermsModal').classList.remove('active');
  document.getElementById('termsMsg').textContent = '';
}

function closeCreateProposalModal() {
  document.getElementById('createProposalModal').classList.remove('active');
  document.getElementById('proposalMsg').textContent = '';
}

// Close modals when clicking overlay
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal-overlay')) {
    e.target.classList.remove('active');
    currentManageAdmin = null;
  }
});

// Initialize the active tab on page load - wait for auth to complete
let authCheckInterval = setInterval(() => {
  if (idToken()) {
    clearInterval(authCheckInterval);
    const activeTab = document.querySelector('.tab.active');
    if (activeTab) {
      const target = activeTab.getAttribute('data-tab');
      if (!tabsLoaded[target]) {
        tabsLoaded[target] = true;
        if (target === 'waitlist') loadWaitlist();
      }
    }
  }
}, 250); // Check every 250ms until auth is ready

// Clear interval after 10 seconds to prevent infinite loop
setTimeout(() => clearInterval(authCheckInterval), 10000);

// ===== WAITLIST MANAGEMENT =====
let allWaitlistData = [];
let waitlistPaginationState = { currentPage: 1, perPage: 10, search: '' };
let waitlistQuickFilter = 'pending'; // Default to pending

async function loadWaitlist(resetPage = true) {
  if (resetPage) waitlistPaginationState.currentPage = 1;

  // Show loading state
  const tbody = document.querySelector('#waitlistTable tbody');
  tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">Loading waitlist data...</td></tr>';

  try {
    const token = idToken();
    const res = await fetch(`${API_URL}/admin/waitlist`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Failed to load waitlist');
    allWaitlistData = data.waitlist || [];
    updateWaitlistCounts();
    renderWaitlist();
  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#f44;">Failed to load waitlist. Please refresh and try again.</td></tr>';
    showToast(err.message || 'Failed to load waitlist', 'error');
  }
}

function updateWaitlistCounts() {
  const pending = allWaitlistData.filter(w => w.status === 'pending' || !w.status).length;
  const invited = allWaitlistData.filter(w => w.status === 'invited').length;
  const rejected = allWaitlistData.filter(w => w.status === 'rejected').length;

  document.getElementById('pendingWaitlistCount').textContent = pending;
  document.getElementById('invitedWaitlistCount').textContent = invited;
  document.getElementById('rejectedWaitlistCount').textContent = rejected;
  document.getElementById('allWaitlistCount').textContent = allWaitlistData.length;
}

function renderWaitlist() {
  const tbody = document.querySelector('#waitlistTable tbody');
  tbody.innerHTML = '';

  // Apply filters
  let filtered = allWaitlistData.filter(w => {
    // Quick filter
    if (waitlistQuickFilter === 'pending' && w.status !== 'pending' && w.status) return false;
    if (waitlistQuickFilter === 'invited' && w.status !== 'invited') return false;
    if (waitlistQuickFilter === 'rejected' && w.status !== 'rejected') return false;

    // Search filter
    const search = waitlistPaginationState.search.toLowerCase();
    if (search) {
      const searchable = [w.first_name, w.last_name, w.email].filter(Boolean).join(' ').toLowerCase();
      if (!searchable.includes(search)) return false;
    }
    return true;
  });

  // Check for empty state
  if (filtered.length === 0) {
    showEmptyState('waitlistTable', 'No waitlist entries found', 'Try adjusting your filters');
    return;
  }

  // Paginate
  const totalPages = Math.ceil(filtered.length / waitlistPaginationState.perPage);
  waitlistPaginationState.currentPage = Math.min(waitlistPaginationState.currentPage, Math.max(1, totalPages));
  const start = (waitlistPaginationState.currentPage - 1) * waitlistPaginationState.perPage;
  const end = start + waitlistPaginationState.perPage;
  const page = filtered.slice(start, end);

  document.getElementById('waitlistInfo').textContent = `Page ${waitlistPaginationState.currentPage} of ${totalPages} (${filtered.length} total)`;
  document.getElementById('waitlistPrev').disabled = waitlistPaginationState.currentPage === 1;
  document.getElementById('waitlistNext').disabled = waitlistPaginationState.currentPage === totalPages || filtered.length === 0;

  page.forEach(w => {
    const tr = document.createElement('tr');
    const name = `${w.first_name || ''} ${w.last_name || ''}`.trim() || 'â€”';
    const createdDate = w.created_at ? new Date(w.created_at).toLocaleString() : 'â€”';
    const invitedDate = w.invited_at ? new Date(w.invited_at).toLocaleString() : 'â€”';

    let statusBadge = '<span style="display:inline-block;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Pending</span>';
    if (w.status === 'invited') {
      statusBadge = '<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Invited</span>';
    } else if (w.status === 'rejected') {
      statusBadge = '<span style="display:inline-block;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Rejected</span>';
    }

    const isDisabled = w.status === 'invited' || w.status === 'rejected';
    tr.innerHTML = `<td><input type='checkbox' class='waitlist-checkbox' data-id='${escapeHtml(w.waitlist_id)}' ${isDisabled ? 'disabled title="Already processed"' : ''} /></td><td>${escapeHtml(name)}</td><td>${escapeHtml(w.email)}</td><td>${statusBadge}</td><td>${createdDate}</td><td>${invitedDate}</td>`;
    tbody.appendChild(tr);
  });

  updateWaitlistSelectedCount();
}

function updateWaitlistSelectedCount() {
  const checkboxes = document.querySelectorAll('.waitlist-checkbox:checked');
  const count = checkboxes.length;
  const countText = count > 0 ? `${count} selected` : '';
  document.getElementById('selectedWaitlistCount').textContent = countText;
  document.getElementById('sendInvitesBtn').disabled = count === 0;
  document.getElementById('rejectWaitlistBtn').disabled = count === 0;
}

document.getElementById('selectAllWaitlist').onchange = function() {
  document.querySelectorAll('.waitlist-checkbox:not([disabled])').forEach(cb => cb.checked = this.checked);
  updateWaitlistSelectedCount();
};

document.addEventListener('change', e => {
  if (e.target.classList.contains('waitlist-checkbox')) updateWaitlistSelectedCount();
});

document.getElementById('refreshWaitlist').onclick = () => loadWaitlist(true);

document.getElementById('sendInvitesBtn').onclick = async () => {
  const checkboxes = document.querySelectorAll('.waitlist-checkbox:checked');
  if (checkboxes.length === 0) {
    showToast('Please select at least one waitlist entry', 'warning');
    return;
  }

  if (!confirm(`Send invites to ${checkboxes.length} waitlist ${checkboxes.length === 1 ? 'entry' : 'entries'}?`)) return;

  const waitlist_ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));

  try {
    const token = idToken();
    const res = await fetch(`${API_URL}/admin/waitlist/send-invites`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ waitlist_ids })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Failed to send invites');

    showToast(data.message || `Sent ${data.sent?.length || 0} invites`, 'success');

    if (data.failed && data.failed.length > 0) {
      showToast(`${data.failed.length} failed: ${data.failed.map(f => f.email).join(', ')}`, 'warning', 8000);
    }

    loadWaitlist(false);
  } catch (err) {
    showToast(err.message || 'Failed to send invites', 'error');
  }
};

// Waitlist search
document.getElementById('waitlistSearch').oninput = (e) => {
  waitlistPaginationState.search = e.target.value;
  waitlistPaginationState.currentPage = 1;
  renderWaitlist();
};

document.getElementById('resetWaitlistFilters').onclick = () => {
  document.getElementById('waitlistSearch').value = '';
  waitlistPaginationState.search = '';
  waitlistPaginationState.currentPage = 1;
  renderWaitlist();
};

// Waitlist pagination
document.getElementById('waitlistPerPage').onchange = (e) => {
  waitlistPaginationState.perPage = parseInt(e.target.value);
  waitlistPaginationState.currentPage = 1;
  renderWaitlist();
};

document.getElementById('waitlistPrev').onclick = () => {
  if (waitlistPaginationState.currentPage > 1) {
    waitlistPaginationState.currentPage--;
    renderWaitlist();
  }
};

document.getElementById('waitlistNext').onclick = () => {
  const totalPages = Math.ceil(allWaitlistData.filter(w => {
    const search = waitlistPaginationState.search.toLowerCase();
    if (search) {
      const searchable = [w.first_name, w.last_name, w.email].filter(Boolean).join(' ').toLowerCase();
      return searchable.includes(search);
    }
    return true;
  }).length / waitlistPaginationState.perPage);

  if (waitlistPaginationState.currentPage < totalPages) {
    waitlistPaginationState.currentPage++;
    renderWaitlist();
  }
};

// Waitlist filter buttons
document.getElementById('quickFilterPending').onclick = () => {
  waitlistQuickFilter = 'pending';
  document.querySelectorAll('.waitlist-filter').forEach(btn => btn.classList.remove('active'));
  document.getElementById('quickFilterPending').classList.add('active');
  waitlistPaginationState.currentPage = 1;
  renderWaitlist();
};

document.getElementById('quickFilterInvited').onclick = () => {
  waitlistQuickFilter = 'invited';
  document.querySelectorAll('.waitlist-filter').forEach(btn => btn.classList.remove('active'));
  document.getElementById('quickFilterInvited').classList.add('active');
  waitlistPaginationState.currentPage = 1;
  renderWaitlist();
};

document.getElementById('quickFilterRejected').onclick = () => {
  waitlistQuickFilter = 'rejected';
  document.querySelectorAll('.waitlist-filter').forEach(btn => btn.classList.remove('active'));
  document.getElementById('quickFilterRejected').classList.add('active');
  waitlistPaginationState.currentPage = 1;
  renderWaitlist();
};

document.getElementById('quickFilterAllWaitlist').onclick = () => {
  waitlistQuickFilter = 'all';
  document.querySelectorAll('.waitlist-filter').forEach(btn => btn.classList.remove('active'));
  document.getElementById('quickFilterAllWaitlist').classList.add('active');
  waitlistPaginationState.currentPage = 1;
  renderWaitlist();
};

// Reject waitlist functionality
document.getElementById('rejectWaitlistBtn').onclick = async () => {
  const checkboxes = document.querySelectorAll('.waitlist-checkbox:checked');
  if (checkboxes.length === 0) {
    showToast('Please select at least one waitlist entry', 'warning');
    return;
  }

  const reason = prompt('Enter rejection reason (optional):');
  if (reason === null) return; // User cancelled

  if (!confirm(`Reject ${checkboxes.length} waitlist ${checkboxes.length === 1 ? 'entry' : 'entries'}?`)) return;

  const waitlist_ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));

  // Update locally (we'll create a backend endpoint later)
  waitlist_ids.forEach(id => {
    const entry = allWaitlistData.find(w => w.waitlist_id === id);
    if (entry) {
      entry.status = 'rejected';
      entry.rejected_at = new Date().toISOString();
      entry.rejection_reason = reason;
    }
  });

  showToast(`Rejected ${waitlist_ids.length} ${waitlist_ids.length === 1 ? 'entry' : 'entries'}`, 'success');
  updateWaitlistCounts();
  renderWaitlist();
};

</script>

<!-- Manage Access Modal -->
<div id="manageAccessModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 id="manageAccessTitle" class="modal-title">Manage Access</h3>
      <button class="modal-close" onclick="closeManageAccessModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-option" onclick="handleToggleAdminStatus()">
        <div id="statusActionTitle" class="modal-option-title">Disable Admin</div>
        <div id="statusActionDesc" class="modal-option-desc">Prevent this admin from logging in</div>
      </div>
      <div class="modal-option" onclick="openChangeAdminTypeModal()">
        <div class="modal-option-title">Change Admin Type</div>
        <div class="modal-option-desc">Modify access level and permissions</div>
      </div>
      <div class="modal-option" onclick="handleResetAdminPassword()">
        <div class="modal-option-title">Reset Password</div>
        <div class="modal-option-desc">Generate temporary password and email to admin</div>
      </div>
      <div class="modal-option" onclick="handleDeleteAdmin()">
        <div class="modal-option-title" style="color:#ef4444;">Delete Admin</div>
        <div class="modal-option-desc">Permanently remove this admin account</div>
      </div>
    </div>
  </div>
</div>

<!-- Change Admin Type Modal -->
<div id="changeAdminTypeModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Change Admin Type</h3>
      <button class="modal-close" onclick="closeChangeAdminTypeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p id="currentAdminType" style="margin-bottom:16px;color:var(--gray);font-size:0.9rem;">Current: Admin</p>
      <label for="newAdminType" style="display:block;margin-bottom:8px;font-weight:600;">Select New Admin Type:</label>
      <select id="newAdminType" style="width:100%;padding:10px;margin-bottom:16px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);">
        <option value="admin">Admin - Full Access</option>
        <option value="user_admin">User Admin - Waitlist and Users</option>
        <option value="subscriber_admin">Subscriber Admin - Waitlist, Users, Subscribers and Invites</option>
        <option value="vote_admin">Vote Admin - Vote Management</option>
      </select>
      <div style="display:flex;gap:12px;">
        <button onclick="handleChangeAdminType()" class="btn" style="flex:1;background:linear-gradient(135deg,#10b981 0%,#059669 100%);">Update Type</button>
        <button onclick="closeChangeAdminTypeModal()" class="btn" style="flex:1;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Create Invite Modal -->
<div id="createInviteModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Create Invite</h3>
      <button class="modal-close" onclick="closeCreateInviteModal()">&times;</button>
    </div>
    <div class="modal-body">
      <label for="customCode" style="display:block;margin-bottom:8px;font-weight:600;">Custom code (optional)</label>
      <input id="customCode" type="text" placeholder="Leave blank to auto-generate" style="width:100%;margin-bottom:12px;" />
      <label for="maxUses" style="display:block;margin-bottom:8px;font-weight:600;">Max uses</label>
      <input id="maxUses" type="number" min="1" value="1" style="width:100%;margin-bottom:12px;" />
      <label for="expiresAt" style="display:block;margin-bottom:8px;font-weight:600;">Expiration date & time (optional)</label>
      <input id="expiresAt" type="datetime-local" step="60" style="max-width:280px;margin-bottom:12px;" />
      <label style="display:flex;align-items:center;gap:8px;margin-bottom:16px;cursor:pointer;">
        <input id="autoApprove" type="checkbox" />
        <span>Auto-approve registrations</span>
      </label>
      <div style="display:flex;gap:12px;">
        <button id="createInviteBtn" class="btn" style="flex:1;background:linear-gradient(135deg,#10b981 0%,#059669 100%);">Create</button>
        <button onclick="closeCreateInviteModal()" class="btn" style="flex:1;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);">Cancel</button>
      </div>
      <div id="inviteMsg" style="margin-top:12px;"></div>
    </div>
  </div>
</div>

<!-- Add Admin User Modal -->
<div id="addAdminModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Add Admin User</h3>
      <button class="modal-close" onclick="closeAddAdminModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
        <div>
          <label for="adminFirstName" style="display:block;margin-bottom:8px;font-weight:600;">First Name</label>
          <input id="adminFirstName" type="text" placeholder="John" style="width:100%" />
        </div>
        <div>
          <label for="adminLastName" style="display:block;margin-bottom:8px;font-weight:600;">Last Name</label>
          <input id="adminLastName" type="text" placeholder="Doe" style="width:100%" />
        </div>
      </div>
      <div style="margin-bottom:12px;">
        <label for="adminEmail" style="display:block;margin-bottom:8px;font-weight:600;">Email</label>
        <input id="adminEmail" type="email" placeholder="admin@example.com" style="width:100%;" />
      </div>
      <div style="margin-bottom:16px;">
        <label for="adminType" style="display:block;margin-bottom:8px;font-weight:600;">Admin Type</label>
        <select id="adminType" style="width:100%;padding:8px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);">
          <option value="admin">Admin - Full Access</option>
          <option value="user_admin">User Admin - Waitlist and Users</option>
          <option value="subscriber_admin">Subscriber Admin - Waitlist, Users, Subscribers and Invites</option>
          <option value="vote_admin">Vote Admin - Vote Management</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;">
        <button id="addAdminBtn" class="btn" style="flex:1;background:linear-gradient(135deg,#10b981 0%,#059669 100%);">Create Admin</button>
        <button onclick="closeAddAdminModal()" class="btn" style="flex:1;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);">Cancel</button>
      </div>
      <div id="adminMsg" style="margin-top:12px;"></div>
    </div>
  </div>
</div>

<!-- Create Subscription Type Modal -->
<div id="createSubscriptionTypeModal" class="modal-overlay">
  <div class="modal" style="max-width:600px;">
    <div class="modal-header">
      <h3 class="modal-title">Create Subscription Type</h3>
      <button class="modal-close" onclick="closeCreateSubscriptionTypeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:12px;">
        <label for="subTypeName" style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">Name</label>
        <input type="text" id="subTypeName" style="width:100%;padding:8px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);" placeholder="e.g., Monthly, Annual, Lifetime" />
      </div>
      <div style="margin-bottom:12px;">
        <label for="subTypeDescription" style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">Description</label>
        <textarea id="subTypeDescription" rows="2" style="width:100%;padding:8px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);resize:vertical;" placeholder="Brief description"></textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
        <div>
          <label for="subTermValue" style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">Duration</label>
          <input type="number" id="subTermValue" min="1" style="width:100%;padding:8px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);" placeholder="1" />
        </div>
        <div>
          <label for="subTermUnit" style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">Unit</label>
          <select id="subTermUnit" style="width:100%;padding:8px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);">
            <option value="days">Days</option>
            <option value="months" selected>Months</option>
            <option value="years">Years</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="subTypeFree" style="width:16px;height:16px;" />
          <span style="font-weight:600;font-size:0.9rem;">Free (no payment required)</span>
        </label>
      </div>
      <div id="pricingFields" style="display:grid;grid-template-columns:100px 1fr;gap:12px;margin-bottom:12px;">
        <div>
          <label for="subTypeCurrency" style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">Currency</label>
          <select id="subTypeCurrency" style="width:100%;padding:8px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);">
            <option value="USD" selected>USD ($)</option>
            <option value="EUR">EUR (â‚¬)</option>
            <option value="GBP">GBP (Â£)</option>
          </select>
        </div>
        <div>
          <label for="subTypePrice" style="display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;">Price</label>
          <input type="number" id="subTypePrice" min="0" step="0.01" style="width:100%;padding:8px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);" placeholder="10.00" />
        </div>
      </div>
      <div style="margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="subTypeOneTime" style="width:16px;height:16px;" />
          <span style="font-weight:600;font-size:0.9rem;">One-Time Offer</span>
        </label>
      </div>
      <div style="margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="subTypeEnabled" checked style="width:16px;height:16px;" />
          <span style="font-weight:600;font-size:0.9rem;">Enable Immediately</span>
        </label>
      </div>
      <div style="display:flex;gap:12px;">
        <button id="createSubscriptionTypeBtn" class="btn" style="flex:1;background:linear-gradient(135deg,#10b981 0%,#059669 100%);">Create</button>
        <button onclick="closeCreateSubscriptionTypeModal()" class="btn" style="flex:1;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);">Cancel</button>
      </div>
      <div id="subscriptionTypeMsg" style="margin-top:12px;"></div>
    </div>
  </div>
</div>

<!-- Create Terms Modal -->
<div id="createTermsModal" class="modal-overlay">
  <div class="modal" style="max-width:700px;">
    <div class="modal-header">
      <h3 class="modal-title">Create New Terms</h3>
      <button class="modal-close" onclick="closeCreateTermsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:16px;">
        <label for="newTermsText" style="display:block;margin-bottom:8px;font-weight:600;">New Terms Text</label>
        <textarea id="newTermsText" rows="12" style="width:100%;padding:12px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);font-family:monospace;font-size:0.9rem;resize:vertical;" placeholder="Paste your membership terms of service here..."></textarea>
      </div>
      <div style="display:flex;gap:12px;">
        <button id="createTermsBtn" class="btn" style="flex:1;background:linear-gradient(135deg,#10b981 0%,#059669 100%);">Create New Version</button>
        <button onclick="closeCreateTermsModal()" class="btn" style="flex:1;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);">Cancel</button>
      </div>
      <div id="termsMsg" style="margin-top:12px;"></div>
    </div>
  </div>
</div>

<!-- Create Proposal Modal -->
<div id="createProposalModal" class="modal-overlay">
  <div class="modal" style="max-width:600px;">
    <div class="modal-header">
      <h3 class="modal-title">Create New Proposal</h3>
      <button class="modal-close" onclick="closeCreateProposalModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:16px;">
        <label for="proposalTitle" style="display:block;margin-bottom:8px;font-weight:600;">Proposal Title</label>
        <input type="text" id="proposalTitle" style="width:100%;padding:10px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);" placeholder="Enter a short title for this proposal" />
      </div>
      <div style="margin-bottom:16px;">
        <label for="proposalText" style="display:block;margin-bottom:8px;font-weight:600;">Proposal Text</label>
        <textarea id="proposalText" rows="6" style="width:100%;padding:12px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);resize:vertical;" placeholder="Enter the proposal text here..."></textarea>
      </div>
      <div style="margin-bottom:16px;">
        <div style="margin-bottom:16px;">
          <label for="proposalOpenDate" style="display:block;margin-bottom:8px;font-weight:600;">Opening Date & Time</label>
          <input type="datetime-local" id="proposalOpenDate" step="60" style="max-width:280px;padding:10px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);" />
        </div>
        <div>
          <label for="proposalCloseDate" style="display:block;margin-bottom:8px;font-weight:600;">Closing Date & Time</label>
          <input type="datetime-local" id="proposalCloseDate" step="60" style="max-width:280px;padding:10px;border-radius:4px;border:1px solid var(--border);background:#050505;color:var(--text);" />
        </div>
      </div>
      <div style="display:flex;gap:12px;">
        <button id="createProposalBtn" class="btn" style="flex:1;background:linear-gradient(135deg,#10b981 0%,#059669 100%);">Create Proposal</button>
        <button onclick="closeCreateProposalModal()" class="btn" style="flex:1;background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);">Cancel</button>
      </div>
      <div id="proposalMsg" style="margin-top:12px;"></div>
    </div>
  </div>
</div>

</body>
</html>
