<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta http-equiv="X-Content-Type-Options" content="nosniff"/>
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin"/>
<title>VettID â€¢ Account</title>
<link rel="icon" type="image/jpeg" href="/assets/favicon.ico"/>
<link rel="stylesheet" href="/assets/styles.css"/>
<style>
    *{box-sizing:border-box;}
    body{display:flex;flex-direction:column;height:100vh;margin:0;overflow:hidden;}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-bottom:2px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,0.3);flex-shrink:0;}
    .main-container{display:flex;flex:1;overflow:hidden;}
    .sidebar{width:220px;background:linear-gradient(180deg,#0f0f0f 0%,#050505 100%);border-right:2px solid #222;display:flex;flex-direction:column;overflow-y:auto;transition:width 0.3s ease;position:relative;flex-shrink:0;}
    .sidebar.collapsed{width:0;overflow:hidden;border-right:none;}
    .sidebar-toggle{position:fixed;top:50%;left:220px;transform:translateY(-50%);background:var(--accent);border:none;width:32px;height:48px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.3);color:#000;font-size:1.2rem;font-weight:bold;border-radius:0 4px 4px 0;z-index:1000;display:flex;align-items:center;justify-content:center;transition:left 0.3s ease;}
    .sidebar.collapsed ~ .sidebar-toggle{left:0;border-radius:4px 0 0 4px;}
    .wrap{padding:20px 32px;flex:1;overflow-y:auto;max-width:none;width:100%;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{padding:24px;background:#0a0a0a;border-radius:8px;border:2px solid var(--border);margin-bottom:20px;}
    .card.double-width{grid-column:span 2;}
    .tabs{display:flex;flex-direction:column;gap:0;padding:12px 0;}
    .tab{background:none;color:var(--gray);border:none;padding:14px 20px;cursor:pointer;transition:all .2s;border-left:3px solid transparent;text-align:left;font-weight:600;font-size:0.9rem;width:100%;}
    .tab:hover:not(.locked){color:var(--text);background:rgba(255,193,37,0.08)}
    .tab.active{color:var(--accent);border-left-color:var(--accent);background:rgba(255,193,37,0.12)}
    .tab-parent{position:relative;display:flex;justify-content:space-between;align-items:center;}
    .tab-parent .tab-text{flex:1;}
    .tab-parent .tab-chevron{transition:transform 0.2s ease;font-size:0.8rem;margin-right:4px;}
    .tab-parent.expanded .tab-chevron{transform:rotate(90deg);}
    .tab-children{max-height:0;overflow:hidden;transition:max-height 0.3s ease;background:rgba(0,0,0,0.3);}
    .tab-children.expanded{max-height:500px;}
    .tab-child{padding-left:36px;font-size:0.85rem;min-height:44px;display:flex;align-items:center;}
    .tab-child:hover{background:rgba(255,193,37,0.06);}
    .tab-child.active{color:var(--accent);border-left-color:var(--accent);background:rgba(255,193,37,0.1);}
    .sub-tab-content{display:none;}
    .sub-tab-content.active{display:block;}
    .tab.locked{opacity:0.5;cursor:not-allowed;position:relative}
    .tab.locked::after{content:'ðŸ”’';margin-left:6px;font-size:0.7rem}
    .sidebar-badge{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 5px;margin-left:8px;background:#ef4444;color:#fff;font-size:0.7rem;font-weight:700;border-radius:9px;line-height:1;}
    .sidebar-badge.pulse{animation:badgePulse 2s infinite;}
    @keyframes badgePulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4);}50%{box-shadow:0 0 0 6px rgba(239,68,68,0);}}
    .tab.locked::before{content:attr(data-tooltip);position:absolute;left:100%;top:50%;transform:translateY(-50%);margin-left:12px;padding:8px 12px;background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);color:var(--text);border:2px solid var(--accent);border-radius:6px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s;font-size:0.85rem;font-weight:600;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
    .tab.locked:hover::before{opacity:1;}
    .tab-content{display:none;height:100%;width:100%;}
    .tab-content.active{display:block;width:100%;}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    /* Toggle Switch Styles */
    .toggle-switch{position:relative;display:inline-block;width:50px;height:24px;}
    .toggle-switch input{opacity:0;width:0;height:0;}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#4b5563;transition:.3s;border-radius:24px;}
    .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;transition:.3s;border-radius:50%;}
    input:checked+.toggle-slider{background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);}
    input:checked+.toggle-slider:before{transform:translateX(26px);}
    input:disabled+.toggle-slider{opacity:0.5;cursor:not-allowed;}
    .skeleton{background:linear-gradient(90deg,#0a0a0a 25%,#1a1a1a 50%,#0a0a0a 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;}
    @keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}

    /* Tooltip Styles */
    .tooltip{position:relative;}
    .tooltip::before{content:attr(data-tooltip);position:absolute;left:100%;top:50%;transform:translateY(-50%);margin-left:12px;padding:8px 12px;background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);color:var(--text);border:2px solid var(--accent);border-radius:6px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s;font-size:0.85rem;font-weight:600;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
    .tooltip::after{content:'';position:absolute;left:100%;top:50%;transform:translateY(-50%);margin-left:6px;border:6px solid transparent;border-right-color:var(--accent);opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:1000;}
    .tooltip:hover::before,.tooltip:hover::after{opacity:1;}

    /* Mobile menu button - hidden on desktop */
    .mobile-menu-btn{display:none;align-items:center;justify-content:center;background:none;border:none;color:var(--accent);font-size:1.5rem;cursor:pointer;padding:8px;margin-right:8px;}
    .sidebar-overlay{display:none;}

    @media (max-width: 768px){
      .grid{grid-template-columns:1fr}
      .main-container{flex-direction:row;}
      .sidebar{position:fixed;left:0;top:0;bottom:0;width:260px;z-index:999;transform:translateX(-100%);transition:transform 0.3s ease;border-right:2px solid #222;padding-top:70px;}
      .sidebar.mobile-open{transform:translateX(0);}
      .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:998;}
      .sidebar-overlay.visible{display:block;}
      .sidebar-toggle{display:none;}
      .mobile-menu-btn{display:flex !important;}
      .tabs{flex-direction:column;flex-wrap:nowrap;}
      .tab{width:100%;font-size:0.95rem;padding:16px 20px;border-left:3px solid transparent;border-bottom:none;}
      .tab.active{border-left-color:var(--accent);border-bottom-color:transparent;}
      .tab-child{min-height:48px;padding:16px 20px 16px 40px;}
      .tab-parent{min-height:48px;padding:16px 20px;}
      .tab-children.expanded{max-height:500px;}
      header{flex-direction:row;gap:8px;padding:12px 16px;}
      header h1{font-size:1.1rem;}
      header .btn{padding:8px 12px;font-size:0.85rem;}
      #userEmail{font-size:0.85rem;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
      .wrap{padding:16px;}

      /* Mobile Modal Improvements */
      #proposalResultsModal > div,
      #pinDisableModal > div {
        width: 95% !important;
        max-width: 95% !important;
        max-height: 85vh !important;
        transform: translate(-50%, -50%) !important;
      }

      #proposalResultsModal > div > div:first-child,
      #pinDisableModal > div > div:first-child {
        padding: 16px !important;
      }

      #proposalResultsModal > div > div:nth-child(2),
      #pinDisableModal > div > div:nth-child(2) {
        padding: 16px !important;
      }

      #proposalResultsModal > div > div:last-child,
      #pinDisableModal > div > div:last-child {
        padding: 12px 16px !important;
        flex-direction: column;
      }

      #proposalResultsModal > div > div:last-child button,
      #pinDisableModal > div > div:last-child button {
        width: 100%;
        padding: 14px 24px !important;
        font-size: 1rem;
        min-height: 48px;
      }

      #pinDisableInput {
        font-size: 16px !important;
        padding: 14px !important;
        min-height: 48px;
      }

      #proposalResultsModal h3,
      #pinDisableModal h3 {
        font-size: 1.1rem !important;
      }

      #proposalResultsModal button[onclick="closeProposalResultsModal()"],
      #pinDisableModal button[onclick="closePinDisableModal()"] {
        font-size: 1.8rem !important;
        width: 40px !important;
        height: 40px !important;
      }
    }

    /* User dropdown styles */
    .user-dropdown{position:relative;display:inline-block;}
    .user-dropdown-btn{cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:6px;transition:background 0.2s;}
    .user-dropdown-btn:hover{background:rgba(255,193,37,0.1);}
    .user-dropdown-menu{display:none;position:absolute;top:100%;right:0;margin-top:8px;background:#1a1a1a;border:2px solid var(--accent);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.4);min-width:200px;z-index:1000;}
    .user-dropdown-menu.active{display:block;}
    .user-dropdown-item{display:block;width:100%;padding:12px 16px;cursor:pointer;transition:background 0.2s;border-bottom:1px solid #333;color:var(--text);font-size:0.9rem;}
    .user-dropdown-item:last-child{border-bottom:none;}
    .user-dropdown-item:hover{background:rgba(255,193,37,0.1);}

    /* Light theme CSS variables */
    [data-theme="light"] {
      --bg-body: #f5f5f5;
      --bg-input: #f9fafb;
      --bg-card: #ffffff;
      --bg-hover: #f3f4f6;
      --bg-tertiary: #e5e7eb;
      --bg-progress: #d1d5db;
      --bg-error-bg: #fee2e2;
      --bg-button-secondary: #e5e7eb;
      --bg-button-disabled: #d1d5db;
      --bg-logs: #f3f4f6;
      --bg-divider: #d1d5db;
      --bg-skeleton: linear-gradient(90deg,#e5e7eb 25%,#f3f4f6 50%,#e5e7eb 75%);
      --text-primary: #1f2937;
      --text-secondary: #4b5563;
      --border-color: #d1d5db;
    }
    [data-theme="light"] body { background: var(--bg-body); color: var(--text-primary); }
    [data-theme="light"] .card { background: var(--bg-card); border-color: var(--border-color); color: var(--text-primary); }
    [data-theme="light"] .tab { color: var(--text-secondary); }
    [data-theme="light"] .tab:hover:not(.locked) { background: rgba(0,0,0,0.05); color: var(--text-primary); }
    [data-theme="light"] .tab.active { color: var(--accent); background: rgba(255,193,37,0.15); }
    [data-theme="light"] .tab-children { background: rgba(0,0,0,0.03); }
    [data-theme="light"] .tab-child:hover { background: rgba(0,0,0,0.05); }
    [data-theme="light"] .wrap { background: var(--bg-body); }
    [data-theme="light"] h1, [data-theme="light"] h2, [data-theme="light"] h3, [data-theme="light"] h4 { color: var(--text-primary); }
    [data-theme="light"] p, [data-theme="light"] span, [data-theme="light"] label { color: var(--text-secondary); }
    [data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea { background: var(--bg-input); color: var(--text-primary); border-color: var(--border-color); }
    [data-theme="light"] .skeleton { background: var(--bg-skeleton); background-size: 200% 100%; }
    [data-theme="light"] .toggle-slider { background: #9ca3af; }
    [data-theme="light"] .sidebar-toggle { background: var(--accent); color: #000; border-color: var(--border-color); }
    [data-theme="light"] .mobile-menu-btn { color: var(--accent); }

    /* Theme toggle button styles */
    .theme-toggle{background:none;border:2px solid var(--accent);border-radius:50%;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:all 0.2s;color:var(--accent);}
    .theme-toggle:hover{background:rgba(255,193,37,0.15);}

    /* Comprehensive light theme overrides */
    [data-theme="light"] header { background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); border-bottom-color: #d4a012; }
    [data-theme="light"] header h1 { color: var(--text-primary); }
    [data-theme="light"] .sidebar { background: linear-gradient(180deg, #ffffff 0%, #f5f5f5 100%); border-right-color: var(--border-color); }
    [data-theme="light"] .tab-children { background: rgba(0,0,0,0.02); }
    [data-theme="light"] .user-dropdown-menu { background: #ffffff; border-color: #d4a012; box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
    [data-theme="light"] .user-dropdown-item { color: var(--text-primary); border-bottom-color: var(--border-color); }
    [data-theme="light"] .user-dropdown-item:hover { background: rgba(212,160,18,0.1); }
    [data-theme="light"] .user-dropdown-btn span { color: #b8860b !important; }
    [data-theme="light"] #userEmail { color: #b8860b !important; }
    [data-theme="light"] code { background: #e5e7eb; color: var(--text-primary); }

    /* Light theme data boxes and tiles */
    [data-theme="light"] #overallProgress { background: var(--bg-card) !important; border-color: var(--border-color) !important; }
    [data-theme="light"] #overallProgress > div:last-child { background: #e5e7eb !important; }
    [data-theme="light"] #gettingStartedSteps > div { background: var(--bg-card) !important; border-color: var(--border-color) !important; }
    [data-theme="light"] #membershipStatusBox { background: var(--bg-card) !important; border: 1px solid var(--border-color); }
    [data-theme="light"] #profileSubscriptionStatus { background: var(--bg-card) !important; border: 1px solid var(--border-color); }
    [data-theme="light"] #pinStatusBox { background: var(--bg-card) !important; border: 1px solid var(--border-color); }
    [data-theme="light"] #emailPrefsBox { background: var(--bg-card) !important; border: 1px solid var(--border-color); }
    [data-theme="light"] #termsTextBox { background: var(--bg-card) !important; border-color: var(--border-color) !important; }
    [data-theme="light"] #membershipTermsSection div[style*="background:#0f0f0f"] { background: var(--bg-hover) !important; border-color: var(--border-color) !important; }
    [data-theme="light"] #memberInfoSection div[style*="background:#0a0a0a"] { background: var(--bg-card) !important; border-color: var(--border-color) !important; }

    /* Subscription options light theme */
    [data-theme="light"] #subscriptionOptionsSection div[style*="background:#050505"] { background: var(--bg-card) !important; border-color: var(--border-color) !important; }

    /* Vault services coming soon tiles */
    [data-theme="light"] #vault-deploy div[style*="background:#050505"],
    [data-theme="light"] #vault-byov div[style*="background:#050505"],
    [data-theme="light"] #vault-backup div[style*="background:#050505"] { background: var(--bg-hover) !important; border-color: var(--border-color) !important; }

    /* Voting tab light theme */
    [data-theme="light"] #proposalsContainer > div { background: var(--bg-card) !important; border-color: var(--border-color) !important; }

    /* Modal light theme */
    [data-theme="light"] #enablePinModal > div,
    [data-theme="light"] #updatePinModal > div,
    [data-theme="light"] #pinDisableModal > div > div,
    [data-theme="light"] #confirmModal > div > div,
    [data-theme="light"] #alertModal > div > div,
    [data-theme="light"] #membershipConfirmModal > div > div,
    [data-theme="light"] #proposalResultsModal > div > div { background: var(--bg-card) !important; }
    [data-theme="light"] #enablePinModal input,
    [data-theme="light"] #updatePinModal input,
    [data-theme="light"] #pinDisableModal input { background: var(--bg-input) !important; color: var(--text-primary) !important; border-color: var(--border-color) !important; }

    /* Sidebar active state in light theme - make it more visible */
    [data-theme="light"] .tab.active { color: #b8860b; background: rgba(212,160,18,0.15); border-left-color: #d4a012; }
    [data-theme="light"] .tab-child.active { color: #b8860b; background: rgba(212,160,18,0.12); border-left-color: #d4a012; }
    [data-theme="light"] .tab:hover:not(.locked) { color: var(--text-primary); background: rgba(212,160,18,0.08); }
    [data-theme="light"] .tab-child:hover { background: rgba(212,160,18,0.06); }
  </style>
</head>
<body>
<header>
<div style="display:flex;align-items:center;gap:12px;">
  <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Open menu">&#9776;</button>
  <img alt="VettID logo" src="/assets/logo.jpg" style="height:36px;width:36px;border-radius:6px;"/>
  <h1>Account</h1>
</div>
<div id="userDropdownContainer" class="user-dropdown" style="display:none;">
  <div class="user-dropdown-btn">
    <span id="userEmail" style="color:var(--accent);font-weight:600;"></span>
    <span style="font-size:0.7rem;">&#9660;</span>
  </div>
  <div id="userDropdownMenu" class="user-dropdown-menu">
    <div class="user-dropdown-item" id="themeToggle" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
      <span>Theme</span>
      <span id="themeIcon" style="font-size:1.1rem;">&#9728;&#65039;</span>
    </div>
    <div class="user-dropdown-item" id="signout">Sign Out</div>
  </div>
</div>
</header>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="main-container">
  <div class="sidebar" id="sidebar">
    <div class="tabs">
      <button class="tab active" data-tab="getting-started">Getting Started</button>
      <button class="tab tab-parent" id="accountParent" data-tab="account">
        <span class="tab-text">Account</span>
        <span class="tab-chevron">&#9656;</span>
      </button>
      <div class="tab-children" id="accountChildren">
        <button class="tab tab-child" data-tab="account" data-sub-tab="profile">Profile</button>
        <button class="tab tab-child" data-tab="account" data-sub-tab="membership">Membership</button>
        <button class="tab tab-child" data-tab="account" data-sub-tab="pin-code">PIN Code</button>
        <button class="tab tab-child" data-tab="account" data-sub-tab="email-prefs">Email Preferences</button>
        <button class="tab tab-child" data-tab="account" data-sub-tab="account-actions">Account Actions</button>
      </div>
      <button class="tab" data-tab="subscription" style="display:none;">Subscription</button>
      <button class="tab" data-tab="voting" style="display:none;">Voting<span id="votingBadge" class="sidebar-badge pulse" style="display:none;"></span></button>
      <button class="tab tab-parent" id="vaultParent" data-tab="deploy-vault" style="display:none;">
        <span class="tab-text">Vault Services</span>
        <span class="tab-chevron">&#9656;</span>
      </button>
      <div class="tab-children" id="vaultChildren">
        <button class="tab tab-child" data-tab="deploy-vault" data-sub-tab="deploy">Deploy a Vault</button>
        <button class="tab tab-child" data-tab="deploy-vault" data-sub-tab="byov">Bring Your Own Vault</button>
        <button class="tab tab-child" data-tab="deploy-vault" data-sub-tab="backup">Backup Services</button>
      </div>
    </div>
  </div>
  <button class="sidebar-toggle" id="sidebarToggle">&lt;</button>

  <div class="wrap">

<div id="getting-started" class="tab-content card active">
  <h3>Getting Started with VettID</h3>
  <p style="margin-bottom:16px;">Follow these steps to set up your VettID account and start using our secure services.</p>

  <!-- Overall Progress Bar -->
  <div id="overallProgress" style="margin-bottom:24px;padding:16px;background:#0a0a0a;border-radius:8px;border:2px solid var(--border);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <span style="font-weight:600;font-size:0.9rem;">Overall Progress</span>
      <span id="progressText" style="font-weight:600;font-size:0.9rem;color:var(--accent);">Loading...</span>
    </div>
    <div style="background:#1a1a1a;border-radius:8px;height:12px;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);">
      <div id="progressBar" style="background:linear-gradient(90deg,var(--accent) 0%,#ffc125 100%);height:100%;width:0%;transition:width 0.5s ease;box-shadow:0 0 10px rgba(255,193,37,0.5);"></div>
    </div>
  </div>

  <div id="gettingStartedSteps" style="display:flex;flex-direction:column;gap:16px;margin-bottom:24px;">
    <!-- Loading indicator shown initially -->
    <div style="padding:40px;background:#0a0a0a;border-radius:8px;border:2px solid var(--border);text-align:center;">
      <div style="display:inline-block;width:40px;height:40px;border:3px solid rgba(255,193,37,0.1);border-top:3px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;"></div>
      <p style="margin-top:16px;color:var(--gray);font-size:1rem;">Loading your getting started steps...</p>
    </div>
  </div>

  <button id="gotItBtn" class="btn" style="background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);color:#fff;padding:14px 24px;font-size:1rem;font-weight:600;">Got It!</button>
</div>

<div id="account" class="tab-content">
  <!-- Profile Sub-tab -->
  <div id="account-profile" class="sub-tab-content active">
    <div class="card">
      <h3>Your Profile</h3>
      <div>
        <p><strong>First name</strong><br/><span id="firstName">â€”</span></p>
        <p><strong>Last name</strong><br/><span id="lastName">â€”</span></p>
        <p><strong>Email</strong><br/><span id="email">â€”</span></p>
        <p><strong>User GUID</strong><br/><code id="userGuid">â€”</code></p>
      </div>

      <hr style="margin:20px 0;border:none;border-top:1px solid #222" />

      <h4 style="margin:0 0 12px;">Membership Status</h4>
      <div id="membershipStatusBox" style="padding:12px;background:#0a0a0a;border-radius:4px;margin-bottom:16px;">
        <p style="margin:0;"><strong>Status:</strong> <span id="membershipStatus">Loading...</span></p>
        <p id="membershipDetails" style="margin:8px 0 0;"></p>
      </div>

      <h4 style="margin:0 0 12px;">Subscription Status</h4>
      <div id="profileSubscriptionStatus" style="padding:12px;background:#0a0a0a;border-radius:4px;">
        <p style="margin:0;">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Membership Sub-tab -->
  <div id="account-membership" class="sub-tab-content">
    <div class="card" id="membershipCard">
      <h3>Membership</h3>
      <p style="margin-bottom:16px;">VettID is a cooperative dedicated to our member's online security and privacy. In order to become a member you must read and accept our membership terms. Members must have an active trial or subscription in order to use the service. Members with active subscriptions have voting rights in the cooperative. You may cancel a subscription and maintain your membership without service access or voting rights. If you wish to cancel your membership you must cancel the account you registered. Upon cancellation your account data will be held for 7 days and may be recovered by contacting <a href="mailto:restore@vettid.dev" style="color:var(--accent);text-decoration:underline;">restore@vettid.dev</a>. Cancelled accounts will be permanently deleted 7 days after cancellation.</p>

      <!-- Membership Terms Section (shown for non-members) -->
      <div id="membershipTermsSection" style="display:none;">
        <hr style="margin:20px 0;border:none;border-top:1px solid #222" />
        <h4 style="margin:0 0 12px;">Membership Terms of Service</h4>
        <p class="muted" style="font-size:0.9rem;margin-bottom:16px;">
          Please review and accept the membership terms to become a full member. You'll be granted immediate access after accepting.
        </p>

        <div id="termsTextBox" style="padding:16px;background:#0a0a0a;border-radius:4px;border:1px solid var(--border);max-height:400px;overflow-y:auto;margin-bottom:16px;">
          <p class="muted">Loading terms...</p>
        </div>

        <div style="margin-bottom:16px;">
          <a id="termsDownloadLink" href="#" target="_blank" class="btn" style="display:inline-block;">Download Membership Terms</a>
        </div>

        <div style="margin-bottom:16px;padding:12px;background:#0f0f0f;border-radius:4px;border:1px solid var(--border);">
          <label style="display:flex;align-items:start;cursor:pointer;">
            <input type="checkbox" id="acceptTermsCheckbox" style="margin-right:12px;margin-top:4px;">
            <span>I have read and agree to the VettID Membership Terms of Service</span>
          </label>
        </div>

        <button id="requestMembershipBtn" class="btn btn-primary" style="width:100%;opacity:0.5;" disabled onclick="requestMembership()">
          Accept Terms and Request Membership
        </button>
        <p id="requestMembershipMsg" style="margin-top:12px;font-size:0.9rem;"></p>
      </div>

      <!-- Member Details Section (shown for approved members) -->
      <div id="memberInfoSection" style="display:none;">
        <hr style="margin:20px 0;border:none;border-top:1px solid #222" />
        <h4 style="margin:0 0 12px;">Membership Details</h4>
        <div style="padding:16px;background:#0a0a0a;border-radius:4px;border:1px solid var(--border);margin-bottom:16px;">
          <p id="memberDetailsText"></p>
        </div>
        <div>
          <a id="memberTermsDownloadLink" href="#" target="_blank" class="btn" style="display:inline-block;">Download Membership Terms</a>
        </div>
      </div>
    </div>
  </div>

  <!-- PIN Code Sub-tab -->
  <div id="account-pin-code" class="sub-tab-content">
    <div class="card" id="pinCodeCard">
      <h3>PIN Code</h3>
      <p class="muted" style="font-size:0.9rem;margin-bottom:16px;">
        Add an extra layer of security to your account by requiring a 4-6 digit PIN code when logging in with magic links.
      </p>

      <div id="pinStatusBox" style="padding:16px;background:#0a0a0a;border-radius:4px;margin-bottom:16px;">
        <p><strong>Status:</strong> <span id="pinStatus">Loading...</span></p>
        <p id="pinUpdatedAt" style="margin-top:8px;"></p>
      </div>

      <div id="pinActions" style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn" id="enablePinBtn" style="display:none;background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);color:#fff;">Enable PIN</button>
        <button class="btn" id="updatePinBtn" style="display:none;">Change PIN</button>
        <button class="btn" id="disablePinBtn" style="display:none;background:linear-gradient(135deg,#d32f2f 0%,#a00 100%);color:#fff;">Disable PIN</button>
      </div>
    </div>
  </div>

  <!-- Email Preferences Sub-tab -->
  <div id="account-email-prefs" class="sub-tab-content">
    <div class="card">
      <h3>Email Preferences</h3>
      <p class="muted" style="font-size:0.9rem;margin-bottom:16px;">
        Control whether you receive system emails such as account notifications, security alerts, and service updates.
      </p>

      <div id="emailPrefsBox" style="padding:16px;background:#0a0a0a;border-radius:4px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong style="display:block;margin-bottom:4px;">System Emails</strong>
            <span id="emailPrefsStatus" class="muted" style="font-size:0.85rem;">Loading...</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="systemEmailsToggle" disabled>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Account Actions Sub-tab -->
  <div id="account-account-actions" class="sub-tab-content">
    <div class="card">
      <h3>Account Actions</h3>
      <button class="btn" id="cancelAccountBtn" style="background:linear-gradient(135deg,#d32f2f 0%,#a00 100%);color:#fff;box-shadow:0 4px 12px rgba(211,47,47,0.3);">Cancel account</button>
      <p class="muted" style="font-size:0.85rem;margin-top:8px;">Canceling your account will disable your access. Your data will be held for 7 days before being permanently deleted. If you would like to restore your account or immediately delete your data please contact <a href="mailto:restore@vettid.dev" style="color:#4fc3f7;text-decoration:none;">restore@vettid.dev</a>.</p>
    </div>
  </div>
</div>

<!-- PIN Modals -->
<div id="enablePinModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#1a1a1a;padding:32px;border-radius:8px;max-width:400px;width:90%;border:2px solid var(--accent);">
    <h3 style="margin-top:0;">Enable PIN Code</h3>
    <p class="muted" style="margin-bottom:20px;">Create a 4-6 digit PIN code for additional security.</p>
    <div>
      <label for="newPinInput" style="display:block;margin-bottom:8px;font-weight:600;">Enter PIN (4-6 digits)</label>
      <input type="password" id="newPinInput" maxlength="6" pattern="[0-9]*" inputmode="numeric"
             style="width:100%;padding:12px;background:#0a0a0a;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:1.1rem;letter-spacing:0.2em;text-align:center;"
             placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <label for="confirmPinInput" style="display:block;margin:16px 0 8px;font-weight:600;">Confirm PIN</label>
      <input type="password" id="confirmPinInput" maxlength="6" pattern="[0-9]*" inputmode="numeric"
             style="width:100%;padding:12px;background:#0a0a0a;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:1.1rem;letter-spacing:0.2em;text-align:center;"
             placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <div id="pinMatchIndicator" style="display:none;margin-top:8px;padding:8px 12px;border-radius:4px;font-size:0.9rem;display:flex;align-items:center;gap:8px;"></div>
    </div>
    <div style="display:flex;gap:12px;margin-top:24px;">
      <button class="btn" id="confirmEnablePinBtn" style="flex:1;background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);color:#fff;">Enable</button>
      <button class="btn" id="cancelEnablePinBtn" style="flex:1;">Cancel</button>
    </div>
  </div>
</div>

<div id="updatePinModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#1a1a1a;padding:32px;border-radius:8px;max-width:400px;width:90%;border:2px solid var(--accent);">
    <h3 style="margin-top:0;">Change PIN Code</h3>
    <p class="muted" style="margin-bottom:20px;">Enter your current PIN and new 4-6 digit PIN code.</p>
    <div>
      <label for="currentPinInput" style="display:block;margin-bottom:8px;font-weight:600;">Current PIN</label>
      <input type="password" id="currentPinInput" maxlength="6" pattern="[0-9]*" inputmode="numeric"
             style="width:100%;padding:12px;background:#0a0a0a;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:1.1rem;letter-spacing:0.2em;text-align:center;"
             placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <label for="updatePinInput" style="display:block;margin:16px 0 8px;font-weight:600;">New PIN (4-6 digits)</label>
      <input type="password" id="updatePinInput" maxlength="6" pattern="[0-9]*" inputmode="numeric"
             style="width:100%;padding:12px;background:#0a0a0a;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:1.1rem;letter-spacing:0.2em;text-align:center;"
             placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
      <label for="confirmUpdatePinInput" style="display:block;margin:16px 0 8px;font-weight:600;">Confirm New PIN</label>
      <input type="password" id="confirmUpdatePinInput" maxlength="6" pattern="[0-9]*" inputmode="numeric"
             style="width:100%;padding:12px;background:#0a0a0a;border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:1.1rem;letter-spacing:0.2em;text-align:center;"
             placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
    </div>
    <div style="display:flex;gap:12px;margin-top:24px;">
      <button class="btn" id="confirmUpdatePinBtn" style="flex:1;">Update PIN</button>
      <button class="btn" id="cancelUpdatePinBtn" style="flex:1;">Cancel</button>
    </div>
  </div>
</div>

<div id="subscription" class="tab-content">
  <div style="display:flex;flex-direction:column;gap:20px;max-width:800px;">
    <!-- Current Subscription Card -->
    <div class="card">
      <h3>Current Subscription</h3>
      <div id="currentSubscriptionDetails">
        <p class="muted">Loading subscription status...</p>
      </div>
      <p id="subscriptionMessage" style="display:none;margin-top:16px;padding:16px;border-radius:4px;"></p>
    </div>

    <!-- Change Subscription Card -->
    <div class="card">
      <h3>Change Subscription</h3>
      <p class="muted" style="font-size:0.9rem;margin-bottom:16px;">Select a subscription plan to activate or change your current subscription.</p>

      <div id="subscriptionOptionsSection">
        <p class="muted" style="text-align:center;">Loading subscription options...</p>
      </div>
    </div>
  </div>
</div>

<script>
// Theme management
function initTheme() {
  const savedTheme = localStorage.getItem('vettid-theme') || 'dark';
  const root = document.documentElement;
  const themeIcon = document.getElementById('themeIcon');
  if (savedTheme === 'light') {
    root.setAttribute('data-theme', 'light');
    if (themeIcon) themeIcon.innerHTML = '&#127769;'; // Moon
  } else {
    root.removeAttribute('data-theme');
    if (themeIcon) themeIcon.innerHTML = '&#9728;&#65039;'; // Sun
  }
}

function toggleTheme() {
  const root = document.documentElement;
  const themeIcon = document.getElementById('themeIcon');
  const currentTheme = root.getAttribute('data-theme');
  if (currentTheme === 'light') {
    root.removeAttribute('data-theme');
    localStorage.setItem('vettid-theme', 'dark');
    if (themeIcon) themeIcon.innerHTML = '&#9728;&#65039;'; // Sun
  } else {
    root.setAttribute('data-theme', 'light');
    localStorage.setItem('vettid-theme', 'light');
    if (themeIcon) themeIcon.innerHTML = '&#127769;'; // Moon
  }
}

// Initialize theme immediately
initTheme();

// Confirm Modal Functions
let confirmModalResolve = null;

function showConfirmModal(options = {}) {
  const modal = document.getElementById('confirmModal');
  const title = document.getElementById('confirmModalTitle');
  const message = document.getElementById('confirmModalMessage');
  const cancelBtn = document.getElementById('confirmModalCancel');
  const confirmBtn = document.getElementById('confirmModalConfirm');

  title.textContent = options.title || 'Confirm Action';
  message.innerHTML = options.message || 'Are you sure you want to proceed?';
  cancelBtn.textContent = options.cancelText || 'Cancel';
  confirmBtn.textContent = options.confirmText || 'Confirm';

  // Set button color based on type
  if (options.type === 'danger') {
    confirmBtn.style.background = 'linear-gradient(135deg,#f44336 0%,#c62828 100%)';
  } else if (options.type === 'warning') {
    confirmBtn.style.background = 'linear-gradient(135deg,#ff9800 0%,#f57c00 100%)';
  } else {
    confirmBtn.style.background = 'linear-gradient(135deg,var(--accent) 0%,#ffc125 100%)';
    confirmBtn.style.color = '#000';
  }

  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';

  return new Promise((resolve) => {
    confirmModalResolve = resolve;
  });
}

function closeConfirmModal(result) {
  const modal = document.getElementById('confirmModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
  if (confirmModalResolve) {
    confirmModalResolve(result);
    confirmModalResolve = null;
  }
}

// Alert Modal Functions (for success/error messages)
let alertModalResolve = null;

function showAlertModal(options = {}) {
  const modal = document.getElementById('alertModal');
  const title = document.getElementById('alertModalTitle');
  const message = document.getElementById('alertModalMessage');
  const okBtn = document.getElementById('alertModalOk');

  // Set icon and title based on type
  let icon = '';
  let titleColor = 'var(--accent)';
  let borderColor = 'var(--accent)';

  if (options.type === 'success') {
    icon = '<svg width="24" height="24" fill="none" stroke="#4caf50" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
    titleColor = '#4caf50';
    borderColor = '#4caf50';
  } else if (options.type === 'error') {
    icon = '<svg width="24" height="24" fill="none" stroke="#f44336" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>';
    titleColor = '#f44336';
    borderColor = '#f44336';
  } else if (options.type === 'warning') {
    icon = '<svg width="24" height="24" fill="none" stroke="#ff9800" stroke-width="2"><path d="M12 2L2 22h20L12 2z"/><path d="M12 9v4M12 17h.01"/></svg>';
    titleColor = '#ff9800';
    borderColor = '#ff9800';
  } else {
    icon = '<svg width="24" height="24" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>';
  }

  title.innerHTML = icon + '<span>' + (options.title || 'Notice') + '</span>';
  title.style.color = titleColor;
  message.innerHTML = options.message || '';
  okBtn.textContent = options.okText || 'OK';

  // Update border color
  modal.querySelector('div > div').style.borderColor = borderColor;

  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';

  return new Promise((resolve) => {
    alertModalResolve = resolve;
  });
}

function closeAlertModal() {
  const modal = document.getElementById('alertModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
  if (alertModalResolve) {
    alertModalResolve();
    alertModalResolve = null;
  }
}

// Setup confirm modal event listeners
document.addEventListener('DOMContentLoaded', () => {
  const cancelBtn = document.getElementById('confirmModalCancel');
  const confirmBtn = document.getElementById('confirmModalConfirm');
  const modal = document.getElementById('confirmModal');

  cancelBtn?.addEventListener('click', () => closeConfirmModal(false));
  confirmBtn?.addEventListener('click', () => closeConfirmModal(true));

  // Close on backdrop click
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeConfirmModal(false);
  });

  // Setup alert modal event listeners
  const alertOkBtn = document.getElementById('alertModalOk');
  const alertModal = document.getElementById('alertModal');

  alertOkBtn?.addEventListener('click', () => closeAlertModal());

  // Close on backdrop click
  alertModal?.addEventListener('click', (e) => {
    if (e.target === alertModal) closeAlertModal();
  });
});

// Subscription type state
let availableSubscriptionTypes = [];
let subscriptionStatus = null; // Global state for subscription status
let membershipStatus = null; // Global state for membership status

// Load subscription types
async function loadSubscriptionTypes() {
  const container = document.getElementById('subscriptionOptionsSection');

  try {
    const res = await fetch(API_URL + '/account/subscription-types', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + idToken() }
    });

    if (!res.ok) {
      container.innerHTML = '<p class="muted" style="text-align:center;">Unable to load subscription options. Please try again later.</p>';
      return;
    }

    const data = await res.json();
    let subscriptionTypes = data.subscription_types || [];

    if (subscriptionTypes.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;">No subscription options are currently available.</p>';
      return;
    }

    // Filter out one-time offers that have already been used
    // Check subscription status for used one-time offers
    if (subscriptionStatus?.has_used_trial) {
      subscriptionTypes = subscriptionTypes.filter(st => {
        // If it's a one-time offer and user has used trial, filter it out
        // Assuming free trials are marked as one-time offers
        if (st.is_one_time_offer && parseFloat(st.price) === 0) {
          return false;
        }
        return true;
      });
    }

    // Sort: one-time offers first, then by price (free first, then ascending)
    subscriptionTypes.sort((a, b) => {
      if (a.is_one_time_offer && !b.is_one_time_offer) return -1;
      if (!a.is_one_time_offer && b.is_one_time_offer) return 1;
      const priceA = parseFloat(a.price) || 0;
      const priceB = parseFloat(b.price) || 0;
      return priceA - priceB;
    });

    availableSubscriptionTypes = subscriptionTypes;

    if (subscriptionTypes.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;">No subscription options are currently available.</p>';
      return;
    }

    container.innerHTML = '<div style="display:flex;flex-direction:column;gap:16px;">' + subscriptionTypes.map((st, index) => {
      const isFree = parseFloat(st.price) === 0;
      const priceDisplay = isFree
        ? '<div style="font-size:2rem;font-weight:700;color:#10b981;">FREE</div>'
        : `<div style="font-size:2rem;font-weight:700;color:var(--text);">${st.currency} ${parseFloat(st.price).toFixed(2)}</div>`;

      // Handle pluralization - remove trailing 's' for singular, keep for plural
      let termUnit = st.term_unit;
      if (st.term_value === 1 && termUnit.endsWith('s')) {
        termUnit = termUnit.slice(0, -1); // Remove trailing 's' for singular
      }
      const termDisplay = `${st.term_value} ${termUnit}`;
      const isPopular = index === 0; // First one is popular
      const borderColor = isPopular ? 'var(--accent)' : '#333';
      const boxShadow = isPopular ? '0 0 20px rgba(255,193,37,0.2)' : 'none';

      // Brighter button colors for all subscribe buttons
      let buttonBg;
      let buttonColor;
      if (isFree) {
        buttonBg = 'linear-gradient(135deg,#4caf50 0%,#2e7d32 100%)';
        buttonColor = '#fff';
      } else if (isPopular) {
        buttonBg = 'linear-gradient(135deg,var(--accent) 0%,#ffc125 100%)';
        buttonColor = '#000';
      } else {
        buttonBg = 'linear-gradient(135deg,#2196f3 0%,#1976d2 100%)';
        buttonColor = '#fff';
      }

      return `
        <div style="padding:20px;background:#050505;border-radius:8px;border:2px solid ${borderColor};box-shadow:${boxShadow};transition:all 0.2s;position:relative;display:flex;align-items:center;justify-content:space-between;gap:20px;">
          ${isPopular ? '<div style="position:absolute;top:-12px;left:20px;background:var(--accent);color:#000;padding:4px 12px;border-radius:12px;font-size:0.7rem;font-weight:700;text-transform:uppercase;">Popular</div>' : ''}

          <div style="flex:1;">
            <h4 style="margin:0 0 4px;color:${isPopular ? 'var(--accent)' : 'var(--text)'};font-size:1.2rem;">${st.name}</h4>
            <p style="color:var(--gray);font-size:0.85rem;margin:0 0 8px;">${st.description}</p>
            ${st.is_one_time_offer ? '<span style="display:inline-block;background:#fbbf24;color:#000;padding:3px 10px;border-radius:8px;font-size:0.7rem;font-weight:700;text-transform:uppercase;">One-Time Offer</span>' : ''}
          </div>

          <div style="text-align:center;min-width:120px;">
            ${priceDisplay}
            <div style="color:var(--gray);font-size:0.8rem;margin-top:2px;">${termDisplay}</div>
          </div>

          <button class="btn subscription-btn" id="sub-btn-${st.subscription_type_id}" data-subscription-id="${st.subscription_type_id}" onclick="selectSubscriptionType('${st.subscription_type_id}')" style="background:${buttonBg};color:${buttonColor};padding:12px 24px;font-size:0.95rem;font-weight:700;white-space:nowrap;">
            ${isFree ? 'Start Free' : 'Subscribe'}
          </button>
        </div>
      `;
    }).join('') + '</div>';
  } catch (err) {
    console.error('Error loading subscription types:', err);
    container.innerHTML = '<p class="muted" style="text-align:center;color:#f44336;">Failed to load subscription options. Please try again later.</p>';
  }
}

// Select and subscribe to a subscription type
async function selectSubscriptionType(subscriptionTypeId) {
  const btn = document.getElementById('sub-btn-' + subscriptionTypeId);
  if (!btn) return;

  // Store original button content
  const originalContent = btn.innerHTML;
  const originalStyle = btn.style.cssText;

  // Disable all subscription buttons and show loading on clicked button
  const allButtons = document.querySelectorAll('.subscription-btn');
  allButtons.forEach(b => {
    b.disabled = true;
    b.style.opacity = '0.6';
    b.style.cursor = 'not-allowed';
  });

  // Show processing state on clicked button
  btn.innerHTML = 'Processing...';
  btn.style.opacity = '1';

  try {
    await createSubscription(subscriptionTypeId);
  } finally {
    // Re-enable all buttons
    allButtons.forEach(b => {
      b.disabled = false;
      b.style.opacity = '1';
      b.style.cursor = 'pointer';
    });

    // Restore original content if button still exists
    if (document.getElementById('sub-btn-' + subscriptionTypeId)) {
      btn.innerHTML = originalContent;
      btn.style.cssText = originalStyle;
    }
  }
}
</script>

<div id="deploy-vault" class="tab-content">
  <!-- Deploy a Vault Sub-tab -->
  <div id="vault-deploy" class="sub-tab-content active">
    <div class="card">
      <h3>Deploy a Vault</h3>
      <p class="muted" style="margin-bottom:20px;font-size:0.95rem;">Deploy an encrypted vault for storing API keys, deployment tokens, and other sensitive credentials needed for automated deployments.</p>

      <div style="margin-top:24px;padding:24px;background:#050505;border-radius:4px;border:1px solid #333;text-align:center;">
        <p style="color:var(--gray);font-size:1rem;">Coming soon</p>
        <p style="color:var(--gray);margin-top:8px;font-size:0.85rem;">Secure credential management</p>
      </div>
    </div>
  </div>

  <!-- Bring Your Own Vault Sub-tab -->
  <div id="vault-byov" class="sub-tab-content">
    <div class="card">
      <h3>Bring Your Own Vault</h3>
      <p class="muted" style="margin-bottom:20px;font-size:0.95rem;">Connect your existing Vaultwarden or Bitwarden instance to VettID for seamless integration with your current password management setup.</p>

      <div style="margin-top:24px;padding:24px;background:#050505;border-radius:4px;border:1px solid #333;text-align:center;">
        <p style="color:var(--gray);font-size:1rem;">Coming soon</p>
        <p style="color:var(--gray);margin-top:8px;font-size:0.85rem;">Self-hosted vault integration</p>
      </div>
    </div>
  </div>

  <!-- Backup Services Sub-tab -->
  <div id="vault-backup" class="sub-tab-content">
    <div class="card">
      <h3>Backup Services</h3>
      <p class="muted" style="margin-bottom:20px;font-size:0.95rem;">Automated backup services for your critical data. Schedule regular backups and restore your data when needed.</p>

      <div style="margin-top:24px;padding:24px;background:#050505;border-radius:4px;border:1px solid #333;text-align:center;">
        <p style="color:var(--gray);font-size:1rem;">Coming soon</p>
        <p style="color:var(--gray);margin-top:8px;font-size:0.85rem;">Automated backup solutions</p>
      </div>
    </div>
  </div>
</div>

<div id="voting" class="tab-content">
  <h3>Voting</h3>
  <p class="muted">Participate in VettID community voting and governance.</p>

  <!-- Filter Buttons -->
  <div style="display:flex;gap:12px;margin-top:24px;margin-bottom:20px;flex-wrap:wrap;">
    <button id="filterActiveProposals" class="btn proposal-filter active" data-filter="active" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:10px 20px;font-weight:600;">
      Active <span id="activeProposalsCount" style="background:#065f46;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
    </button>
    <button id="filterCompletedProposals" class="btn proposal-filter" data-filter="completed" style="background:linear-gradient(135deg,#6366f1 0%,#4f46e5 100%);padding:10px 20px;font-weight:600;">
      Completed <span id="completedProposalsCount" style="background:#4338ca;color:#fff;border-radius:12px;padding:2px 8px;margin-left:8px;font-size:0.75rem;">0</span>
    </button>
  </div>

  <!-- Single Container for All Proposals -->
  <div id="proposalsContainer" style="margin-top:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;">
    <p class="muted" style="grid-column:1/-1;">Loading proposals...</p>
  </div>
</div>

  </div><!-- end .wrap -->
</div><!-- end .main-container -->

<!-- Proposal Results Modal -->
<div id="proposalResultsModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:9999;backdrop-filter:blur(4px);">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-radius:12px;border:2px solid var(--accent);box-shadow:0 10px 40px rgba(255,193,37,0.3);max-width:600px;width:90%;max-height:90vh;overflow-y:auto;">
    <div style="padding:24px;border-bottom:2px solid #222;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;color:var(--accent);">Proposal Results</h3>
        <button onclick="closeProposalResultsModal()" style="background:none;border:none;color:var(--gray);font-size:1.5rem;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,193,37,0.1)';this.style.color='var(--accent)';" onmouseout="this.style.background='none';this.style.color='var(--gray)';">&times;</button>
      </div>
    </div>
    <div id="proposalResultsContent" style="padding:24px;">
      <p>Loading...</p>
    </div>
    <div style="padding:16px 24px;border-top:2px solid #222;text-align:right;">
      <button onclick="closeProposalResultsModal()" class="btn" style="padding:10px 24px;">Close</button>
    </div>
  </div>
</div>

<!-- PIN Disable Confirmation Modal -->
<div id="pinDisableModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:9999;backdrop-filter:blur(4px);">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-radius:12px;border:2px solid #ffc125;box-shadow:0 10px 40px rgba(255,193,37,0.3);max-width:500px;width:90%;">
    <div style="padding:24px;border-bottom:2px solid #222;">
      <h3 style="margin:0;color:#ffc125;">Disable PIN Authentication</h3>
    </div>
    <div style="padding:24px;">
      <p style="margin:0 0 20px 0;color:var(--gray);line-height:1.6;">Enter your current PIN to confirm disabling PIN authentication. You will only need your magic link to sign in after this.</p>
      <label style="display:block;margin-bottom:8px;color:var(--text);font-weight:600;">Current PIN</label>
      <input type="password" id="pinDisableInput" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Enter 4-6 digit PIN" style="width:100%;padding:12px;background:#0a0a0a;border:2px solid #222;border-radius:6px;color:var(--text);font-size:1rem;" />
      <p id="pinDisableError" style="margin:12px 0 0 0;color:#f44336;font-size:0.9rem;display:none;"></p>
    </div>
    <div style="padding:16px 24px;border-top:2px solid #222;display:flex;gap:12px;justify-content:flex-end;">
      <button onclick="closePinDisableModal()" class="btn" style="padding:10px 24px;background:#333;">Cancel</button>
      <button onclick="submitPinDisable()" class="btn" style="padding:10px 24px;background:linear-gradient(135deg,#f44336 0%,#c62828 100%);">Disable PIN</button>
    </div>
  </div>
</div>

<!-- PIN Verification on Login Modal -->
<div id="verifyPinLoginModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:10000;backdrop-filter:blur(8px);">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-radius:12px;border:2px solid #ffc125;box-shadow:0 10px 40px rgba(255,193,37,0.3);max-width:420px;width:90%;">
    <div style="padding:24px;border-bottom:2px solid #222;text-align:center;">
      <div style="width:64px;height:64px;margin:0 auto 16px;background:linear-gradient(135deg,#ffc125 0%,#ff9800 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
      </div>
      <h3 style="margin:0;color:#ffc125;font-size:1.3rem;">PIN Verification Required</h3>
    </div>
    <div style="padding:24px;">
      <p style="margin:0 0 20px 0;color:var(--gray);line-height:1.6;text-align:center;">Enter your PIN to access your account.</p>
      <label style="display:block;margin-bottom:8px;color:var(--text);font-weight:600;">PIN Code</label>
      <input type="password" id="verifyPinLoginInput" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Enter 4-6 digit PIN" style="width:100%;padding:14px;background:#0a0a0a;border:2px solid #222;border-radius:6px;color:var(--text);font-size:1.1rem;text-align:center;letter-spacing:0.3em;" />
      <p id="verifyPinLoginError" style="margin:12px 0 0 0;color:#f44336;font-size:0.9rem;display:none;text-align:center;"></p>
    </div>
    <div style="padding:16px 24px;border-top:2px solid #222;display:flex;gap:12px;justify-content:center;">
      <button onclick="submitPinVerification()" id="verifyPinLoginBtn" class="btn" style="padding:12px 48px;background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);font-weight:600;">Verify</button>
    </div>
    <div style="padding:0 24px 16px;text-align:center;">
      <a href="#" onclick="signOut();return false;" style="color:var(--gray);font-size:0.85rem;text-decoration:none;">Sign out and use a different account</a>
    </div>
  </div>
</div>

<!-- Generic Confirm Modal -->
<div id="confirmModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:9999;backdrop-filter:blur(4px);">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-radius:12px;border:2px solid #ffc125;box-shadow:0 10px 40px rgba(255,193,37,0.3);max-width:500px;width:90%;">
    <div style="padding:24px;border-bottom:2px solid #222;">
      <h3 id="confirmModalTitle" style="margin:0;color:#ffc125;">Confirm Action</h3>
    </div>
    <div style="padding:24px;">
      <p id="confirmModalMessage" style="margin:0;color:var(--gray);line-height:1.6;"></p>
    </div>
    <div style="padding:16px 24px;border-top:2px solid #222;display:flex;gap:12px;justify-content:flex-end;flex-wrap:wrap;">
      <button id="confirmModalCancel" class="btn" style="padding:10px 24px;background:#333;">Cancel</button>
      <button id="confirmModalConfirm" class="btn" style="padding:10px 24px;background:linear-gradient(135deg,#f44336 0%,#c62828 100%);">Confirm</button>
    </div>
  </div>
</div>

<!-- Alert Modal (for success/error messages) -->
<div id="alertModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:9999;backdrop-filter:blur(4px);">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-radius:12px;border:2px solid var(--accent);box-shadow:0 10px 40px rgba(255,193,37,0.3);max-width:450px;width:90%;">
    <div style="padding:24px;border-bottom:2px solid #222;">
      <h3 id="alertModalTitle" style="margin:0;color:var(--accent);display:flex;align-items:center;gap:10px;"></h3>
    </div>
    <div style="padding:24px;">
      <p id="alertModalMessage" style="margin:0;color:var(--gray);line-height:1.6;"></p>
    </div>
    <div style="padding:16px 24px;border-top:2px solid #222;display:flex;justify-content:flex-end;">
      <button id="alertModalOk" class="btn" style="padding:10px 32px;background:linear-gradient(135deg,var(--accent) 0%,#ffc125 100%);color:#000;">OK</button>
    </div>
  </div>
</div>

<!-- Membership Confirmation Modal -->
<div id="membershipConfirmModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:9999;backdrop-filter:blur(4px);">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-radius:12px;border:2px solid var(--accent);box-shadow:0 10px 40px rgba(255,193,37,0.3);max-width:550px;width:90%;">
    <div style="padding:24px;border-bottom:2px solid #222;">
      <h3 style="margin:0;color:var(--accent);display:flex;align-items:center;gap:12px;">
        <span style="font-size:1.5rem;">âœ“</span>
        Confirm Membership
      </h3>
    </div>
    <div style="padding:24px;">
      <p style="margin:0 0 16px 0;color:var(--text);line-height:1.6;font-size:1rem;">Accept membership terms and become a full member?</p>
      <p style="margin:0;padding:16px;background:rgba(255,193,37,0.1);border-left:4px solid var(--accent);border-radius:4px;color:var(--gray);line-height:1.6;font-size:0.9rem;">
        <strong style="color:var(--accent);">Important:</strong> You will need to sign in again after acceptance to activate your full membership privileges.
      </p>
    </div>
    <div style="padding:16px 24px;border-top:2px solid #222;display:flex;gap:12px;justify-content:flex-end;">
      <button onclick="closeMembershipConfirmModal()" class="btn" style="padding:12px 28px;background:#333;font-weight:600;">Cancel</button>
      <button onclick="confirmMembership()" class="btn" style="padding:12px 28px;background:linear-gradient(135deg,#ffd940 0%,#ffc125 100%);color:#000;font-weight:700;box-shadow:0 4px 14px rgba(255,217,64,0.4);">Accept & Continue</button>
    </div>
  </div>
</div>

<script src="/shared/config.js"></script>
<script>
// ====== CONFIG ======
// Load configuration from centralized config file
const API_URL = window.VettIDConfig.apiUrl;
// ====================

// ---- DOM Cache for Performance ----
const DOMCache = {};
function getElement(id) {
  if (!DOMCache[id]) {
    DOMCache[id] = document.getElementById(id);
  }
  return DOMCache[id];
}

// ---- Token storage ----
function loadTokens() {
  try { return JSON.parse(localStorage.getItem('tokens') || 'null'); } catch { return null; }
}
function clearTokens() { localStorage.removeItem('tokens'); localStorage.removeItem('authEmail'); }
function idToken() { return (loadTokens() || {}).id_token; }
function signedIn() { return !!idToken(); }

// ---- Toast Notifications ----
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  const bgColor = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : type === 'warning' ? '#ff9800' : '#2196f3';
  toast.style.cssText = `position:fixed;top:20px;right:20px;padding:16px 24px;background:${bgColor};color:#fff;border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,0.5);z-index:9999;animation:slideIn 0.3s;max-width:400px;word-wrap:break-word;`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// ---- Proposal Results Modal ----
function showProposalResultsModal(htmlContent) {
  const modal = getElement('proposalResultsModal');
  const content = getElement('proposalResultsContent');
  content.innerHTML = htmlContent;
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeProposalResultsModal() {
  const modal = getElement('proposalResultsModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

// Close modal on overlay click
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('proposalResultsModal');
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeProposalResultsModal();
  });

  // Close modal on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (modal?.style.display === 'block') {
        closeProposalResultsModal();
      }
      const pinModal = document.getElementById('pinDisableModal');
      if (pinModal?.style.display === 'block') {
        closePinDisableModal();
      }
      // Close mobile sidebar on Escape
      closeMobileSidebar();
    }
  });

  // Mobile sidebar toggle
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');

  function openMobileSidebar() {
    sidebar?.classList.add('mobile-open');
    sidebarOverlay?.classList.add('visible');
    document.body.style.overflow = 'hidden';
  }

  function closeMobileSidebar() {
    sidebar?.classList.remove('mobile-open');
    sidebarOverlay?.classList.remove('visible');
    document.body.style.overflow = '';
  }

  mobileMenuBtn?.addEventListener('click', () => {
    if (sidebar?.classList.contains('mobile-open')) {
      closeMobileSidebar();
    } else {
      openMobileSidebar();
    }
  });

  sidebarOverlay?.addEventListener('click', closeMobileSidebar);

  // Theme toggle
  const themeToggle = document.getElementById('themeToggle');
  themeToggle?.addEventListener('click', toggleTheme);

  // Close sidebar when a tab is clicked on mobile
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        closeMobileSidebar();
      }
    });
  });
});

// ---- PIN Disable Modal ----
function showPinDisableModal() {
  const modal = getElement('pinDisableModal');
  const input = getElement('pinDisableInput');
  const error = getElement('pinDisableError');

  input.value = '';
  error.style.display = 'none';
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';

  // Focus input after modal opens
  setTimeout(() => input.focus(), 100);
}

function closePinDisableModal() {
  const modal = getElement('pinDisableModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

async function submitPinDisable() {
  const input = getElement('pinDisableInput');
  const error = getElement('pinDisableError');
  const pin = input.value.trim();

  // Validate PIN format
  if (!/^\d{4,6}$/.test(pin)) {
    error.textContent = 'PIN must be 4-6 digits';
    error.style.display = 'block';
    return;
  }

  error.style.display = 'none';

  // Call the actual disable function with the PIN
  closePinDisableModal();
  await executePinDisable(pin);
}

// ---- PIN Verification on Login ----
// Session-based PIN verification - user must verify PIN once per browser session when PIN is enabled
function isPinVerifiedForSession() {
  return sessionStorage.getItem('pinVerified') === 'true';
}

function markPinVerifiedForSession() {
  sessionStorage.setItem('pinVerified', 'true');
}

function clearPinVerificationForSession() {
  sessionStorage.removeItem('pinVerified');
}

// Check if PIN verification is required and show modal if needed
// Returns: true if PIN verification is required (blocks load), false if can proceed
async function checkAndRequirePinVerification() {
  // If already verified this session, skip
  if (isPinVerifiedForSession()) {
    console.log('[PIN-LOGIN] PIN already verified this session');
    return false;
  }

  const token = idToken();
  if (!token) {
    console.log('[PIN-LOGIN] No token, skipping PIN check');
    return false;
  }

  try {
    console.log('[PIN-LOGIN] Checking PIN status...');
    const res = await fetch(API_URL + '/account/security/pin/status', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });

    // 404 = PIN not configured, no verification needed
    if (res.status === 404) {
      console.log('[PIN-LOGIN] PIN not configured, no verification needed');
      return false;
    }

    if (!res.ok) {
      console.error('[PIN-LOGIN] Error checking PIN status:', res.status);
      return false; // On error, allow access (fail open)
    }

    const data = await res.json();
    console.log('[PIN-LOGIN] PIN status:', data);

    if (data.pin_enabled) {
      // PIN is enabled, show verification modal
      console.log('[PIN-LOGIN] PIN is enabled, showing verification modal');
      showPinVerificationModal();
      return true; // Block load until PIN verified
    } else {
      console.log('[PIN-LOGIN] PIN is disabled, no verification needed');
      return false;
    }
  } catch (err) {
    console.error('[PIN-LOGIN] Error checking PIN status:', err);
    return false; // On error, allow access (fail open)
  }
}

function showPinVerificationModal() {
  const modal = document.getElementById('verifyPinLoginModal');
  const input = document.getElementById('verifyPinLoginInput');
  const error = document.getElementById('verifyPinLoginError');

  input.value = '';
  error.style.display = 'none';
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';

  // Focus input after modal opens
  setTimeout(() => input.focus(), 100);

  // Setup Enter key listener for convenience
  input.onkeydown = (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      submitPinVerification();
    }
  };
}

function hidePinVerificationModal() {
  const modal = document.getElementById('verifyPinLoginModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

async function submitPinVerification() {
  const input = document.getElementById('verifyPinLoginInput');
  const error = document.getElementById('verifyPinLoginError');
  const btn = document.getElementById('verifyPinLoginBtn');
  const pin = input.value.trim();

  // Validate PIN format
  if (!/^\d{4,6}$/.test(pin)) {
    error.textContent = 'PIN must be 4-6 digits';
    error.style.display = 'block';
    input.focus();
    return;
  }

  error.style.display = 'none';
  btn.disabled = true;
  btn.textContent = 'Verifying...';

  const token = idToken();
  if (!token) {
    error.textContent = 'Session expired. Please sign in again.';
    error.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Verify';
    return;
  }

  try {
    const res = await fetch(API_URL + '/account/security/pin/verify', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ pin })
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      error.textContent = errData.message || 'Failed to verify PIN. Please try again.';
      error.style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'Verify';
      input.value = '';
      input.focus();
      return;
    }

    const data = await res.json();

    if (data.verified) {
      // PIN verified successfully!
      markPinVerifiedForSession();
      hidePinVerificationModal();
      // Continue loading the app
      continueAppInitialization();
    } else {
      // PIN incorrect
      error.textContent = data.message || 'Incorrect PIN. Please try again.';
      error.style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'Verify';
      input.value = '';
      input.focus();
    }
  } catch (err) {
    console.error('[PIN-LOGIN] Error verifying PIN:', err);
    error.textContent = 'Failed to verify PIN. Please try again.';
    error.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Verify';
  }
}

// Store the continuation function for after PIN verification
let continueAppInitialization = () => {};

// ---- Membership Confirmation Modal ----
function showMembershipConfirmModal() {
  const modal = getElement('membershipConfirmModal');
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeMembershipConfirmModal() {
  const modal = getElement('membershipConfirmModal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
}

// Called when user clicks "Accept & Continue" in the modal
async function confirmMembership() {
  closeMembershipConfirmModal();
  await executeMembershipRequest();
}

// ---- Debounce Helper ----
function debounce(func, delay = 300) {
  let timeoutId;
  return function(...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => func.apply(this, args), delay);
  };
}

// Prevent double-clicks on async operations
const buttonClickTracking = new WeakMap();
function preventDoubleClick(button, asyncFunc) {
  return async function(...args) {
    if (buttonClickTracking.get(button)) {
      return; // Already processing
    }
    buttonClickTracking.set(button, true);
    try {
      await asyncFunc.apply(this, args);
    } finally {
      setTimeout(() => buttonClickTracking.delete(button), 1000);
    }
  };
}

// ---- Tab Lock/Unlock with Tooltips ----
function lockTab(tabId, tooltipMessage) {
  const tab = document.querySelector(`[data-tab="${tabId}"]`);
  if (tab) {
    tab.classList.add('locked');
    tab.setAttribute('data-tooltip', tooltipMessage);
    tab.addEventListener('click', preventTabClick);
  }
}

function unlockTab(tabId) {
  const tab = document.querySelector(`[data-tab="${tabId}"]`);
  if (tab) {
    tab.classList.remove('locked');
    tab.removeAttribute('data-tooltip');
    tab.removeEventListener('click', preventTabClick);
  }
}

function preventTabClick(e) {
  if (e.currentTarget.classList.contains('locked')) {
    e.preventDefault();
    e.stopPropagation();
  }
}

// ---- Loading State Helpers ----
function setLoading(button, loading = true) {
  if (loading) {
    button.dataset.originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Processing...';
    button.style.opacity = '0.7';
  } else {
    button.disabled = false;
    button.textContent = button.dataset.originalText || button.textContent;
    button.style.opacity = '1';
  }
}

function showGridLoadingSkeleton(containerId, count = 3) {
  const container = document.getElementById(containerId);
  let skeletonHTML = '';
  for (let i = 0; i < count; i++) {
    skeletonHTML += `
      <div style="padding:20px;background:#0a0a0a;border-radius:8px;border:1px solid var(--border);">
        <div class="skeleton" style="height:24px;margin-bottom:12px;border-radius:4px;width:60%;"></div>
        <div class="skeleton" style="height:16px;margin-bottom:8px;border-radius:4px;width:80%;"></div>
        <div class="skeleton" style="height:16px;margin-bottom:8px;border-radius:4px;width:70%;"></div>
        <div class="skeleton" style="height:36px;margin-top:16px;border-radius:4px;width:100%;"></div>
      </div>
    `;
  }
  container.innerHTML = skeletonHTML;
}

// ---- JWT helpers ----
function b64urlDecode(str) {
  str = str.replace(/-/g, '+').replace(/_/g, '/');
  const pad = str.length % 4 ? 4 - (str.length % 4) : 0;
  return atob(str + '='.repeat(pad));
}
/* SECURITY NOTE: Frontend JWT parsing is for display/UX purposes only.
 * JWT signature validation is performed server-side by API Gateway's Cognito authorizer.
 * Never trust client-side JWT claims for authorization - they can be tampered with.
 * All protected API endpoints validate the JWT signature and claims on the backend. */
function parseJwt(idt) {
  try {
    const [h, p, s] = idt.split('.');
    return { header: JSON.parse(b64urlDecode(h)), payload: JSON.parse(b64urlDecode(p)), signature: s };
  } catch { return { header: {}, payload: {}, signature: '' }; }
}

// Check if JWT token is expired
function isTokenExpired(token) {
  if (!token) return true;
  try {
    const { payload } = parseJwt(token);
    if (!payload.exp) return true;
    // exp is in seconds, Date.now() is in milliseconds
    const expiryTime = payload.exp * 1000;
    const now = Date.now();
    // Add 60 second buffer to account for clock skew
    return expiryTime < (now + 60000);
  } catch {
    return true;
  }
}

// ---- Auth check ----
function checkAuth() {
  if (!signedIn()) {
    // Redirect to signin page
    window.location.href = '/signin';
    return false;
  }

  // Check if token is expired
  const token = idToken();
  if (isTokenExpired(token)) {
    console.log('[AUTH] Token expired, redirecting to signin');
    clearTokens();
    window.location.href = '/signin';
    return false;
  }

  return true;
}

function signOut() {
  // Redirect to dedicated signout page
  window.location.href = '/signout';
}

function populateProfile() {
  if (!signedIn()) return;
  const { payload } = parseJwt(idToken());
  document.getElementById('firstName').textContent = payload.given_name || 'â€”';
  document.getElementById('lastName').textContent = payload.family_name || 'â€”';
  document.getElementById('email').textContent = payload.email || 'â€”';
  document.getElementById('userGuid').textContent = payload['custom:user_guid'] || 'â€”';
  // Also populate email in header and show dropdown
  document.getElementById('userEmail').textContent = payload.email || '';
  document.getElementById('userDropdownContainer').style.display = 'inline-block';
}

async function cancelAccount() {
  const confirmed = await showConfirmModal({
    title: 'Cancel Account',
    message: 'Are you sure you want to cancel your account? This will disable your access. An administrator can reactivate or permanently delete it.',
    confirmText: 'Cancel Account',
    cancelText: 'Keep Account',
    type: 'danger'
  });
  if (!confirmed) return;

  const btn = document.getElementById('cancelAccountBtn');
  setLoading(btn, true);

  try {
    const res = await fetch(API_URL + '/account/cancel', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + idToken() }
    });
    if (!res.ok) {
      const err = await res.json();
      showToast('Error: ' + (err.message || 'Failed to cancel account'), 'error');
      setLoading(btn, false);
      return;
    }
    const data = await res.json();
    showToast(data.message || 'Account canceled successfully', 'success');
    setTimeout(() => signOut(), 2000);
  } catch (err) {
    showToast('Error: ' + (err.message || 'Failed to cancel account'), 'error');
    setLoading(btn, false);
  }
}

// Tab switching with parent/child support
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    const target = tab.getAttribute('data-tab');
    const subTab = tab.getAttribute('data-sub-tab');
    const isParent = tab.classList.contains('tab-parent');
    const isChild = tab.classList.contains('tab-child');

    // If it's a parent tab, toggle expand/collapse and switch to first child
    if (isParent) {
      const parentId = tab.id;
      const childrenId = parentId.replace('Parent', 'Children');
      const children = document.getElementById(childrenId);

      // Toggle expansion
      tab.classList.toggle('expanded');
      children?.classList.toggle('expanded');

      // If expanding, switch to the parent's tab content and first sub-tab
      if (tab.classList.contains('expanded')) {
        // Clear active state from all non-child tabs
        document.querySelectorAll('.tab:not(.tab-child)').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // Activate parent and content
        tab.classList.add('active');
        document.getElementById(target)?.classList.add('active');

        // Activate first child tab and its sub-content
        const firstChild = children?.querySelector('.tab-child');
        if (firstChild) {
          document.querySelectorAll('.tab-child').forEach(c => c.classList.remove('active'));
          firstChild.classList.add('active');
          const firstSubTab = firstChild.getAttribute('data-sub-tab');
          if (firstSubTab) {
            activateSubTab(target, firstSubTab);
          }
        }
      }
      return;
    }

    // If it's a child tab, switch sub-tab content
    if (isChild) {
      // Clear active from all child tabs
      document.querySelectorAll('.tab-child').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');

      // Activate the sub-tab content
      if (subTab) {
        activateSubTab(target, subTab);
      }
      return;
    }

    // Regular tab - collapse any expanded parent tabs
    document.querySelectorAll('.tab-parent').forEach(p => p.classList.remove('expanded'));
    document.querySelectorAll('.tab-children').forEach(c => c.classList.remove('expanded'));
    document.querySelectorAll('.tab-child').forEach(c => c.classList.remove('active'));

    // Standard tab switching
    document.querySelectorAll('.tab:not(.tab-child)').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(target)?.classList.add('active');

    // Load voting data when voting tab is clicked
    if (target === 'voting' && signedIn()) {
      loadAllProposals();
    }
  };
});

// Helper function to activate sub-tab content
function activateSubTab(parentTab, subTabName) {
  const parentContent = document.getElementById(parentTab);
  if (!parentContent) return;

  // Clear all sub-tab-content active states within this parent
  parentContent.querySelectorAll('.sub-tab-content').forEach(s => s.classList.remove('active'));

  // Determine the sub-tab-content ID based on parent tab
  let subContentId;
  if (parentTab === 'account') {
    subContentId = 'account-' + subTabName;
  } else if (parentTab === 'deploy-vault') {
    subContentId = 'vault-' + subTabName;
  }

  // Activate the specific sub-tab content
  const subContent = document.getElementById(subContentId);
  if (subContent) {
    subContent.classList.add('active');
  }
}

// Keyboard shortcuts for tab navigation (1-6)
document.addEventListener('keydown', (e) => {
  // Only trigger if not typing in an input field
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  const tabMap = {
    '1': 'getting-started',
    '2': 'account',
    '3': 'subscription',
    '4': 'voting',
    '5': 'deploy-vault'
  };

  const tabName = tabMap[e.key];
  if (tabName) {
    const tabButton = document.querySelector(`.tab[data-tab="${tabName}"]`);
    // Check if tab is visible and not locked
    if (tabButton && tabButton.style.display !== 'none' && !tabButton.classList.contains('locked')) {
      e.preventDefault();
      switchToTab(tabName);
    }
  }
});

// ---- PIN Management ----
async function loadPinStatus() {
  try {
    const token = idToken();
    if (!token) {
      console.error('[PIN] No ID token found');
      throw new Error('No authentication token found');
    }
    console.log('[PIN] Fetching status from:', API_URL + '/account/security/pin/status');
    const res = await fetch(API_URL + '/account/security/pin/status', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    console.log('[PIN] Response status:', res.status);

    // Handle 404 as "PIN not configured yet" (valid state for new users)
    if (res.status === 404) {
      console.log('[PIN] No PIN configured for this account (404) - treating as disabled');
      const statusSpan = document.getElementById('pinStatus');
      const updatedAtP = document.getElementById('pinUpdatedAt');
      const enableBtn = document.getElementById('enablePinBtn');
      const updateBtn = document.getElementById('updatePinBtn');
      const disableBtn = document.getElementById('disablePinBtn');

      statusSpan.textContent = 'Disabled';
      statusSpan.style.color = '#f44336';
      statusSpan.style.fontWeight = '600';
      updatedAtP.innerHTML = '';
      enableBtn.style.display = 'inline-block';
      updateBtn.style.display = 'none';
      disableBtn.style.display = 'none';
      return; // Exit early - this is not an error
    }

    if (!res.ok) {
      const errorText = await res.text();
      console.error('[PIN] Error response:', errorText);
      throw new Error(`Failed to load PIN status: ${res.status} ${errorText}`);
    }
    const data = await res.json();

    const statusSpan = document.getElementById('pinStatus');
    const updatedAtP = document.getElementById('pinUpdatedAt');
    const enableBtn = document.getElementById('enablePinBtn');
    const updateBtn = document.getElementById('updatePinBtn');
    const disableBtn = document.getElementById('disablePinBtn');

    if (data.pin_enabled) {
      statusSpan.textContent = 'Enabled';
      statusSpan.style.color = '#4caf50';
      statusSpan.style.fontWeight = '600';
      if (data.pin_updated_at) {
        updatedAtP.innerHTML = '<span class="muted" style="font-size:0.85rem;">Last updated: ' + new Date(data.pin_updated_at).toLocaleString() + '</span>';
      }
      enableBtn.style.display = 'none';
      updateBtn.style.display = 'inline-block';
      disableBtn.style.display = 'inline-block';
    } else {
      statusSpan.textContent = 'Disabled';
      statusSpan.style.color = '#f44336';
      statusSpan.style.fontWeight = '600';
      updatedAtP.innerHTML = '';
      enableBtn.style.display = 'inline-block';
      updateBtn.style.display = 'none';
      disableBtn.style.display = 'none';
    }
  } catch (err) {
    console.error('Error loading PIN status:', err);
    document.getElementById('pinStatus').textContent = 'Error loading status';
  }
}

function validatePin(pin) {
  return /^\d{4,6}$/.test(pin);
}

function showEnablePinModal() {
  document.getElementById('enablePinModal').style.display = 'flex';
  document.getElementById('newPinInput').value = '';
  document.getElementById('confirmPinInput').value = '';
  document.getElementById('pinMatchIndicator').style.display = 'none';
  document.getElementById('newPinInput').focus();

  // Setup PIN match indicator
  const newPinInput = document.getElementById('newPinInput');
  const confirmPinInput = document.getElementById('confirmPinInput');
  const indicator = document.getElementById('pinMatchIndicator');

  function checkPinMatch() {
    const newPin = newPinInput.value;
    const confirmPin = confirmPinInput.value;

    if (!confirmPin) {
      indicator.style.display = 'none';
      return;
    }

    indicator.style.display = 'flex';

    if (newPin === confirmPin && newPin.length >= 4) {
      // Pins match
      indicator.style.background = 'rgba(76, 175, 80, 0.15)';
      indicator.style.border = '1px solid #4caf50';
      indicator.innerHTML = '<span style="color:#4caf50;font-size:1.2rem;">âœ“</span><span style="color:#4caf50;">PINs match</span>';
    } else {
      // Pins don't match
      indicator.style.background = 'rgba(244, 67, 54, 0.15)';
      indicator.style.border = '1px solid #f44336';
      indicator.innerHTML = '<span style="color:#f44336;font-size:1.2rem;">âœ—</span><span style="color:#f44336;">PINs do not match</span>';
    }
  }

  newPinInput.addEventListener('input', checkPinMatch);
  confirmPinInput.addEventListener('input', checkPinMatch);
}

function hideEnablePinModal() {
  document.getElementById('enablePinModal').style.display = 'none';
}

function showUpdatePinModal() {
  document.getElementById('updatePinModal').style.display = 'flex';
  document.getElementById('currentPinInput').value = '';
  document.getElementById('updatePinInput').value = '';
  document.getElementById('confirmUpdatePinInput').value = '';
  document.getElementById('currentPinInput').focus();
}

function hideUpdatePinModal() {
  document.getElementById('updatePinModal').style.display = 'none';
}

async function confirmEnablePin() {
  const pin = document.getElementById('newPinInput').value;
  const confirmPin = document.getElementById('confirmPinInput').value;

  if (!validatePin(pin)) {
    showToast('PIN must be 4-6 digits', 'error');
    return;
  }

  if (pin !== confirmPin) {
    showToast('PINs do not match', 'error');
    return;
  }

  const btn = document.getElementById('confirmEnablePinBtn');
  setLoading(btn, true);

  try {
    const res = await fetch(API_URL + '/account/security/pin/enable', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + idToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ pin: pin })
    });

    if (!res.ok) {
      const err = await res.json();
      showToast('Error: ' + (err.message || 'Failed to enable PIN'), 'error');
      setLoading(btn, false);
      return;
    }

    const data = await res.json();
    showToast(data.message || 'PIN enabled successfully', 'success');
    hideEnablePinModal();
    setLoading(btn, false);
    await loadPinStatus();

    // Redirect to getting started tab and refresh steps
    await populateGettingStartedSteps();
    switchToTab('getting-started');
  } catch (err) {
    console.error('Error enabling PIN:', err);
    showToast('Error: ' + (err.message || 'Failed to enable PIN'), 'error');
    setLoading(btn, false);
  }
}

async function confirmUpdatePin() {
  const currentPin = document.getElementById('currentPinInput').value;
  const newPin = document.getElementById('updatePinInput').value;
  const confirmPin = document.getElementById('confirmUpdatePinInput').value;

  if (!validatePin(currentPin)) {
    showToast('Current PIN must be 4-6 digits', 'error');
    return;
  }

  if (!validatePin(newPin)) {
    showToast('New PIN must be 4-6 digits', 'error');
    return;
  }

  if (newPin !== confirmPin) {
    showToast('New PINs do not match', 'error');
    return;
  }

  if (currentPin === newPin) {
    showToast('New PIN must be different from current PIN', 'error');
    return;
  }

  const btn = document.getElementById('confirmUpdatePinBtn');
  setLoading(btn, true);

  try {
    const res = await fetch(API_URL + '/account/security/pin/update', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + idToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ currentPin: currentPin, newPin: newPin })
    });

    if (!res.ok) {
      const err = await res.json();
      showToast('Error: ' + (err.message || 'Failed to update PIN'), 'error');
      setLoading(btn, false);
      return;
    }

    const data = await res.json();
    showToast(data.message || 'PIN updated successfully', 'success');
    hideUpdatePinModal();
    setLoading(btn, false);
    await loadPinStatus();
  } catch (err) {
    console.error('Error updating PIN:', err);
    showToast('Error: ' + (err.message || 'Failed to update PIN'), 'error');
    setLoading(btn, false);
  }
}

async function disablePin() {
  const confirmed = await showConfirmModal({
    title: 'Disable PIN Authentication',
    message: 'Are you sure you want to disable PIN authentication? You will only need your magic link to sign in.',
    confirmText: 'Disable PIN',
    cancelText: 'Keep PIN',
    type: 'warning'
  });
  if (!confirmed) return;

  // Show PIN confirmation modal instead of prompt
  showPinDisableModal();
}

async function executePinDisable(currentPin) {
  const btn = document.getElementById('disablePinBtn');
  setLoading(btn, true);

  try {
    const res = await fetch(API_URL + '/account/security/pin/disable', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + idToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ currentPin })
    });

    if (!res.ok) {
      const err = await res.json();
      showToast('Error: ' + (err.message || 'Failed to disable PIN'), 'error');
      setLoading(btn, false);
      return;
    }

    const data = await res.json();
    showToast(data.message || 'PIN disabled successfully', 'success');
    setLoading(btn, false);
    await loadPinStatus();
  } catch (err) {
    console.error('Error disabling PIN:', err);
    showToast('Error: ' + (err.message || 'Failed to disable PIN'), 'error');
    setLoading(btn, false);
  }
}

// ---- Email Preferences Management ----
async function loadEmailPreferences() {
  try {
    const token = idToken();
    if (!token) {
      console.error('[Email Prefs] No ID token found');
      throw new Error('No authentication token found');
    }

    const res = await fetch(API_URL + '/account/email-preferences', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (!res.ok) {
      const errorText = await res.text();
      console.error('[Email Prefs] Error response:', errorText);
      throw new Error(`Failed to load email preferences: ${res.status}`);
    }

    const data = await res.json();
    const toggle = document.getElementById('systemEmailsToggle');
    const statusSpan = document.getElementById('emailPrefsStatus');

    // Set toggle state
    toggle.checked = data.system_emails_enabled;
    toggle.disabled = false;

    // Update status text
    if (data.system_emails_enabled) {
      statusSpan.textContent = 'Enabled - You will receive system emails';
      statusSpan.style.color = '#4caf50';
      if (data.opted_in_at) {
        statusSpan.textContent += ' (since ' + new Date(data.opted_in_at).toLocaleDateString() + ')';
      }
    } else {
      statusSpan.textContent = 'Disabled - You will not receive system emails';
      statusSpan.style.color = '#f44336';
      if (data.opted_out_at) {
        statusSpan.textContent += ' (since ' + new Date(data.opted_out_at).toLocaleDateString() + ')';
      }
    }
  } catch (err) {
    console.error('Error loading email preferences:', err);
    document.getElementById('emailPrefsStatus').textContent = 'Error loading preferences';
    document.getElementById('emailPrefsStatus').style.color = '#f44336';
  }
}

async function toggleEmailPreferences(event) {
  const toggle = event.target;
  const newValue = toggle.checked;

  // Show confirmation dialog based on action
  const modalOptions = newValue ? {
    title: 'Enable System Emails',
    message: 'By enabling system emails, you agree to receive account notifications, security alerts, and service updates from VettID. Do you want to continue?',
    confirmText: 'Enable',
    cancelText: 'Cancel',
    type: 'default'
  } : {
    title: 'Disable System Emails',
    message: 'If you disable system emails, you will stop receiving important account notifications, security alerts, and service updates. Are you sure you want to continue?',
    confirmText: 'Disable',
    cancelText: 'Keep Enabled',
    type: 'warning'
  };

  const confirmed = await showConfirmModal(modalOptions);
  if (!confirmed) {
    // User cancelled, revert toggle
    toggle.checked = !newValue;
    return;
  }

  // Disable toggle during update
  toggle.disabled = true;

  try {
    const res = await fetch(API_URL + '/account/email-preferences', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + idToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        system_emails_enabled: newValue
      })
    });

    if (!res.ok) {
      const err = await res.json();
      showToast('Error: ' + (err.message || 'Failed to update email preferences'), 'error');
      // Revert toggle on error
      toggle.checked = !newValue;
      toggle.disabled = false;
      return;
    }

    const data = await res.json();
    showToast(data.message || 'Email preferences updated successfully', 'success');

    // Reload preferences to update status text
    await loadEmailPreferences();
  } catch (err) {
    console.error('Error updating email preferences:', err);
    showToast('Error: ' + (err.message || 'Failed to update email preferences'), 'error');
    // Revert toggle on error
    toggle.checked = !newValue;
    toggle.disabled = false;
  }
}

// ---- Membership Management ----
let currentTermsData = null;

async function loadMembershipTerms() {
  try {
    const res = await fetch(API_URL + '/account/membership/terms', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + idToken() }
    });
    if (!res.ok) {
      throw new Error('Failed to load membership terms');
    }
    currentTermsData = await res.json();

    // Display terms text
    const termsBox = document.getElementById('termsTextBox');
    termsBox.innerHTML = '<pre style="white-space:pre-wrap;font-family:inherit;margin:0;line-height:1.6;">' + currentTermsData.terms_text + '</pre>';

    // Set all download links
    document.getElementById('termsDownloadLink').href = currentTermsData.download_url;
    document.getElementById('memberTermsDownloadLink').href = currentTermsData.download_url;

  } catch (err) {
    console.error('Error loading membership terms:', err);
    const termsBox = document.getElementById('termsTextBox');
    if (err.message && err.message.includes('404')) {
      termsBox.innerHTML = '<p class="muted">Membership terms have not been configured yet. Please contact an administrator.</p>';
    } else {
      termsBox.innerHTML = '<p class="muted">Failed to load membership terms. Error: ' + (err.message || 'Unknown error') + '</p>';
    }
    // Disable the request button if terms can't be loaded
    const requestBtn = document.getElementById('requestMembershipBtn');
    if (requestBtn) {
      requestBtn.disabled = true;
      requestBtn.style.opacity = '0.5';
    }
  }
}

async function loadMembershipStatus() {
  try {
    const token = idToken();
    if (!token) {
      console.error('[MEMBERSHIP] No ID token found');
      throw new Error('No authentication token found');
    }
    const res = await fetch(API_URL + '/account/membership/status', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) {
      throw new Error('Failed to load membership status');
    }
    const data = await res.json();

    // Store membership status globally
    membershipStatus = data.membership_status;

    const statusSpan = document.getElementById('membershipStatus');
    const detailsP = document.getElementById('membershipDetails');
    const termsSection = document.getElementById('membershipTermsSection');
    const memberInfoSection = document.getElementById('memberInfoSection');
    const membershipCard = document.getElementById('membershipCard');

    switch (data.membership_status) {
      case 'none':
        statusSpan.textContent = 'Registered User';
        statusSpan.style.color = '#ffc125';
        statusSpan.style.fontWeight = '600';
        detailsP.innerHTML = '<span class="muted" style="font-size:0.85rem;">You are a registered user. Review and accept the membership terms below to request full membership.</span>';
        termsSection.style.display = 'block';
        memberInfoSection.style.display = 'none';
        membershipCard.classList.add('double-width');
        await loadMembershipTerms();
        break;
      case 'pending':
        statusSpan.textContent = 'Membership Pending';
        statusSpan.style.color = '#ffc125';
        statusSpan.style.fontWeight = '600';
        detailsP.innerHTML = '<span class="muted" style="font-size:0.85rem;">Your membership request is pending approval.</span>';
        termsSection.style.display = 'none';
        memberInfoSection.style.display = 'none';
        membershipCard.classList.remove('double-width');
        break;
      case 'approved':
        statusSpan.textContent = 'Member';
        statusSpan.style.color = '#4caf50';
        statusSpan.style.fontWeight = '600';
        // Only show "Activate a paid subscription" if user doesn't have an active paid subscription
        if (!isPaidSubscriber()) {
          detailsP.innerHTML = '<span class="muted" style="font-size:0.85rem;"><a href="#" onclick="switchToTab(\'subscription\'); return false;" style="color:var(--accent);text-decoration:underline;font-weight:600;">Activate a paid subscription</a> to unlock all features.</span>';
        } else {
          detailsP.innerHTML = '<span class="muted" style="font-size:0.85rem;">You have an active subscription with access to all features.</span>';
        }
        termsSection.style.display = 'none';
        memberInfoSection.style.display = 'block';
        membershipCard.classList.remove('double-width');

        let memberDetails = '';
        if (data.membership_approved_at) {
          memberDetails += '<strong>Approved:</strong> ' + new Date(data.membership_approved_at).toLocaleString() + '<br>';
        }
        if (data.terms_accepted_at) {
          memberDetails += '<strong>Terms Accepted:</strong> ' + new Date(data.terms_accepted_at).toLocaleString() + '<br>';
        }
        if (data.terms_version_id) {
          memberDetails += '<strong>Terms Version:</strong> ' + data.terms_version_id;
        }
        document.getElementById('memberDetailsText').innerHTML = memberDetails;
        await loadMembershipTerms();

        // Check if JWT token has member group - if not, need to sign out/in to get fresh token
        const { payload } = parseJwt(token);
        const groups = payload['cognito:groups'] || [];
        if (!groups.includes('member')) {
          detailsP.innerHTML += '<br><br><div style="padding:12px;background:#ff9800;color:#000;border-radius:4px;margin-top:12px;"><strong>Action Required:</strong> Your membership has been approved! Please <a href="#" onclick="signOut(); return false;" style="color:#000;text-decoration:underline;font-weight:700;">sign out and sign back in</a> to update your account and gain access to member features.</div>';
        }
        break;
      default:
        statusSpan.textContent = 'Unknown';
        detailsP.innerHTML = '';
        termsSection.style.display = 'none';
        memberInfoSection.style.display = 'none';
        membershipCard.classList.remove('double-width');
    }
  } catch (err) {
    console.error('Error loading membership status:', err);
    const statusSpan = document.getElementById('membershipStatus');
    const detailsP = document.getElementById('membershipDetails');
    const membershipCard = document.getElementById('membershipCard');
    statusSpan.textContent = 'Error loading status';
    statusSpan.style.color = '#f44336';
    detailsP.innerHTML = '<span class="muted" style="font-size:0.85rem;">Unable to load membership status. Please try refreshing the page. Error: ' + (err.message || 'Unknown error') + '</span>';

    // Try to load terms anyway in case that works
    const termsSection = document.getElementById('membershipTermsSection');
    termsSection.style.display = 'block';
    membershipCard.classList.add('double-width');
    await loadMembershipTerms().catch(termsErr => {
      console.error('Also failed to load terms:', termsErr);
    });
  }
}

async function requestMembership() {
  if (!currentTermsData || !currentTermsData.version_id) {
    showToast('Unable to process request: Terms data not loaded', 'error');
    return;
  }

  const checkbox = document.getElementById('acceptTermsCheckbox');
  if (!checkbox.checked) {
    showToast('You must accept the membership terms before requesting membership', 'warning');
    return;
  }

  // Show custom modal instead of browser confirm
  showMembershipConfirmModal();
}

async function executeMembershipRequest() {
  const btn = document.getElementById('requestMembershipBtn');
  const msgEl = document.getElementById('requestMembershipMsg');
  setLoading(btn, true);

  try {
    const res = await fetch(API_URL + '/account/membership/request', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + idToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        terms_version_id: currentTermsData.version_id
      })
    });

    if (!res.ok) {
      const err = await res.json();
      msgEl.textContent = 'Error: ' + (err.message || 'Failed to request membership');
      msgEl.style.color = '#f44336';
      showToast('Error: ' + (err.message || 'Failed to request membership'), 'error');
      setLoading(btn, false);
      return;
    }

    const data = await res.json();
    msgEl.textContent = data.message || 'Membership approved successfully';
    msgEl.style.color = '#4caf50';
    showToast(data.message || 'Membership approved successfully', 'success');

    // If response indicates user needs to sign in again, redirect after short delay
    if (data.requires_signin) {
      // Clear getting started flag so user sees getting started tab after re-login
      clearGettingStartedComplete();
      setTimeout(() => {
        signOut();
      }, 2000);
    } else {
      setLoading(btn, false);
      await loadMembershipStatus();
    }

    // Redirect to getting started tab and refresh steps
    await populateGettingStartedSteps();
    switchToTab('getting-started');
  } catch (err) {
    console.error('Error requesting membership:', err);
    showToast('Error: ' + (err.message || 'Failed to request membership'), 'error');
    setLoading(btn, false);
  }
}

// Subscription functions
async function createSubscription(subscription_type_id) {
  const msgEl = document.getElementById('subscriptionMessage');

  try {
    const res = await fetch(API_URL + '/account/subscriptions', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + idToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ subscription_type_id })
    });

    const data = await res.json();

    if (!res.ok) {
      msgEl.style.display = 'block';
      msgEl.style.background = '#3d0a0a';
      msgEl.style.border = '1px solid #f44336';
      msgEl.innerHTML = '<strong>Error</strong><br/>' + (data.message || 'Failed to create subscription');
      msgEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      return;
    }

    msgEl.style.display = 'block';
    msgEl.style.background = '#0a3d0a';
    msgEl.style.border = '1px solid #4caf50';

    const expiresDate = new Date(data.subscription.expires_at).toLocaleDateString();
    msgEl.innerHTML = '<strong>Subscription Activated!</strong><br/>' + data.message + ' (Expires: ' + expiresDate + ')';
    msgEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    // Check if this was the user's first subscription
    const wasFirstSubscription = !subscriptionStatus || !subscriptionStatus.has_subscription;

    // Reload tab visibility to show subscriber tabs
    await loadSubscriptionStatus();
    updateTabVisibility();

    // Only redirect to getting started for first subscription
    if (wasFirstSubscription) {
      await populateGettingStartedSteps();
      switchToTab('getting-started');
    } else {
      // Just refresh the steps but stay on current tab
      await populateGettingStartedSteps();
    }

    console.log('[SUBSCRIPTION] Subscription created:', data);
  } catch (err) {
    console.error('Error creating subscription:', err);
    msgEl.style.display = 'block';
    msgEl.style.background = '#3d0a0a';
    msgEl.style.border = '1px solid #f44336';
    msgEl.innerHTML = '<strong>Error</strong><br/>Failed to create subscription. Please try again.';
    msgEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

// Load subscription status
async function loadSubscriptionStatus() {
  try {
    const res = await fetch(API_URL + '/account/subscriptions/status', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + idToken() }
    });

    if (!res.ok) {
      console.error('[SUBSCRIPTION] Failed to load subscription status');
      return;
    }

    subscriptionStatus = await res.json();
    console.log('[SUBSCRIPTION] Subscription status:', subscriptionStatus);

    // Update UI based on subscription status
    updateSubscriptionUI();
  } catch (err) {
    console.error('[SUBSCRIPTION] Error loading subscription status:', err);
  }
}

function updateSubscriptionUI() {
  const detailsDiv = document.getElementById('currentSubscriptionDetails');
  const profileSubDiv = document.getElementById('profileSubscriptionStatus');
  const msgEl = document.getElementById('subscriptionMessage');

  if (subscriptionStatus && subscriptionStatus.is_active) {
    // User has active subscription - show subscription details
    let plan = subscriptionStatus.plan || 'Unknown';
    let expiresAt = subscriptionStatus.expires_at ? new Date(subscriptionStatus.expires_at).toLocaleString() : 'N/A';
    let status = subscriptionStatus.status || 'Unknown';
    let statusColor = '#4caf50';
    let statusText = status;

    // Better status display for cancelled subscriptions
    if (status === 'cancelled') {
      statusColor = '#ff9800';
      statusText = 'Cancelled (Active until expiry)';
    } else if (status === 'active') {
      statusColor = '#4caf50';
      statusText = 'Active';
    } else if (status === 'expired') {
      statusColor = '#f44336';
      statusText = 'Expired';
    }

    detailsDiv.innerHTML = `
      <div style="padding:16px;background:#0a0a0a;border-radius:4px;border:2px solid var(--accent);margin-bottom:16px;">
        <p><strong>Plan:</strong> ${plan}</p>
        <p><strong>Status:</strong> <span style="color:${statusColor};font-weight:600;">${statusText}</span></p>
        <p style="margin-bottom:0;"><strong>Expires:</strong> ${expiresAt}</p>
      </div>
      ${status === 'cancelled' ? '<p style="color:#ff9800;font-size:0.9rem;margin-top:8px;"><strong>Note:</strong> Your subscription has been cancelled but you retain access until the expiration date above.</p>' : ''}
      ${status === 'active' ? '<button class="btn" onclick="cancelSubscription()" style="background:linear-gradient(135deg,#d32f2f 0%,#a00 100%);color:#fff;">Cancel Subscription</button>' : ''}
    `;

    // Update profile subscription status
    if (profileSubDiv) {
      profileSubDiv.innerHTML = `
        <p style="margin:0;"><strong>Plan:</strong> ${plan}</p>
        <p style="margin:8px 0 0;"><strong>Status:</strong> <span style="color:${statusColor};font-weight:600;">${statusText}</span></p>
      `;
    }
  } else {
    // No active subscription - clear any success messages
    if (msgEl) {
      msgEl.style.display = 'none';
      msgEl.innerHTML = '';
    }

    detailsDiv.innerHTML = `
      <div style="padding:24px;background:#0a0a0a;border-radius:4px;text-align:center;">
        <p class="muted" style="font-size:1rem;margin:0;">No active subscription</p>
        <p class="muted" style="font-size:0.85rem;margin-top:8px;margin-bottom:0;">Select a plan from the options to get started.</p>
      </div>
    `;

    // Update profile subscription status
    if (profileSubDiv) {
      profileSubDiv.innerHTML = `
        <p style="margin:0;color:#999;">No active subscription</p>
      `;
    }
  }
}

function isSubscriber() {
  return subscriptionStatus && subscriptionStatus.is_active === true;
}

function isPaidSubscriber() {
  return subscriptionStatus && subscriptionStatus.is_active === true && subscriptionStatus.amount > 0;
}


async function cancelSubscription() {
  const confirmed = await showConfirmModal({
    title: 'Cancel Subscription',
    message: 'Are you sure you want to cancel your subscription? You will lose access when your current period ends.',
    confirmText: 'Cancel Subscription',
    cancelText: 'Keep Subscription',
    type: 'danger'
  });
  if (!confirmed) return;

  // Create a temporary button reference for loading state
  const tempBtn = document.createElement('button');
  tempBtn.textContent = 'Cancel Subscription';

  try {
    const res = await fetch(API_URL + '/account/subscriptions/cancel', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + idToken(),
        'Content-Type': 'application/json'
      }
    });

    if (!res.ok) {
      const err = await res.json();
      showToast('Error: ' + (err.message || 'Failed to cancel subscription'), 'error');
      return;
    }

    const data = await res.json();
    showToast(data.message || 'Your subscription has been cancelled. You will retain access until the end of your billing period.', 'success');
    await loadSubscriptionStatus();
  } catch (err) {
    console.error('Error cancelling subscription:', err);
    showToast('Failed to cancel subscription. Please try again.', 'error');
  }
}

// Event listeners
document.getElementById('signout').onclick = signOut;
document.getElementById('cancelAccountBtn').onclick = cancelAccount;

// User dropdown toggle
const userDropdownBtn = document.querySelector('.user-dropdown-btn');
const userDropdownMenu = document.getElementById('userDropdownMenu');
if (userDropdownBtn) {
  userDropdownBtn.onclick = (e) => {
    e.stopPropagation();
    userDropdownMenu.classList.toggle('active');
  };
}
// Close dropdown when clicking outside
document.addEventListener('click', () => {
  if (userDropdownMenu) userDropdownMenu.classList.remove('active');
});

// Membership Management event listeners
document.getElementById('requestMembershipBtn').onclick = requestMembership;

// Terms acceptance checkbox handler
document.getElementById('acceptTermsCheckbox').onchange = function() {
  const btn = document.getElementById('requestMembershipBtn');
  if (this.checked) {
    btn.disabled = false;
    btn.style.opacity = '1';
  } else {
    btn.disabled = true;
    btn.style.opacity = '0.5';
  }
};

// PIN Management event listeners
document.getElementById('enablePinBtn').onclick = showEnablePinModal;
document.getElementById('updatePinBtn').onclick = showUpdatePinModal;
document.getElementById('disablePinBtn').onclick = disablePin;
document.getElementById('cancelEnablePinBtn').onclick = hideEnablePinModal;
document.getElementById('confirmEnablePinBtn').onclick = confirmEnablePin;
document.getElementById('cancelUpdatePinBtn').onclick = hideUpdatePinModal;
document.getElementById('confirmUpdatePinBtn').onclick = confirmUpdatePin;

// Email Preferences event listener
document.getElementById('systemEmailsToggle').onchange = toggleEmailPreferences;

// Close modals on background click
document.getElementById('enablePinModal').onclick = (e) => {
  if (e.target === e.currentTarget) hideEnablePinModal();
};
document.getElementById('updatePinModal').onclick = (e) => {
  if (e.target === e.currentTarget) hideUpdatePinModal();
};

// ---- Voting Functions ----
let userVotesCache = null;
let allProposalsData = { active: [], upcoming: [], completed: [] };
let currentProposalFilter = 'active';

async function loadAllProposals() {
  // Show skeleton loading
  showGridLoadingSkeleton('proposalsContainer', 3);

  try {
    const token = idToken();
    if (!token) throw new Error('No authentication token');

    const res = await fetch(API_URL + '/proposals', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (!res.ok) throw new Error('Failed to load proposals');
    const data = await res.json();

    // Store proposals data
    allProposalsData = {
      active: data.active || [],
      upcoming: data.upcoming || [],
      completed: data.closed || []  // Using closed data as completed
    };

    // Load user's existing votes
    await loadUserVotes();

    // Update all count badges
    updateProposalCounts();

    // Render proposals based on current filter
    renderProposals(currentProposalFilter);

    // Set up filter button handlers
    setupProposalFilters();

  } catch (error) {
    console.error('Error loading proposals:', error);
    document.getElementById('proposalsContainer').innerHTML = '<p style="color:#f44336;text-align:center;padding:20px;grid-column:1/-1;">Failed to load proposals</p>';
  }
}

function updateProposalCounts() {
  document.getElementById('activeProposalsCount').textContent = allProposalsData.active.length;
  document.getElementById('completedProposalsCount').textContent = allProposalsData.completed.length;

  // Update voting badge with count of active proposals user hasn't voted on
  updateVotingBadge();
}

function updateVotingBadge() {
  const badge = document.getElementById('votingBadge');
  if (!badge) return;

  // Count active proposals the user hasn't voted on
  const unvotedCount = allProposalsData.active.filter(proposal => {
    const hasVoted = userVotesCache && userVotesCache.some(v => v.proposal_id === proposal.proposal_id);
    return !hasVoted;
  }).length;

  if (unvotedCount > 0) {
    badge.textContent = unvotedCount;
    badge.style.display = 'inline-flex';
  } else {
    badge.style.display = 'none';
  }
}

function setupProposalFilters() {
  const filters = document.querySelectorAll('.proposal-filter');
  filters.forEach(filter => {
    filter.addEventListener('click', () => {
      const filterType = filter.dataset.filter;
      currentProposalFilter = filterType;

      // Update active state
      filters.forEach(f => f.classList.remove('active'));
      filter.classList.add('active');

      // Render filtered proposals
      renderProposals(filterType);
    });
  });
}

async function renderProposals(filter) {
  const container = document.getElementById('proposalsContainer');

  let proposalsToRender = [];

  if (filter === 'active') {
    proposalsToRender = [...allProposalsData.active].sort((a, b) => new Date(a.closes_at) - new Date(b.closes_at));

    if (proposalsToRender.length === 0) {
      container.innerHTML = `
        <div style="grid-column:1/-1;text-align:center;padding:60px 20px;">
          <div style="background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-radius:12px;border:2px solid #222;padding:40px 20px;max-width:500px;margin:0 auto;">
            <div style="width:80px;height:80px;margin:0 auto 20px;background:rgba(16,185,129,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                <path d="M9 12l2 2 4-4"/>
              </svg>
            </div>
            <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:1.2rem;">No Active Proposals</h4>
            <p style="color:var(--gray);margin:0 0 20px 0;line-height:1.6;">There are no proposals currently open for voting. Check back soon for new community proposals.</p>
            <button class="btn proposal-filter" data-filter="completed" onclick="document.getElementById('filterCompletedProposals').click()" style="background:linear-gradient(135deg,#6366f1 0%,#4f46e5 100%);padding:10px 24px;font-weight:600;">
              View Completed Proposals
            </button>
          </div>
        </div>
      `;
      return;
    }
  } else if (filter === 'completed') {
    proposalsToRender = [...allProposalsData.completed].sort((a, b) => new Date(b.closes_at) - new Date(a.closes_at));

    if (proposalsToRender.length === 0) {
      container.innerHTML = `
        <div style="grid-column:1/-1;text-align:center;padding:60px 20px;">
          <div style="background:linear-gradient(135deg,#1a1a1a 0%,#0a0a0a 100%);border-radius:12px;border:2px solid #222;padding:40px 20px;max-width:500px;margin:0 auto;">
            <div style="width:80px;height:80px;margin:0 auto 20px;background:rgba(99,102,241,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:1.2rem;">No Completed Proposals</h4>
            <p style="color:var(--gray);margin:0 0 20px 0;line-height:1.6;">No proposals have been completed yet. Completed proposals will appear here after voting closes.</p>
            <button class="btn proposal-filter" data-filter="active" onclick="document.getElementById('filterActiveProposals').click()" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:10px 24px;font-weight:600;">
              View Active Proposals
            </button>
          </div>
        </div>
      `;
      return;
    }

    // Render completed proposals in tiled grid
    renderCompletedProposals(proposalsToRender);
    return;
  }

  container.innerHTML = proposalsToRender.map(proposal => {
    const proposalId = proposal.proposal_id;
    const hasVoted = userVotesCache && userVotesCache.some(v => v.proposal_id === proposalId);
    const userVote = userVotesCache && userVotesCache.find(v => v.proposal_id === proposalId);

    // Render active proposal
      const closesAt = new Date(proposal.closes_at);
      const now = new Date();
      const diff = closesAt - now;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const timeRemaining = days > 0 ? `${days}d ${hours}h` : hours > 0 ? `${hours}h` : 'Closing soon';

      return `
        <div style="background:#0a0a0a;border:1px solid #333;border-radius:8px;padding:12px;">
          <h4 style="margin:0 0 6px 0;font-weight:700;font-size:0.95rem;">${proposal.proposal_title || 'Untitled Proposal'}</h4>
          <div style="margin-bottom:8px;">
            <span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">Active</span>
          </div>
          <div style="margin-bottom:8px;padding:8px;background:#1a1a1a;border-radius:6px;text-align:center;">
            <span style="font-size:0.85rem;color:var(--accent);font-weight:600;">Closes in ${timeRemaining}</span>
          </div>
          <button onclick="toggleProposalText('proposal-text-${proposalId}')" class="btn" style="width:100%;padding:8px 12px;font-size:0.8rem;background:linear-gradient(135deg,#ffd93d 0%,#ffc125 100%);color:#000;font-weight:600;margin-bottom:8px;">View Proposal</button>
          <div id="proposal-text-${proposalId}" style="display:none;padding:10px;background:#050505;border-left:3px solid var(--accent);border-radius:4px;margin-bottom:8px;line-height:1.6;font-size:0.85rem;">${proposal.proposal_text}</div>
          ${hasVoted ? `
            <div style="margin-bottom:8px;padding:10px;background:#050505;border-left:3px solid ${userVote && userVote.vote ? (userVote.vote.toLowerCase() === 'yes' ? '#10b981' : userVote.vote.toLowerCase() === 'no' ? '#ef4444' : '#6b7280') : '#4caf50'};border-radius:4px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:0.8rem;color:var(--gray);">Your vote:</span>
                <span style="font-size:0.85rem;font-weight:700;color:${userVote && userVote.vote ? (userVote.vote.toLowerCase() === 'yes' ? '#10b981' : userVote.vote.toLowerCase() === 'no' ? '#ef4444' : '#6b7280') : '#4caf50'};text-transform:uppercase;">${userVote && userVote.vote ? userVote.vote : 'UNKNOWN'}</span>
              </div>
            </div>
          ` : `
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px;">
              <button class="btn" onclick="selectVote('${proposalId}', 'yes')" id="vote-${proposalId}-yes" style="padding:10px 8px;font-size:0.8rem;background:#16a34a;color:#fff;border:2px solid transparent;font-weight:600;">Yes</button>
              <button class="btn" onclick="selectVote('${proposalId}', 'no')" id="vote-${proposalId}-no" style="padding:10px 8px;font-size:0.8rem;background:#dc2626;color:#fff;border:2px solid transparent;font-weight:600;">No</button>
              <button class="btn" onclick="selectVote('${proposalId}', 'abstain')" id="vote-${proposalId}-abstain" style="padding:10px 8px;font-size:0.8rem;background:#6b7280;color:#fff;border:2px solid transparent;font-weight:600;">Abstain</button>
            </div>
            <button class="btn" onclick="submitVote('${proposalId}')" id="submit-${proposalId}" style="width:100%;display:none;padding:10px;font-size:0.85rem;background:var(--accent);color:#000;font-weight:600;">Submit Vote</button>
          `}
          <div id="results-${proposalId}" style="margin-top:8px;"></div>
        </div>
      `;
  }).join('');

  // Load results for active proposals
  for (const proposal of proposalsToRender) {
    const proposalId = proposal.proposal_id;
    await loadCompactVoteResults(proposalId, 'results-' + proposalId);
  }
}

let selectedVotes = {};

function selectVote(proposalId, choice) {
  selectedVotes[proposalId] = choice;

  // Update button styles
  ['yes', 'no', 'abstain'].forEach(c => {
    const btn = document.getElementById(`vote-${proposalId}-${c}`);
    if (c === choice) {
      btn.style.borderColor = 'var(--accent)';
      btn.style.fontWeight = '600';
    } else {
      btn.style.borderColor = 'transparent';
      btn.style.fontWeight = '400';
    }
  });

  // Show submit button
  document.getElementById(`submit-${proposalId}`).style.display = 'block';
}

async function submitVote(proposalId) {
  const choice = selectedVotes[proposalId];
  if (!choice) return;

  const confirmed = await showConfirmModal({
    title: 'Confirm Vote Submission',
    message: '<strong style="color:#ff9800;">WARNING:</strong> Your vote is permanent and cannot be changed once submitted.<br><br>Are you sure you want to submit your vote?',
    confirmText: 'Submit Vote',
    cancelText: 'Cancel',
    type: 'warning'
  });
  if (!confirmed) return;

  try {
    const token = idToken();
    if (!token) throw new Error('No authentication token');

    const res = await fetch(API_URL + '/votes', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        proposal_id: proposalId,
        vote: choice
      })
    });

    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.message || 'Failed to submit vote');
    }

    await showAlertModal({
      type: 'success',
      title: 'Vote Recorded',
      message: 'Your vote has been recorded successfully!'
    });

    // Clear cache and reload
    userVotesCache = null;
    delete selectedVotes[proposalId];
    await loadAllProposals();
  } catch (error) {
    console.error('Error submitting vote:', error);
    await showAlertModal({
      type: 'error',
      title: 'Vote Failed',
      message: 'Failed to submit vote: ' + error.message
    });
  }
}

async function loadUserVotes() {
  if (userVotesCache) return;

  try {
    const token = idToken();
    if (!token) throw new Error('No authentication token');

    const res = await fetch(API_URL + '/votes/history', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });

    // Handle 400/404 as "no votes yet" (valid state for new users)
    if (res.status === 400 || res.status === 404) {
      console.log('[VOTES] No vote history found (status ' + res.status + ') - treating as empty');
      userVotesCache = [];
      return;
    }

    if (!res.ok) throw new Error('Failed to load vote history');
    const data = await res.json();

    userVotesCache = data.votes || [];
  } catch (error) {
    console.error('Error loading user votes:', error);
    userVotesCache = [];
  }
}

// Render completed proposals in a tiled grid
async function renderCompletedProposals(proposals) {
  const container = document.getElementById('proposalsContainer');

  container.innerHTML = proposals.map(proposal => {
    const proposalId = proposal.proposal_id;
    const userVote = userVotesCache && userVotesCache.find(v => v.proposal_id === proposalId);

    // Prepare vote badge colors
    const voteColors = {
      yes: '#10b981',
      no: '#ef4444',
      abstain: '#6b7280'
    };

    const userVoteText = userVote ? userVote.vote : 'Not Voted';
    const userVoteColor = userVote && voteColors[userVote.vote.toLowerCase()] ? voteColors[userVote.vote.toLowerCase()] : '#6b7280';

    return `
      <div id="completed-${proposalId}" style="background:#0a0a0a;border:1px solid #333;border-radius:8px;padding:16px;display:flex;flex-direction:column;position:relative;min-height:280px;">
        <h4 style="margin:0 0 12px 0;font-weight:700;font-size:1rem;line-height:1.4;">${proposal.proposal_title || 'Untitled Proposal'}</h4>

        <!-- Pass/Fail Badge -->
        <div id="result-badge-${proposalId}" style="margin-bottom:12px;height:24px;">
          <div class="skeleton" style="height:24px;width:80px;border-radius:12px;"></div>
        </div>

        <!-- User Vote -->
        <div style="margin-bottom:16px;padding:10px;background:#050505;border-left:3px solid ${userVoteColor};border-radius:4px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:0.8rem;color:var(--gray);">Your vote:</span>
            <span style="font-size:0.85rem;font-weight:700;color:${userVoteColor};text-transform:uppercase;">${userVoteText}</span>
          </div>
        </div>

        <!-- Vote Results -->
        <div id="results-${proposalId}" style="flex:1;min-height:140px;">
          <div style="padding:10px;background:#050505;border-radius:6px;">
            <div class="skeleton" style="height:16px;margin-bottom:12px;border-radius:4px;width:40%;"></div>
            <div class="skeleton" style="height:12px;margin-bottom:8px;border-radius:4px;width:100%;"></div>
            <div class="skeleton" style="height:4px;margin-bottom:16px;border-radius:4px;width:100%;"></div>
            <div class="skeleton" style="height:12px;margin-bottom:8px;border-radius:4px;width:100%;"></div>
            <div class="skeleton" style="height:4px;margin-bottom:16px;border-radius:4px;width:100%;"></div>
            <div class="skeleton" style="height:12px;margin-bottom:8px;border-radius:4px;width:100%;"></div>
            <div class="skeleton" style="height:4px;border-radius:4px;width:100%;"></div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  // Load results for each completed proposal in parallel
  await Promise.all(proposals.map(proposal => loadCompletedProposalResults(proposal.proposal_id)));
}

// Load results for completed proposals
async function loadCompletedProposalResults(proposalId) {
  try {
    const token = idToken();
    if (!token) throw new Error('No authentication token');

    const res = await fetch(API_URL + '/proposals/' + proposalId + '/results', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (!res.ok) throw new Error('Failed to load results');
    const data = await res.json();

    const yes = data.results.yes || 0;
    const no = data.results.no || 0;
    const abstain = data.results.abstain || 0;
    const total = yes + no + abstain;

    const yesPercent = total > 0 ? Math.round((yes / total) * 100) : 0;
    const noPercent = total > 0 ? Math.round((no / total) * 100) : 0;
    const abstainPercent = total > 0 ? Math.round((abstain / total) * 100) : 0;

    const passed = yes > no;

    // Update result badge
    const badgeEl = document.getElementById('result-badge-' + proposalId);
    if (badgeEl) {
      badgeEl.innerHTML = passed
        ? '<span style="display:inline-block;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">âœ… PASSED</span>'
        : '<span style="display:inline-block;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;">âŒ FAILED</span>';
    }

    // Update card border color
    const cardEl = document.getElementById('completed-' + proposalId);
    if (cardEl) {
      cardEl.style.borderColor = passed ? '#10b981' : '#ef4444';
      cardEl.style.borderWidth = '2px';
    }

    // Update results
    const resultsEl = document.getElementById('results-' + proposalId);
    if (resultsEl) {
      resultsEl.innerHTML = `
        <div style="padding:10px;background:#050505;border-radius:6px;">
          <div style="margin-bottom:6px;font-size:0.75rem;color:var(--gray);">
            Total votes: ${total}
          </div>
          <div style="margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:2px;">
              <span style="font-size:0.7rem;color:#10b981;font-weight:600;">Yes</span>
              <span style="font-size:0.7rem;font-weight:600;">${yes} (${yesPercent}%)</span>
            </div>
            <div style="background:#1a1a1a;border-radius:4px;height:4px;overflow:hidden;">
              <div style="background:#10b981;height:100%;width:${yesPercent}%;"></div>
            </div>
          </div>
          <div style="margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:2px;">
              <span style="font-size:0.7rem;color:#ef4444;font-weight:600;">No</span>
              <span style="font-size:0.7rem;font-weight:600;">${no} (${noPercent}%)</span>
            </div>
            <div style="background:#1a1a1a;border-radius:4px;height:4px;overflow:hidden;">
              <div style="background:#ef4444;height:100%;width:${noPercent}%;"></div>
            </div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:2px;">
              <span style="font-size:0.7rem;color:#6b7280;font-weight:600;">Abstain</span>
              <span style="font-size:0.7rem;font-weight:600;">${abstain} (${abstainPercent}%)</span>
            </div>
            <div style="background:#1a1a1a;border-radius:4px;height:4px;overflow:hidden;">
              <div style="background:#6b7280;height:100%;width:${abstainPercent}%;"></div>
            </div>
          </div>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading results for proposal', proposalId, error);
    const resultsEl = document.getElementById('results-' + proposalId);
    if (resultsEl) {
      resultsEl.innerHTML = '<p class="muted" style="font-size:0.8rem;text-align:center;">Failed to load results</p>';
    }
  }
}

// Load compact live results for active proposals
async function loadCompactVoteResults(proposalId, containerId) {
  try {
    const token = idToken();
    if (!token) return;

    const res = await fetch(API_URL + '/proposals/' + proposalId + '/vote-counts', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (!res.ok) return;
    const data = await res.json();

    const total = data.yes + data.no + data.abstain;
    const yesPercent = total > 0 ? Math.round((data.yes / total) * 100) : 0;
    const noPercent = total > 0 ? Math.round((data.no / total) * 100) : 0;
    const abstainPercent = total > 0 ? Math.round((data.abstain / total) * 100) : 0;

    const resultsContainer = document.getElementById(containerId);
    if (resultsContainer) {
      resultsContainer.innerHTML = `
        <div style="padding:12px;background:#050505;border-radius:4px;border:1px solid #333;">
          <p style="margin:0 0 8px 0;font-size:0.85rem;color:#999;font-weight:600;">Live Results (${total} votes)</p>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">
                <span style="color:#4caf50;font-size:0.8rem;font-weight:600;">Yes</span>
                <span style="color:#4caf50;font-size:0.8rem;font-weight:600;">${data.yes} (${yesPercent}%)</span>
              </div>
              <div style="background:#1a1a1a;border-radius:3px;height:6px;overflow:hidden;">
                <div style="background:linear-gradient(90deg,#4caf50 0%,#66bb6a 100%);height:100%;width:${yesPercent}%;"></div>
              </div>
            </div>
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">
                <span style="color:#f44336;font-size:0.8rem;font-weight:600;">No</span>
                <span style="color:#f44336;font-size:0.8rem;font-weight:600;">${data.no} (${noPercent}%)</span>
              </div>
              <div style="background:#1a1a1a;border-radius:3px;height:6px;overflow:hidden;">
                <div style="background:linear-gradient(90deg,#f44336 0%,#ef5350 100%);height:100%;width:${noPercent}%;"></div>
              </div>
            </div>
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">
                <span style="color:#999;font-size:0.8rem;font-weight:600;">Abstain</span>
                <span style="color:#999;font-size:0.8rem;font-weight:600;">${data.abstain} (${abstainPercent}%)</span>
              </div>
              <div style="background:#1a1a1a;border-radius:3px;height:6px;overflow:hidden;">
                <div style="background:linear-gradient(90deg,#999 0%,#aaa 100%);height:100%;width:${abstainPercent}%;"></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
  } catch (error) {
    // Silently fail for live results
    console.error('Error loading compact vote results:', error);
  }
}

function toggleProposalText(elementId) {
  const element = document.getElementById(elementId);
  const button = element.previousElementSibling;
  if (element.style.display === 'none') {
    element.style.display = 'block';
    button.textContent = 'Hide Proposal';
  } else {
    element.style.display = 'none';
    button.textContent = 'View Proposal';
  }
}

async function loadProposalResultsInline(proposalId) {
  try {
    const token = idToken();
    if (!token) throw new Error('No authentication token');

    const res = await fetch(API_URL + '/proposals/' + proposalId + '/results', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (!res.ok) throw new Error('Failed to load proposal results');
    const data = await res.json();

    const total = data.results.yes + data.results.no + data.results.abstain;
    const yesPercent = total > 0 ? Math.round((data.results.yes / total) * 100) : 0;
    const noPercent = total > 0 ? Math.round((data.results.no / total) * 100) : 0;
    const abstainPercent = total > 0 ? Math.round((data.results.abstain / total) * 100) : 0;

    const resultsContainer = document.getElementById(`results-${proposalId}`);
    if (resultsContainer) {
      resultsContainer.innerHTML = `
        <div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #333;">
          <p style="margin:0 0 4px 0;font-weight:600;font-size:0.9rem;">Voting Results</p>
          <p class="muted" style="margin:0;font-size:0.85rem;">Total Votes: ${total}</p>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <span style="color:#4caf50;font-weight:600;font-size:0.9rem;">Yes</span>
              <span style="color:#4caf50;font-weight:600;font-size:0.9rem;">${data.results.yes} (${yesPercent}%)</span>
            </div>
            <div style="background:#1a1a1a;border-radius:4px;height:8px;overflow:hidden;">
              <div style="background:linear-gradient(90deg,#4caf50 0%,#66bb6a 100%);height:100%;width:${yesPercent}%;transition:width 0.3s;"></div>
            </div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <span style="color:#f44336;font-weight:600;font-size:0.9rem;">No</span>
              <span style="color:#f44336;font-weight:600;font-size:0.9rem;">${data.results.no} (${noPercent}%)</span>
            </div>
            <div style="background:#1a1a1a;border-radius:4px;height:8px;overflow:hidden;">
              <div style="background:linear-gradient(90deg,#f44336 0%,#ef5350 100%);height:100%;width:${noPercent}%;transition:width 0.3s;"></div>
            </div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <span style="color:#999;font-weight:600;font-size:0.9rem;">Abstain</span>
              <span style="color:#999;font-weight:600;font-size:0.9rem;">${data.results.abstain} (${abstainPercent}%)</span>
            </div>
            <div style="background:#1a1a1a;border-radius:4px;height:8px;overflow:hidden;">
              <div style="background:linear-gradient(90deg,#999 0%,#aaa 100%);height:100%;width:${abstainPercent}%;transition:width 0.3s;"></div>
            </div>
          </div>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading proposal results:', error);
    const resultsContainer = document.getElementById(`results-${proposalId}`);
    if (resultsContainer) {
      resultsContainer.innerHTML = '<p style="margin:0;color:#f44336;text-align:center;font-size:0.9rem;">Failed to load results</p>';
    }
  }
}

async function viewProposalResults(proposalId) {
  try {
    const token = idToken();
    if (!token) throw new Error('No authentication token');

    const res = await fetch(API_URL + '/proposals/' + proposalId + '/results', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token }
    });

    if (!res.ok) throw new Error('Failed to load proposal results');
    const data = await res.json();

    const total = data.results.yes + data.results.no + data.results.abstain;
    const yesPercent = total > 0 ? Math.round((data.results.yes / total) * 100) : 0;
    const noPercent = total > 0 ? Math.round((data.results.no / total) * 100) : 0;
    const abstainPercent = total > 0 ? Math.round((data.results.abstain / total) * 100) : 0;

    const htmlContent = `
      <div style="margin-bottom:20px;">
        <h4 style="margin:0 0 12px 0;color:var(--accent);font-size:1.1rem;">${data.proposal.proposal_title || 'Untitled'}</h4>
        <p style="color:var(--gray);margin-bottom:16px;line-height:1.6;">${data.proposal.proposal_text}</p>

        <div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;">
          <div>
            <span style="color:var(--gray);font-size:0.9rem;">Status:</span>
            <span style="color:var(--text);margin-left:8px;font-weight:600;">${data.proposal.status}</span>
          </div>
          <div>
            <span style="color:var(--gray);font-size:0.9rem;">Closed:</span>
            <span style="color:var(--text);margin-left:8px;font-weight:600;">${new Date(data.proposal.closes_at).toLocaleDateString()}</span>
          </div>
        </div>
      </div>

      <div style="background:#050505;border-radius:8px;padding:20px;border:1px solid #222;">
        <h5 style="margin:0 0 16px 0;color:var(--accent);font-size:1rem;">Results</h5>
        <div style="margin-bottom:16px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
            <span style="color:var(--gray);">Total Votes</span>
            <span style="color:var(--text);font-weight:600;">${total}</span>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:12px;">
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
              <span style="color:#4caf50;font-weight:600;">Yes</span>
              <span style="color:var(--text);">${data.results.yes} (${yesPercent}%)</span>
            </div>
            <div style="background:#1a1a1a;border-radius:4px;height:8px;overflow:hidden;">
              <div style="background:linear-gradient(90deg,#4caf50 0%,#2e7d32 100%);height:100%;width:${yesPercent}%;transition:width 0.5s ease;"></div>
            </div>
          </div>

          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
              <span style="color:#f44336;font-weight:600;">No</span>
              <span style="color:var(--text);">${data.results.no} (${noPercent}%)</span>
            </div>
            <div style="background:#1a1a1a;border-radius:4px;height:8px;overflow:hidden;">
              <div style="background:linear-gradient(90deg,#f44336 0%,#c62828 100%);height:100%;width:${noPercent}%;transition:width 0.5s ease;"></div>
            </div>
          </div>

          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
              <span style="color:#9e9e9e;font-weight:600;">Abstain</span>
              <span style="color:var(--text);">${data.results.abstain} (${abstainPercent}%)</span>
            </div>
            <div style="background:#1a1a1a;border-radius:4px;height:8px;overflow:hidden;">
              <div style="background:linear-gradient(90deg,#9e9e9e 0%,#616161 100%);height:100%;width:${abstainPercent}%;transition:width 0.5s ease;"></div>
            </div>
          </div>
        </div>
      </div>
    `;

    showProposalResultsModal(htmlContent);
  } catch (error) {
    console.error('Error loading proposal results:', error);
    showToast('Failed to load proposal results: ' + error.message, 'error');
  }
}

// Update tab visibility based on membership status and subscription status
function updateTabVisibility() {
  if (!signedIn()) return;

  // Use database membership status, not JWT groups
  const isMember = (membershipStatus === 'approved');
  const hasSubscription = isSubscriber();
  const hasPaidSubscription = isPaidSubscriber();

  // Show subscription tab to members (but voting only to paid subscribers, vault to any subscriber)
  const subscriptionTab = document.querySelector('.tab[data-tab="subscription"]');
  const votingTab = document.querySelector('.tab[data-tab="voting"]');
  const deployVaultTab = document.querySelector('.tab[data-tab="deploy-vault"]');

  if (isMember) {
    // Show subscription tab to all members
    if (subscriptionTab) subscriptionTab.style.display = 'inline-block';

    // Show voting tab only to paid subscribers
    if (hasPaidSubscription) {
      if (votingTab) votingTab.style.display = 'inline-block';
    } else {
      if (votingTab) votingTab.style.display = 'none';
    }

    // Show vault tab to any active subscriber (free or paid)
    if (hasSubscription) {
      if (deployVaultTab) deployVaultTab.style.display = 'inline-block';
    } else {
      if (deployVaultTab) deployVaultTab.style.display = 'none';
    }
  } else {
    // Hide all tabs for non-members
    if (subscriptionTab) subscriptionTab.style.display = 'none';
    if (votingTab) votingTab.style.display = 'none';
    if (deployVaultTab) deployVaultTab.style.display = 'none';
  }
}

// ---- Getting Started Functions ----
async function isGettingStartedComplete() {
  if (!signedIn()) return false;
  try {
    const res = await fetch(API_URL + '/account/getting-started-preference', {
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + idToken() }
    });

    if (!res.ok) {
      console.error('Error fetching getting started preference:', res.status);
      return false;
    }

    const response = await res.json();
    return response.getting_started_complete || false;
  } catch (error) {
    console.error('Error fetching getting started preference:', error);
    return false; // Default to false on error
  }
}

async function markGettingStartedComplete() {
  if (!signedIn()) return;
  try {
    const res = await fetch(API_URL + '/account/getting-started-preference', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + idToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ getting_started_complete: true })
    });

    if (!res.ok) {
      console.error('Error marking getting started as complete:', res.status);
    }
  } catch (error) {
    console.error('Error marking getting started as complete:', error);
  }
}

async function clearGettingStartedComplete() {
  if (!signedIn()) return;
  try {
    const res = await fetch(API_URL + '/account/getting-started-preference', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + idToken(),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ getting_started_complete: false })
    });

    if (!res.ok) {
      console.error('Error clearing getting started preference:', res.status);
    }
  } catch (error) {
    console.error('Error clearing getting started preference:', error);
  }
}

function switchToTab(tabName, subTabName) {
  const tab = document.querySelector(`.tab[data-tab="${tabName}"]:not(.tab-child)`);
  const content = document.getElementById(tabName);
  const isParent = tab?.classList.contains('tab-parent');

  // Collapse all parent tabs first
  document.querySelectorAll('.tab-parent').forEach(p => p.classList.remove('expanded'));
  document.querySelectorAll('.tab-children').forEach(c => c.classList.remove('expanded'));
  document.querySelectorAll('.tab-child').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab:not(.tab-child)').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

  if (tab) tab.classList.add('active');
  if (content) content.classList.add('active');

  // If this is a parent tab, expand it and activate first child
  if (isParent && tab) {
    const parentId = tab.id;
    const childrenId = parentId.replace('Parent', 'Children');
    const children = document.getElementById(childrenId);

    tab.classList.add('expanded');
    children?.classList.add('expanded');

    // If a specific sub-tab is requested, use it; otherwise use first child
    const targetSubTab = subTabName || children?.querySelector('.tab-child')?.getAttribute('data-sub-tab');
    if (targetSubTab) {
      // Activate the specific child tab
      const childTab = children?.querySelector(`.tab-child[data-sub-tab="${targetSubTab}"]`);
      if (childTab) childTab.classList.add('active');
      activateSubTab(tabName, targetSubTab);
    }
  }

  // Load voting data if switching to voting tab
  if (tabName === 'voting' && signedIn()) {
    loadAllProposals();
    loadVotingHistory();
  }
}

function navigateToStep(tabName, cardId, subTabName) {
  // Switch to the tab
  switchToTab(tabName);

  // If there's a sub-tab specified, switch to it
  if (subTabName && subTabName !== 'null') {
    activateSubTab(tabName, subTabName);
    // Also update the child tab active state in the sidebar
    const childTab = document.querySelector(`.tab-child[data-tab="${tabName}"][data-sub-tab="${subTabName}"]`);
    if (childTab) {
      document.querySelectorAll('.tab-child').forEach(c => c.classList.remove('active'));
      childTab.classList.add('active');
    }
  }

  // If there's a specific card to focus on
  if (cardId && cardId !== 'null') {
    // Wait for tab switch to complete, then scroll to and highlight the card
    setTimeout(() => {
      const card = document.getElementById(cardId);
      if (card) {
        // Scroll to the card with some offset
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Add highlight effect
        const originalBorder = card.style.border;
        const originalBoxShadow = card.style.boxShadow;
        card.style.border = '2px solid var(--accent)';
        card.style.boxShadow = '0 0 20px rgba(255,193,37,0.6)';
        card.style.transition = 'all 0.3s ease';

        // Remove highlight after 2 seconds
        setTimeout(() => {
          card.style.border = originalBorder;
          card.style.boxShadow = originalBoxShadow;
        }, 2000);
      } else {
        console.error('Card not found:', cardId);
      }
    }, 300);
  }
}

async function checkStepCompletion() {
  const steps = {
    pinEnabled: false,
    isMember: false,
    membershipPending: false,
    hasSubscription: false,
    vaultDeployed: false, // Future feature
    hasVoted: false,
    backupsConfigured: false // Future feature
  };

  if (signedIn()) {
    const token = idToken();
    const { payload } = parseJwt(token);
    const groups = payload['cognito:groups'] || [];
    steps.isMember = groups.includes('member');

    // Check PIN status
    try {
      const pinRes = await fetch(API_URL + '/account/security/pin/status', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      // Handle 404 as "no PIN configured" (valid state for new users)
      if (pinRes.status === 404) {
        steps.pinEnabled = false;
      } else if (pinRes.ok) {
        const pinData = await pinRes.json();
        steps.pinEnabled = pinData.pin_enabled || false;
      }
    } catch (e) {
      console.error('Error checking PIN status:', e);
    }

    // Check membership status for pending state
    try {
      const membershipRes = await fetch(API_URL + '/account/membership/status', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (membershipRes.ok) {
        const membershipData = await membershipRes.json();
        steps.membershipPending = membershipData.membership_status === 'pending';
      }
    } catch (e) {
      console.error('Error checking membership status:', e);
    }

    // Check subscription status
    if (subscriptionStatus && subscriptionStatus.is_active) {
      steps.hasSubscription = true;
    }

    // Check if user has voted
    try {
      const votesRes = await fetch(API_URL + '/votes/history', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      // Handle 400/404 as "no votes yet" (valid state for new users)
      if (votesRes.status === 400 || votesRes.status === 404) {
        steps.hasVoted = false;
      } else if (votesRes.ok) {
        const votesData = await votesRes.json();
        steps.hasVoted = votesData.votes && votesData.votes.length > 0;
      }
    } catch (e) {
      console.error('Error checking voting history:', e);
    }
  }

  return steps;
}

async function populateGettingStartedSteps() {
  const steps = await checkStepCompletion();
  const { payload } = parseJwt(idToken());
  const groups = payload['cognito:groups'] || [];
  const isMember = groups.includes('member');
  const hasSubscription = subscriptionStatus && subscriptionStatus.is_active;
  const hasPaidSubscription = isPaidSubscriber();

  const stepsData = [
    {
      number: 1,
      title: 'Add a PIN Code',
      description: 'Add a PIN code to your account for better security.',
      completed: steps.pinEnabled,
      accessible: true,
      tab: 'account',
      subTab: 'pin-code',
      cardId: 'pinCodeCard',
      note: null
    },
    {
      number: 2,
      title: 'Become a VettID Member',
      description: 'Read and accept the VettID Membership Terms.',
      completed: steps.isMember,
      pending: steps.membershipPending,
      accessible: true,
      tab: 'account',
      subTab: 'membership',
      cardId: 'membershipCard',
      note: steps.membershipPending ? 'Membership Pending' : null
    },
    {
      number: 3,
      title: 'Subscribe',
      description: 'Select a free or paid subscription to gain access to voting rights and the VettID service.',
      completed: steps.hasSubscription,
      accessible: isMember,
      tab: 'subscription',
      cardId: null,
      note: isMember ? null : 'Complete step 2 to unlock'
    },
    {
      number: 4,
      title: 'Deploy Your Vault',
      description: 'Deploy a secure Vault under your complete control and connect it to the VettID app on your phone.',
      completed: steps.vaultDeployed,
      accessible: hasSubscription,
      tab: 'deploy-vault',
      cardId: null,
      note: hasSubscription ? 'Coming soon' : 'Complete step 3 to unlock'
    },
    {
      number: 5,
      title: 'Vote on Proposals',
      description: 'Review open proposals related to the operation of VettID and cast your vote as a paying member.',
      completed: steps.hasVoted,
      accessible: hasPaidSubscription,
      tab: 'voting',
      cardId: null,
      note: hasPaidSubscription ? null : 'Upgrade to a paid subscription to unlock'
    },
    {
      number: 6,
      title: 'Configure Data Backups',
      description: 'Have VettID securely store encrypted backups of your critical data.',
      completed: steps.backupsConfigured,
      accessible: hasSubscription,
      tab: 'deploy-vault',
      cardId: null,
      note: hasSubscription ? 'Coming soon' : 'Complete step 3 to unlock'
    }
  ];

  const container = document.getElementById('gettingStartedSteps');
  container.innerHTML = stepsData.map(step => {
    const isAccessible = step.accessible;
    const isCompleted = step.completed;
    const isPending = step.pending || false;
    const opacity = isAccessible ? '1' : '0.5';
    const cursor = isAccessible && !isCompleted && !isPending ? 'pointer' : 'default';
    const borderColor = isCompleted ? '#4caf50' : isPending ? '#ff9800' : isAccessible ? 'var(--accent)' : '#333';
    const iconBg = isCompleted ? '#4caf50' : isPending ? '#ff9800' : isAccessible ? 'var(--accent)' : '#333';

    return `
      <div ${isAccessible && !isCompleted && !isPending && step.tab ? `onclick="navigateToStep('${step.tab}','${step.cardId || 'null'}','${step.subTab || 'null'}')"` : ''} style="padding:20px;background:#0a0a0a;border-radius:8px;border:2px solid ${borderColor};opacity:${opacity};cursor:${cursor};position:relative;">
        <div style="display:flex;align-items:start;gap:16px;">
          <div style="flex-shrink:0;width:40px;height:40px;border-radius:50%;background:${iconBg};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.2rem;color:${isCompleted || isPending || isAccessible ? '#000' : '#666'};">
            ${isCompleted ? 'âœ“' : step.number}
          </div>
          <div style="flex:1;">
            <h4 style="margin:0 0 8px 0;color:${isAccessible ? 'var(--text)' : '#666'};">${step.title}</h4>
            <p style="margin:0 0 8px 0;color:${isAccessible ? 'var(--gray)' : '#555'};font-size:0.95rem;">${step.description}</p>
            ${step.note ? `<p style="margin:0;color:#fbbf24;font-size:0.85rem;font-weight:600;">${step.note}</p>` : ''}
          </div>
          ${isCompleted ? `<div style="position:absolute;top:16px;right:16px;padding:4px 12px;background:#4caf50;color:#000;border-radius:12px;font-size:0.75rem;font-weight:700;">COMPLETE</div>` : ''}
          ${isPending && !isCompleted ? `<div style="position:absolute;top:16px;right:16px;padding:4px 12px;background:#ff9800;color:#000;border-radius:12px;font-size:0.75rem;font-weight:700;">PENDING</div>` : ''}
        </div>
      </div>
    `;
  }).join('');

  // Update progress bar
  const completedCount = stepsData.filter(s => s.completed).length;
  const totalCount = stepsData.length;
  const progressPercent = Math.round((completedCount / totalCount) * 100);

  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  if (progressBar) progressBar.style.width = progressPercent + '%';
  if (progressText) progressText.textContent = `${completedCount} of ${totalCount} complete`;
}

document.getElementById('gotItBtn').onclick = async () => {
  await markGettingStartedComplete();
  switchToTab('account');
};

// Initialize
if (checkAuth()) {
  // Define the main app initialization function
  const runAppInitialization = async () => {
    // Debug: Log JWT payload to console
    const token = idToken();
    if (token) {
      const { payload } = parseJwt(token);
      console.log('[AUTH] JWT Payload:', payload);
      console.log('[AUTH] Groups type:', typeof payload['cognito:groups']);
      console.log('[AUTH] Groups value:', payload['cognito:groups']);
      console.log('[AUTH] Groups JSON:', JSON.stringify(payload['cognito:groups']));
    }
    populateProfile();

    // Load subscription status first so isPaidSubscriber() works correctly in loadMembershipStatus()
    await loadSubscriptionStatus();

    await Promise.all([
      loadMembershipStatus(),
      loadSubscriptionTypes(),
      loadPinStatus(),
      loadEmailPreferences()
    ]);

    updateTabVisibility();
    populateGettingStartedSteps();

    // Show Getting Started tab unless user has clicked "Got it" button
    // This is independent of membership status - getting started has multiple steps
    const complete = await isGettingStartedComplete();
    if (complete) {
      switchToTab('account');
    } else {
      switchToTab('getting-started');
    }
  };

  // Store the continuation function for use after PIN verification
  continueAppInitialization = runAppInitialization;

  // Check if PIN verification is required before loading the app
  (async () => {
    const pinRequired = await checkAndRequirePinVerification();
    if (!pinRequired) {
      // No PIN verification needed, proceed with app initialization
      await runAppInitialization();
    }
    // If PIN is required, the modal is shown and runAppInitialization will be called
    // after successful PIN verification via continueAppInitialization()
  })();
}

// Sidebar toggle
document.getElementById('sidebarToggle').onclick=()=>{
  const sidebar=document.getElementById('sidebar');
  const toggle=document.getElementById('sidebarToggle');
  sidebar.classList.toggle('collapsed');
  toggle.innerHTML=sidebar.classList.contains('collapsed')?'&gt;':'&lt;';
};
</script>
</body>
</html>
